<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المخزون - نظام إدارة المزرعة</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(45, 80, 22, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #4a7c2a;
            color: white;
        }

        .btn-primary:hover {
            background: #2d5016;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 124, 42, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-sm {
            padding: 5px 12px;
            font-size: 12px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-card-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .stat-card-title {
            font-size: 14px;
            color: #6c757d;
            font-weight: 600;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #2d5016;
        }

        .stat-card-subtitle {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Filters */
        .filters {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .filters-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #2d5016;
            font-size: 14px;
        }

        .form-control {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4a7c2a;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h3 {
            color: #2d5016;
            font-size: 20px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%);
            color: white;
        }

        thead th {
            padding: 15px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.3s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody td {
            padding: 15px;
            font-size: 14px;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-low {
            background: #fff3cd;
            color: #856404;
        }

        .badge-ok {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-category {
            background: #e7f3ff;
            color: #0066cc;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h2 {
            color: #2d5016;
            font-size: 22px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s;
            line-height: 1;
        }

        .close-btn:hover {
            color: #dc3545;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }

        .required::after {
            content: " *";
            color: #dc3545;
        }

        /* Alert */
        .alert {
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            animation: slideDown 0.3s;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #f0f0f0;
            border-top: 6px solid #4a7c2a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Movements Section */
        .movements-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 20px;
            margin-top: 30px;
        }

        .movements-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .movements-header h3 {
            color: #2d5016;
            font-size: 20px;
        }

        .movement-type-in {
            background: #d4edda;
            color: #155724;
        }

        .movement-type-out {
            background: #f8d7da;
            color: #721c24;
        }

        .movement-type-adjustment {
            background: #fff3cd;
            color: #856404;
        }

        .movement-type-project {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h4 {
            margin-bottom: 10px;
            color: #495057;
        }

        /* Low Stock Warning */
        .low-stock-row {
            background: #fff3cd !important;
        }

        .low-stock-row:hover {
            background: #ffe69c !important;
        }

        /* Action Buttons Container */
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .filters-row {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 20px;
            }

            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                flex-direction: column;
            }

            table {
                font-size: 12px;
            }

            thead th, tbody td {
                padding: 10px 5px;
            }

            .stat-card-value {
                font-size: 24px;
            }

            .modal-content {
                padding: 20px;
            }
        }

        /* Info Box */
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #0066cc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            margin: 5px 0;
            font-size: 14px;
            color: #004085;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="authLoading" class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #2d5016; font-weight: 600;">جاري تحميل البيانات...</p>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>📦 إدارة المخزون</h1>
                    <p style="margin-top: 8px; opacity: 0.9;">إدارة شاملة لمواد ومستلزمات المزرعة</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openAddItemModal()">
                        ➕ إضافة مادة جديدة
                    </button>
                    <button class="btn btn-warning" onclick="exportToCSV()">
                        📥 تصدير Excel
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.reload()">
                        🔄 تحديث
                    </button>
                    <button class="btn btn-secondary" onclick="goBack()">
                        ↩️ رجوع للرئيسية
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-title">إجمالي المواد</div>
                        <div class="stat-card-value" id="totalItems">0</div>
                        <div class="stat-card-subtitle">صنف في المخزون</div>
                    </div>
                    <div class="stat-card-icon" style="background: #e3f2fd; color: #1976d2;">📦</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-title">مواد منخفضة</div>
                        <div class="stat-card-value" id="lowStockItems" style="color: #dc3545;">0</div>
                        <div class="stat-card-subtitle">تحتاج إعادة تموين</div>
                    </div>
                    <div class="stat-card-icon" style="background: #ffebee; color: #c62828;">⚠️</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-title">قيمة المخزون</div>
                        <div class="stat-card-value" id="totalValue" style="font-size: 22px;">0 د.ج</div>
                        <div class="stat-card-subtitle">القيمة الإجمالية</div>
                    </div>
                    <div class="stat-card-icon" style="background: #f3e5f5; color: #7b1fa2;">💰</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-title">عدد الفئات</div>
                        <div class="stat-card-value" id="totalCategories">0</div>
                        <div class="stat-card-subtitle">فئة مختلفة</div>
                    </div>
                    <div class="stat-card-icon" style="background: #fff3e0; color: #f57c00;">📋</div>
                </div>
            </div>
        </div>

        <!-- Low Stock Alert -->
        <div id="lowStockAlert" class="alert alert-warning" style="display: none;">
            <strong>⚠️ تنبيه:</strong> <span id="lowStockMessage"></span>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filters-row">
                <div class="form-group">
                    <label>🔍 البحث</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="ابحث بالاسم، الفئة، أو المورد...">
                </div>
                <div class="form-group">
                    <label>📂 الفئة</label>
                    <select class="form-control" id="categoryFilter">
                        <option value="">جميع الفئات</option>
                        <option value="أعلاف">🌾 أعلاف</option>
                        <option value="بذور">🌱 بذور</option>
                        <option value="أسمدة">💊 أسمدة</option>
                        <option value="مبيدات">🧪 مبيدات</option>
                        <option value="أدوية">💉 أدوية بيطرية</option>
                        <option value="معدات">🔧 معدات وأدوات</option>
                        <option value="وقود">⛽ وقود ومحروقات</option>
                        <option value="أخرى">📌 أخرى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>📊 الحالة</label>
                    <select class="form-control" id="statusFilter">
                        <option value="">جميع الحالات</option>
                        <option value="low">⚠️ منخفض</option>
                        <option value="ok">✅ كافٍ</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Inventory Table -->
        <div class="table-container">
            <div class="table-header">
                <h3>📋 جدول المواد</h3>
                <span id="itemCount" style="color: #6c757d; font-size: 14px;">0 مادة</span>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>اسم المادة</th>
                            <th>الفئة</th>
                            <th>الكمية</th>
                            <th>الوحدة</th>
                            <th>الحد الأدنى</th>
                            <th>سعر الوحدة</th>
                            <th>القيمة الإجمالية</th>
                            <th>المورد</th>
                            <th>الصلاحية</th>
                            <th>آخر تحديث</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <tr>
                            <td colspan="11" class="empty-state">
                                <div class="empty-state-icon">📦</div>
                                <h4>لا توجد مواد في المخزون</h4>
                                <p>ابدأ بإضافة مواد جديدة إلى مخزونك</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Movements Section -->
        <div class="movements-section">
            <div class="movements-header">
                <h3>📋 سجل الحركات الأخيرة</h3>
                <span id="movementCount" style="color: #6c757d; font-size: 14px;">آخر 50 حركة</span>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ والوقت</th>
                            <th>المادة</th>
                            <th>نوع الحركة</th>
                            <th>الكمية</th>
                            <th>الوحدة</th>
                            <th>المشروع</th>
                            <th>المسؤول</th>
                            <th>السبب</th>
                            <th>التكلفة</th>
                        </tr>
                    </thead>
                    <tbody id="movementsTableBody">
                        <tr>
                            <td colspan="9" class="empty-state">
                                <div class="empty-state-icon">📋</div>
                                <h4>لا توجد حركات مسجلة</h4>
                                <p>سيتم عرض حركات المخزون هنا</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="itemModalTitle">➕ إضافة مادة جديدة</h2>
                <button class="close-btn" onclick="closeItemModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="itemAlert" class="alert"></div>
                <form id="itemForm">
                    <input type="hidden" id="itemId">
                    
                    <div class="info-box">
                        <p><strong>📝 تعليمات:</strong></p>
                        <p>• الحقول المطلوبة مميزة بعلامة (*)</p>
                        <p>• القيمة الإجمالية = الكمية × سعر الوحدة</p>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">اسم المادة</label>
                            <input type="text" class="form-control" id="itemName" required placeholder="مثال: علف شعير">
                        </div>
                        <div class="form-group">
                            <label class="required">الفئة</label>
                            <select class="form-control" id="itemCategory" required>
                                <option value="">اختر الفئة</option>
                                <option value="أعلاف">🌾 أعلاف</option>
                                <option value="بذور">🌱 بذور</option>
                                <option value="أسمدة">💊 أسمدة</option>
                                <option value="مبيدات">🧪 مبيدات</option>
                                <option value="أدوية">💉 أدوية بيطرية</option>
                                <option value="معدات">🔧 معدات وأدوات</option>
                                <option value="وقود">⛽ وقود ومحروقات</option>
                                <option value="أخرى">📌 أخرى</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">الكمية الحالية</label>
                            <input type="number" step="0.01" class="form-control" id="itemQuantity" required placeholder="0">
                        </div>
                        <div class="form-group">
                            <label class="required">الوحدة</label>
                            <select class="form-control" id="itemUnit" required>
                                <option value="">اختر الوحدة</option>
                                <option value="كجم">كجم (كيلوجرام)</option>
                                <option value="قنطار">قنطار</option>
                                <option value="طن">طن</option>
                                <option value="بالة">بالة</option>
                                <option value="لتر">لتر</option>
                                <option value="كيس">كيس</option>
                                <option value="عبوة">عبوة</option>
                                <option value="قطعة">قطعة</option>
                                <option value="صندوق">صندوق</option>
                                <option value="علبة">علبة</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>الحد الأدنى للتنبيه</label>
                            <input type="number" step="0.01" class="form-control" id="itemMinThreshold" placeholder="0">
                            <small style="color: #6c757d;">سيتم التنبيه عند انخفاض الكمية</small>
                        </div>
                        <div class="form-group">
                            <label>سعر الوحدة (د.ج)</label>
                            <input type="number" step="0.01" class="form-control" id="itemUnitPrice" placeholder="0.00">
                        </div>
                    </div>

                    <div class="form-group form-group-full">
                        <label>المورد</label>
                        <input type="text" class="form-control" id="itemSupplier" placeholder="اسم المورد">
                    </div>

                    <div class="form-group form-group-full">
                        <label>تاريخ انتهاء الصلاحية</label>
                        <input type="date" class="form-control" id="itemExpiryDate">
                    </div>

                    <div class="form-group form-group-full">
                        <label>ملاحظات إضافية</label>
                        <textarea class="form-control" id="itemNotes" rows="3" placeholder="أي ملاحظات إضافية عن المادة..."></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">💾 حفظ المادة</button>
                        <button type="button" class="btn btn-secondary" onclick="closeItemModal()">❌ إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Movement Modal -->
    <div id="movementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📝 إضافة حركة مخزون</h2>
                <button class="close-btn" onclick="closeMovementModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="movementAlert" class="alert"></div>
                <form id="movementForm">
                    <input type="hidden" id="movementInventoryId">
                    <input type="hidden" id="movementInventoryName">

                    <div class="info-box">
                        <p><strong>📝 أنواع الحركات:</strong></p>
                        <p>• <strong>إدخال:</strong> إضافة كمية للمخزون (شراء جديد)</p>
                        <p>• <strong>إخراج:</strong> إنقاص كمية من المخزون (بيع أو استهلاك)</p>
                        <p>• <strong>تعديل:</strong> تصحيح الكمية (جرد)</p>
                        <p>• <strong>استخدام في مشروع:</strong> استخدام في مشروع معين</p>
                    </div>

                    <div class="form-group">
                        <label>المادة</label>
                        <input type="text" class="form-control" id="movementItemDisplay" readonly style="background: #f8f9fa;">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">نوع الحركة</label>
                            <select class="form-control" id="movementType" required>
                                <option value="">اختر النوع</option>
                                <option value="in">➕ إدخال (شراء/إضافة)</option>
                                <option value="out">➖ إخراج (بيع/استهلاك)</option>
                                <option value="adjustment">🔄 تعديل (تصحيح)</option>
                                <option value="project_usage">🏗️ استخدام في مشروع</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="required">الكمية</label>
                            <input type="number" step="0.01" class="form-control" id="movementQuantity" required placeholder="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>السبب</label>
                            <input type="text" class="form-control" id="movementReason" placeholder="مثال: شراء جديد، استهلاك يومي...">
                        </div>
                        <div class="form-group">
                            <label>المسؤول عن الحركة</label>
                            <input type="text" class="form-control" id="movementPerformedBy" placeholder="اسم المسؤول">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>المشروع المرتبط</label>
                            <select class="form-control" id="movementProject">
                                <option value="">بدون مشروع</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>سعر الوحدة (د.ج)</label>
                            <input type="number" step="0.01" class="form-control" id="movementUnitPrice" placeholder="0.00">
                            <small style="color: #6c757d;">للمشتريات فقط</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>الرقم المرجعي</label>
                        <input type="text" class="form-control" id="movementReference" placeholder="رقم الفاتورة أو المرجع">
                    </div>

                    <div class="form-group">
                        <label>ملاحظات</label>
                        <textarea class="form-control" id="movementNotes" rows="2" placeholder="أي ملاحظات إضافية..."></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-success" style="flex: 1;">💾 حفظ الحركة</button>
                        <button type="button" class="btn btn-secondary" onclick="closeMovementModal()">❌ إلغاء</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sstvsknmmhbwubzajeix.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdHZza25tbWhid3ViemFqZWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDM0NjIsImV4cCI6MjA3NDkxOTQ2Mn0.EeVUU9DxRYUi38nUHgWEsnG8li7KZjqAGPNW9IDokhg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let inventoryData = [];
        let movementsData = [];
        let projectsData = [];
        let editingItemId = null;

        // ============================================
        // Initialize
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Starting application...');
            if (await checkAuth()) {
                console.log('✅ Authentication successful');
                await loadAllData();
                setupEventListeners();
                document.getElementById('authLoading').classList.add('hidden');
            }
        });

        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error || !session) {
                    console.error('❌ No valid session');
                    window.location.href = '../login.html';
                    return false;
                }

                currentUser = session.user;
                console.log('👤 Current user:', currentUser.email);
                return true;
            } catch (error) {
                console.error('❌ Auth check error:', error);
                window.location.href = '../login.html';
                return false;
            }
        }

        async function loadAllData() {
            console.log('📥 Loading all data...');
            try {
                await Promise.all([
                    loadInventory(),
                    loadMovements(),
                    loadProjects()
                ]);
                console.log('✅ All data loaded successfully');
            } catch (error) {
                console.error('❌ Error loading data:', error);
                showAlert('حدث خطأ في تحميل البيانات', 'error');
            }
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', () => {
                console.log('🔍 Searching...');
                renderInventoryTable();
            });
            document.getElementById('categoryFilter').addEventListener('change', () => {
                console.log('📂 Filtering by category...');
                renderInventoryTable();
            });
            document.getElementById('statusFilter').addEventListener('change', () => {
                console.log('📊 Filtering by status...');
                renderInventoryTable();
            });
            
            document.getElementById('itemForm').addEventListener('submit', handleItemSubmit);
            document.getElementById('movementForm').addEventListener('submit', handleMovementSubmit);
            
            console.log('✅ Event listeners setup complete');
        }

        // ============================================
        // Load Data
        // ============================================
        async function loadInventory() {
            try {
                console.log('📦 Loading inventory...');
                const { data, error } = await supabase
                    .from('inventory')
                    .select('*')
                    .order('item_name');

                if (error) {
                    console.error('❌ Error loading inventory:', error);
                    throw error;
                }

                inventoryData = data || [];
                console.log(`✅ Loaded ${inventoryData.length} inventory items`);
                
                updateStats();
                renderInventoryTable();
                checkLowStock();
            } catch (error) {
                console.error('❌ Error in loadInventory:', error);
                showAlert('حدث خطأ في تحميل المخزون: ' + error.message, 'error');
            }
        }

        async function loadMovements() {
            try {
                console.log('📋 Loading movements...');
                const { data, error } = await supabase
                    .from('inventory_movements')
                    .select(`
                        *,
                        inventory (item_name),
                        projects (name)
                    `)
                    .order('performed_at', { ascending: false })
                    .limit(50);

                if (error) {
                    console.error('❌ Error loading movements:', error);
                    throw error;
                }

                movementsData = data || [];
                console.log(`✅ Loaded ${movementsData.length} movements`);
                renderMovementsTable();
            } catch (error) {
                console.error('❌ Error in loadMovements:', error);
            }
        }

        async function loadProjects() {
            try {
                console.log('🏗️ Loading projects...');
                const { data, error } = await supabase
                    .from('projects')
                    .select('id, name, status')
                    .eq('status', 'active')
                    .order('name');

                if (error) {
                    console.error('❌ Error loading projects:', error);
                    throw error;
                }

                projectsData = data || [];
                console.log(`✅ Loaded ${projectsData.length} active projects`);
                
                const select = document.getElementById('movementProject');
                select.innerHTML = '<option value="">بدون مشروع</option>';
                projectsData.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('❌ Error in loadProjects:', error);
            }
        }

        // ============================================
        // Update Stats
        // ============================================
        function updateStats() {
            const totalItems = inventoryData.length;
            const lowStockItems = inventoryData.filter(item => 
                item.min_threshold && item.quantity < item.min_threshold
            ).length;
            
            const totalValue = inventoryData.reduce((sum, item) => {
                const value = (item.quantity || 0) * (item.unit_price || 0);
                return sum + value;
            }, 0);

            const categories = new Set(inventoryData.map(item => item.category).filter(c => c));

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('lowStockItems').textContent = lowStockItems;
            document.getElementById('totalValue').textContent = formatCurrency(totalValue);
            document.getElementById('totalCategories').textContent = categories.size;

            console.log(`📊 Stats updated: ${totalItems} items, ${lowStockItems} low stock, ${formatCurrency(totalValue)} total value`);
        }

        function checkLowStock() {
            const lowStockItems = inventoryData.filter(item => 
                item.min_threshold && item.quantity < item.min_threshold
            );

            const alertBox = document.getElementById('lowStockAlert');
            const messageBox = document.getElementById('lowStockMessage');

            if (lowStockItems.length > 0) {
                const itemNames = lowStockItems.map(item => item.item_name).join('، ');
                messageBox.textContent = `هناك ${lowStockItems.length} مادة تحتاج إعادة تموين: ${itemNames}`;
                alertBox.style.display = 'block';
            } else {
                alertBox.style.display = 'none';
            }
        }

        // ============================================
        // Render Tables
        // ============================================
        function renderInventoryTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = inventoryData.filter(item => {
                const matchesSearch = 
                    item.item_name.toLowerCase().includes(searchTerm) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                    (item.supplier && item.supplier.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                
                let matchesStatus = true;
                if (statusFilter === 'low') {
                    matchesStatus = item.min_threshold && item.quantity < item.min_threshold;
                } else if (statusFilter === 'ok') {
                    matchesStatus = !item.min_threshold || item.quantity >= item.min_threshold;
                }

                return matchesSearch && matchesCategory && matchesStatus;
            });

            console.log(`🔍 Filtered ${filtered.length} items from ${inventoryData.length} total`);

            const tbody = document.getElementById('inventoryTableBody');
            document.getElementById('itemCount').textContent = `${filtered.length} مادة`;
            
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" class="empty-state">
                            <div class="empty-state-icon">📦</div>
                            <h4>لا توجد مواد تطابق البحث</h4>
                            <p>جرب تغيير معايير البحث أو الفلترة</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(item => {
                const isLow = item.min_threshold && item.quantity < item.min_threshold;
                const totalValue = (item.quantity || 0) * (item.unit_price || 0);
                
                return `
                    <tr class="${isLow ? 'low-stock-row' : ''}">
                        <td>
                            ${isLow ? '<strong style="color: #dc3545;">⚠️ </strong>' : ''}
                            <strong>${item.item_name}</strong>
                        </td>
                        <td><span class="badge badge-category">${item.category || '-'}</span></td>
                        <td><strong style="font-size: 16px;">${item.quantity || 0}</strong></td>
                        <td>${item.unit || '-'}</td>
                        <td>
                            ${item.min_threshold ? 
                                `<span class="${isLow ? 'badge badge-danger' : 'badge badge-ok'}">${item.min_threshold}</span>` 
                                : '-'}
                        </td>
                        <td>${formatCurrency(item.unit_price)}</td>
                        <td><strong>${formatCurrency(totalValue)}</strong></td>
                        <td>${item.supplier || '-'}</td>
                        <td style="font-size: 12px;">${item.expiry_date ? formatDate(item.expiry_date) : '-'}</td>
                        <td style="font-size: 12px; color: #6c757d;">${formatDate(item.updated_at)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="editItem('${item.id}')" title="تعديل">
                                    ✏️
                                </button>
                                <button class="btn btn-success btn-sm" onclick="openMovementModal('${item.id}', '${item.item_name.replace(/'/g, "\\'")}')" title="إضافة حركة">
                                    📝
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteItem('${item.id}', '${item.item_name.replace(/'/g, "\\'")}')">
                                    🗑️
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderMovementsTable() {
            const tbody = document.getElementById('movementsTableBody');
            document.getElementById('movementCount').textContent = `${movementsData.length} حركة`;
            
            if (movementsData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <h4>لا توجد حركات مسجلة</h4>
                            <p>سيتم عرض حركات المخزون هنا عند إضافتها</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = movementsData.map(movement => {
                const typeLabels = {
                    'in': '➕ إدخال',
                    'out': '➖ إخراج',
                    'adjustment': '🔄 تعديل',
                    'project_usage': '🏗️ استخدام مشروع'
                };

                const typeClasses = {
                    'in': 'movement-type-in',
                    'out': 'movement-type-out',
                    'adjustment': 'movement-type-adjustment',
                    'project_usage': 'movement-type-project'
                };

                const totalCost = movement.total_cost || 
                    ((movement.unit_price && movement.quantity) ? movement.unit_price * movement.quantity : null);

                return `
                    <tr>
                        <td style="font-size: 12px;">${formatDateTime(movement.performed_at)}</td>
                        <td><strong>${movement.inventory?.item_name || '-'}</strong></td>
                        <td>
                            <span class="badge ${typeClasses[movement.movement_type]}">
                                ${typeLabels[movement.movement_type] || movement.movement_type}
                            </span>
                        </td>
                        <td><strong>${movement.quantity}</strong></td>
                        <td>${movement.unit}</td>
                        <td>${movement.projects?.name || '-'}</td>
                        <td>${movement.performed_by || '-'}</td>
                        <td>${movement.reason || '-'}</td>
                        <td>${totalCost ? formatCurrency(totalCost) : '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // Item CRUD
        // ============================================
        function openAddItemModal() {
            console.log('➕ Opening add item modal');
            editingItemId = null;
            document.getElementById('itemModalTitle').textContent = '➕ إضافة مادة جديدة';
            document.getElementById('itemForm').reset();
            document.getElementById('itemId').value = '';
            document.getElementById('itemModal').classList.add('active');
        }

        async function editItem(id) {
            console.log(`✏️ Editing item: ${id}`);
            const item = inventoryData.find(i => i.id === id);
            if (!item) {
                console.error('❌ Item not found');
                return;
            }

            editingItemId = id;
            document.getElementById('itemModalTitle').textContent = '✏️ تعديل المادة';
            document.getElementById('itemId').value = item.id;
            document.getElementById('itemName').value = item.item_name;
            document.getElementById('itemCategory').value = item.category || '';
            document.getElementById('itemQuantity').value = item.quantity || '';
            document.getElementById('itemUnit').value = item.unit || '';
            document.getElementById('itemMinThreshold').value = item.min_threshold || '';
            document.getElementById('itemUnitPrice').value = item.unit_price || '';
            document.getElementById('itemSupplier').value = item.supplier || '';
            document.getElementById('itemExpiryDate').value = item.expiry_date || '';
            document.getElementById('itemNotes').value = item.notes || '';
            
            document.getElementById('itemModal').classList.add('active');
        }

        async function handleItemSubmit(e) {
            e.preventDefault();
            console.log('💾 Saving item...');

            if (!currentUser) {
                showAlertInModal('itemAlert', 'خطأ: لم يتم العثور على بيانات المستخدم', 'error');
                return;
            }

            const itemData = {
                user_id: currentUser.id,
                item_name: document.getElementById('itemName').value.trim(),
                category: document.getElementById('itemCategory').value,
                quantity: parseFloat(document.getElementById('itemQuantity').value) || 0,
                unit: document.getElementById('itemUnit').value,
                min_threshold: parseFloat(document.getElementById('itemMinThreshold').value) || null,
                unit_price: parseFloat(document.getElementById('itemUnitPrice').value) || null,
                supplier: document.getElementById('itemSupplier').value.trim() || null,
                expiry_date: document.getElementById('itemExpiryDate').value || null,
                notes: document.getElementById('itemNotes').value.trim() || null
            };

            console.log('📝 Item data:', itemData);

            try {
                if (editingItemId) {
                    console.log(`🔄 Updating item: ${editingItemId}`);
                    // عند التعديل، لا نرسل user_id
                    const { user_id, ...updateData } = itemData;
                    const { error } = await supabase
                        .from('inventory')
                        .update(updateData)
                        .eq('id', editingItemId);

                    if (error) throw error;
                    console.log('✅ Item updated successfully');
                    showAlert('تم تحديث المادة بنجاح ✅', 'success');
                } else {
                    console.log('➕ Creating new item');
                    const { error } = await supabase
                        .from('inventory')
                        .insert([itemData]);

                    if (error) throw error;
                    console.log('✅ Item created successfully');
                    showAlert('تم إضافة المادة بنجاح ✅', 'success');
                }

                closeItemModal();
                await loadInventory();
            } catch (error) {
                console.error('❌ Error saving item:', error);
                showAlertInModal('itemAlert', 'حدث خطأ: ' + error.message, 'error');
            }
        }

        async function deleteItem(id, name) {
            if (!confirm(`⚠️ هل أنت متأكد من حذف "${name}"؟\n\nسيتم حذف جميع الحركات المرتبطة بها.`)) {
                return;
            }

            console.log(`🗑️ Deleting item: ${id}`);

            try {
                const { error } = await supabase
                    .from('inventory')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                console.log('✅ Item deleted successfully');
                showAlert('تم حذف المادة بنجاح ✅', 'success');
                await loadInventory();
                await loadMovements();
            } catch (error) {
                console.error('❌ Error deleting item:', error);
                showAlert('حدث خطأ في الحذف: ' + error.message, 'error');
            }
        }

        function closeItemModal() {
            document.getElementById('itemModal').classList.remove('active');
            document.getElementById('itemForm').reset();
            editingItemId = null;
        }

        // ============================================
        // Movement CRUD
        // ============================================
        function openMovementModal(inventoryId, itemName) {
            console.log(`📝 Opening movement modal for: ${itemName}`);
            document.getElementById('movementInventoryId').value = inventoryId;
            document.getElementById('movementInventoryName').value = itemName;
            document.getElementById('movementItemDisplay').value = itemName;
            document.getElementById('movementForm').reset();
            document.getElementById('movementItemDisplay').value = itemName;
            document.getElementById('movementModal').classList.add('active');
        }

        async function handleMovementSubmit(e) {
            e.preventDefault();
            console.log('💾 Saving movement...');

            if (!currentUser) {
                showAlertInModal('movementAlert', 'خطأ: لم يتم العثور على بيانات المستخدم', 'error');
                return;
            }

            const inventoryId = document.getElementById('movementInventoryId').value;
            const item = inventoryData.find(i => i.id === inventoryId);
            
            if (!item) {
                showAlertInModal('movementAlert', 'خطأ: لم يتم العثور على المادة', 'error');
                return;
            }

            const movementData = {
                user_id: currentUser.id,
                inventory_id: inventoryId,
                movement_type: document.getElementById('movementType').value,
                quantity: parseFloat(document.getElementById('movementQuantity').value),
                unit: item.unit,
                project_id: document.getElementById('movementProject').value || null,
                reason: document.getElementById('movementReason').value.trim() || null,
                performed_by: document.getElementById('movementPerformedBy').value.trim() || null,
                unit_price: parseFloat(document.getElementById('movementUnitPrice').value) || null,
                reference_number: document.getElementById('movementReference').value.trim() || null,
                notes: document.getElementById('movementNotes').value.trim() || null
            };

            if (movementData.unit_price) {
                movementData.total_cost = movementData.quantity * movementData.unit_price;
            }

            console.log('📝 Movement data:', movementData);

            try {
                const { error } = await supabase
                    .from('inventory_movements')
                    .insert([movementData]);

                if (error) throw error;

                console.log('✅ Movement saved successfully');
                showAlert('تم تسجيل الحركة بنجاح ✅', 'success');
                closeMovementModal();
                await Promise.all([loadInventory(), loadMovements()]);
            } catch (error) {
                console.error('❌ Error saving movement:', error);
                showAlertInModal('movementAlert', 'حدث خطأ: ' + error.message, 'error');
            }
        }

        function closeMovementModal() {
            document.getElementById('movementModal').classList.remove('active');
            document.getElementById('movementForm').reset();
        }

        // ============================================
        // Export
        // ============================================
        function exportToCSV() {
            console.log('📥 Exporting to CSV...');
            
            const headers = ['اسم المادة', 'الفئة', 'الكمية', 'الوحدة', 'الحد الأدنى', 'سعر الوحدة', 'القيمة الإجمالية', 'المورد', 'تاريخ الانتهاء', 'ملاحظات'];
            const rows = inventoryData.map(item => [
                item.item_name,
                item.category || '',
                item.quantity || 0,
                item.unit || '',
                item.min_threshold || '',
                item.unit_price || 0,
                (item.quantity || 0) * (item.unit_price || 0),
                item.supplier || '',
                item.expiry_date || '',
                item.notes || ''
            ]);

            let csv = headers.join(',') + '\n';
            csv += rows.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const filename = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            console.log(`✅ Exported ${inventoryData.length} items to ${filename}`);
            showAlert('تم تصدير البيانات بنجاح ✅', 'success');
        }

        // ============================================
        // Helper Functions
        // ============================================
        function formatCurrency(amount) {
            if (!amount || amount === 0) return '0 د.ج';
            return parseFloat(amount).toLocaleString('ar-DZ', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }) + ' د.ج';
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-DZ', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                });
            } catch (e) {
                return '-';
            }
        }

        function formatDateTime(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('ar-DZ', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return '-';
            }
        }

        function showAlert(message, type) {
            console.log(`🔔 Alert (${type}): ${message}`);
            
            // Create a temporary alert at the top of the page
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} show`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.textAlign = 'center';
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }

        function showAlertInModal(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function goBack() {
            window.location.href = '../index.html';
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        console.log('✅ Script loaded successfully');
    </script>
</body>
</html>