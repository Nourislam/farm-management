<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الإعدادات - نظام إدارة المزرعة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        /* Loading Screen */
        #authLoading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #authLoading.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4a7c2a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        /* Main Content */
        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .settings-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #ecf0f1;
            background: #f8f9fa;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: #7f8c8d;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: rgba(74, 124, 42, 0.05);
            color: #4a7c2a;
        }

        .tab-btn.active {
            color: #4a7c2a;
            border-bottom-color: #4a7c2a;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.3rem;
            color: #2d5016;
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4a7c2a;
        }

        .form-group input:disabled {
            background: #f8f9fa;
            cursor: not-allowed;
        }

        .form-group .helper-text {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 0.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        /* Checkbox */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.8rem;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .checkbox-item:hover {
            background: #e8f5e8;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
        }

        /* Radio */
        .radio-group {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.5rem;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .radio-item input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-item label {
            cursor: pointer;
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(45, 80, 22, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #ecf0f1;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: none;
            animation: slideDown 0.3s;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #2d5016;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #2c3e50;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            .tabs {
                overflow-x: auto;
            }

            .tab-content {
                padding: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .radio-group {
                flex-direction: column;
                gap: 0.8rem;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="authLoading">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: #7f8c8d;">جاري التحميل...</p>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-right">
            <button class="back-btn" onclick="goBack()">
                ← رجوع
            </button>
            <h1>⚙️ الإعدادات</h1>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="settings-container">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="account">👤 معلومات الحساب</button>
                <button class="tab-btn" data-tab="farm">🌾 معلومات المزرعة</button>
                <button class="tab-btn" data-tab="security">🔒 الأمان</button>
                <button class="tab-btn" data-tab="preferences">🎨 التفضيلات</button>
                <button class="tab-btn" data-tab="notifications">🔔 الإشعارات</button>
            </div>

            <!-- Tab 1: Account Info -->
            <div class="tab-content active" id="account">
                <div class="alert" id="accountAlert"></div>
                
                <div class="form-section">
                    <h3 class="section-title">معلومات الحساب</h3>
                    
                    <form id="accountForm">
                        <div class="form-group">
                            <label for="fullName">الاسم الكامل</label>
                            <input type="text" id="fullName" placeholder="أحمد محمد">
                        </div>

                        <div class="form-group">
                            <label for="email">البريد الإلكتروني</label>
                            <input type="email" id="email" disabled>
                            <span class="helper-text">لا يمكن تغيير البريد الإلكتروني</span>
                        </div>

                        <div class="form-group">
                            <label for="phone">رقم الهاتف</label>
                            <input type="tel" id="phone" placeholder="0555123456">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="saveAccountBtn">
                                💾 حفظ التغييرات
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tab 2: Farm Info -->
            <div class="tab-content" id="farm">
                <div class="alert" id="farmAlert"></div>
                
                <div class="form-section">
                    <h3 class="section-title">معلومات المزرعة</h3>
                    
                    <form id="farmForm">
                        <div class="form-group">
                            <label for="farmName">اسم المزرعة</label>
                            <input type="text" id="farmName" placeholder="مزرعة الأمل">
                        </div>

                        <div class="form-group">
                            <label for="farmLocation">الموقع / العنوان</label>
                            <input type="text" id="farmLocation" placeholder="عنابة، الجزائر">
                        </div>

                        <div class="form-group">
                            <label for="farmSize">المساحة الإجمالية (هكتار)</label>
                            <input type="number" id="farmSize" placeholder="50" step="0.01">
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary" id="saveFarmBtn">
                                💾 حفظ التغييرات
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tab 3: Security -->
            <div class="tab-content" id="security">
                <div class="alert" id="securityAlert"></div>
                
                <div class="form-section">
                    <h3 class="section-title">الأمان</h3>
                    
                    <div class="form-group">
                        <label>كلمة المرور</label>
                        <p style="color: #7f8c8d; margin-bottom: 1rem;">
                            آخر تحديث: لم يتم التغيير بعد
                        </p>
                        <button class="btn btn-secondary" onclick="openPasswordModal()">
                            🔑 تغيير كلمة المرور
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Preferences -->
            <div class="tab-content" id="preferences">
                <div class="alert" id="preferencesAlert"></div>
                
                <div class="form-section">
                    <h3 class="section-title">التفضيلات</h3>
                    
                    <form id="preferencesForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="language">اللغة</label>
                                <select id="language">
                                    <option value="ar">العربية</option>
                                    <option value="en">English</option>
                                    <option value="fr">Français</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="currency">العملة</label>
                                <select id="currency">
                                    <option value="DZD">دينار جزائري (DZD)</option>
                                    <option value="USD">دولار أمريكي (USD)</option>
                                    <option value="EUR">يورو (EUR)</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>المظهر</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" id="themeLight" name="theme" value="light" checked>
                                    <label for="themeLight">☀️ فاتح</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" id="themeDark" name="theme" value="dark">
                                    <label for="themeDark">🌙 داكن</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="dateFormat">تنسيق التاريخ</label>
                                <select id="dateFormat">
                                    <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                    <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                    <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="timeFormat">تنسيق الوقت</label>
                                <select id="timeFormat">
                                    <option value="24h">24 ساعة</option>
                                    <option value="12h">12 ساعة</option>
                                </select>
                            </div>
                        </div>

                        <p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 1rem;">
                            ℹ️ يتم حفظ التفضيلات تلقائياً عند التغيير
                        </p>
                    </form>
                </div>
            </div>

            <!-- Tab 5: Notifications -->
            <div class="tab-content" id="notifications">
                <div class="alert" id="notificationsAlert"></div>
                
                <div class="form-section">
                    <h3 class="section-title">إعدادات الإشعارات</h3>
                    
                    <form id="notificationsForm">
                        <div class="form-group">
                            <label>قنوات الإشعارات</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="notificationsEnabled" checked>
                                    <label for="notificationsEnabled">تفعيل الإشعارات</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="emailNotifications">
                                    <label for="emailNotifications">إشعارات البريد الإلكتروني</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="smsNotifications">
                                    <label for="smsNotifications">إشعارات SMS</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-top: 2rem;">
                            <label>أنواع الإشعارات المطلوبة</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="notifyLowInventory" checked>
                                    <label for="notifyLowInventory">📦 مخزون منخفض</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="notifyVaccination" checked>
                                    <label for="notifyVaccination">💉 تطعيمات قادمة</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="notifyMaintenance" checked>
                                    <label for="notifyMaintenance">🔧 صيانة دورية</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="notifyBirths" checked>
                                    <label for="notifyBirths">🐑 ولادات متوقعة</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="notifyLoans" checked>
                                    <label for="notifyLoans">💰 قروض مستحقة</label>
                                </div>
                            </div>
                        </div>

                        <p style="color: #7f8c8d; font-size: 0.9rem; margin-top: 1rem;">
                            ℹ️ يتم حفظ إعدادات الإشعارات تلقائياً عند التغيير
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تغيير كلمة المرور</h3>
                <button class="modal-close" onclick="closePasswordModal()">✕</button>
            </div>

            <div class="alert" id="passwordAlert"></div>

            <form id="passwordForm">
                <div class="form-group">
                    <label for="currentPassword">كلمة المرور الحالية</label>
                    <input type="password" id="currentPassword" required>
                </div>

                <div class="form-group">
                    <label for="newPassword">كلمة المرور الجديدة</label>
                    <input type="password" id="newPassword" required>
                    <span class="helper-text">يجب أن تحتوي على 8 أحرف على الأقل</span>
                </div>

                <div class="form-group">
                    <label for="confirmNewPassword">تأكيد كلمة المرور الجديدة</label>
                    <input type="password" id="confirmNewPassword" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                        🔑 تحديث كلمة المرور
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">
                        إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://sstvsknmmhbwubzajeix.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdHZza25tbWhid3ViemFqZWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDM0NjIsImV4cCI6MjA3NDkxOTQ2Mn0.EeVUU9DxRYUi38nUHgWEsnG8li7KZjqAGPNW9IDokhg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let userSettings = null;

        // ============================================
        // Authentication Guard
        // ============================================
        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error || !session) {
                    window.location.href = 'login.html';
                    return false;
                }

                currentUser = session.user;
                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // ============================================
        // Tab Switching
        // ============================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                
                // Update buttons
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Update content
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
            });
        });

        // ============================================
        // Load Settings
        // ============================================
        async function loadSettings() {
            try {
                // Get user settings
                const { data, error } = await supabase
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                userSettings = data || {};

                // Populate account info
                document.getElementById('fullName').value = currentUser.user_metadata?.name || '';
                document.getElementById('email').value = currentUser.email || '';
                document.getElementById('phone').value = userSettings.phone || '';

                // Populate farm info
                document.getElementById('farmName').value = userSettings.farm_name || '';
                document.getElementById('farmLocation').value = userSettings.farm_location || '';
                document.getElementById('farmSize').value = userSettings.farm_size_hectares || '';

                // Populate preferences
                document.getElementById('language').value = userSettings.language || 'ar';
                document.getElementById('currency').value = userSettings.currency || 'DZD';
                document.getElementById('dateFormat').value = userSettings.date_format || 'DD/MM/YYYY';
                document.getElementById('timeFormat').value = userSettings.time_format || '24h';
                
                const theme = userSettings.theme || 'light';
                document.querySelector(`input[name="theme"][value="${theme}"]`).checked = true;

                // Populate notifications
                document.getElementById('notificationsEnabled').checked = userSettings.notifications_enabled !== false;
                document.getElementById('emailNotifications').checked = userSettings.email_notifications || false;
                document.getElementById('smsNotifications').checked = userSettings.sms_notifications || false;

            } catch (error) {
                console.error('Error loading settings:', error);
                showAlert('accountAlert', 'حدث خطأ في تحميل الإعدادات', 'error');
            }
        }

        // ============================================
        // Update Account Info
        // ============================================
        document.getElementById('accountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const btn = document.getElementById('saveAccountBtn');

            btn.disabled = true;
            btn.innerHTML = '💾 جاري الحفظ<span class="loading-spinner"></span>';

            try {
                // Update user metadata
                const { error: authError } = await supabase.auth.updateUser({
                    data: { name: fullName }
                });

                if (authError) throw authError;

                // Update or insert user settings
                const { error: settingsError } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: currentUser.id,
                        phone: phone
                    });

                if (settingsError) throw settingsError;

                showAlert('accountAlert', '✅ تم حفظ معلومات الحساب بنجاح', 'success');
                
                // Reload to get updated data
                setTimeout(() => {
                    location.reload();
                }, 1500);

            } catch (error) {
                console.error('Error updating account:', error);
                showAlert('accountAlert', 'حدث خطأ في حفظ البيانات', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '💾 حفظ التغييرات';
            }
        });

        // ============================================
        // Update Farm Info
        // ============================================
        document.getElementById('farmForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const farmName = document.getElementById('farmName').value.trim();
            const farmLocation = document.getElementById('farmLocation').value.trim();
            const farmSize = document.getElementById('farmSize').value;
            const btn = document.getElementById('saveFarmBtn');

            btn.disabled = true;
            btn.innerHTML = '💾 جاري الحفظ<span class="loading-spinner"></span>';

            try {
                const { error } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: currentUser.id,
                        farm_name: farmName,
                        farm_location: farmLocation,
                        farm_size_hectares: farmSize ? parseFloat(farmSize) : null
                    });

                if (error) throw error;

                showAlert('farmAlert', '✅ تم حفظ معلومات المزرعة بنجاح', 'success');

            } catch (error) {
                console.error('Error updating farm info:', error);
                showAlert('farmAlert', 'حدث خطأ في حفظ البيانات', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '💾 حفظ التغييرات';
            }
        });

        // ============================================
        // Auto-save Preferences
        // ============================================
        ['language', 'currency', 'dateFormat', 'timeFormat'].forEach(id => {
            document.getElementById(id).addEventListener('change', autoSavePreferences);
        });

        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', autoSavePreferences);
        });

        async function autoSavePreferences() {
            try {
                const theme = document.querySelector('input[name="theme"]:checked').value;
                
                const { error } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: currentUser.id,
                        language: document.getElementById('language').value,
                        currency: document.getElementById('currency').value,
                        date_format: document.getElementById('dateFormat').value,
                        time_format: document.getElementById('timeFormat').value,
                        theme: theme
                    });

                if (error) throw error;

                showAlert('preferencesAlert', '✅ تم حفظ التفضيلات تلقائياً', 'success');
                setTimeout(() => {
                    hideAlert('preferencesAlert');
                }, 2000);

            } catch (error) {
                console.error('Error saving preferences:', error);
                showAlert('preferencesAlert', 'حدث خطأ في الحفظ', 'error');
            }
        }

        // ============================================
        // Auto-save Notifications
        // ============================================
        ['notificationsEnabled', 'emailNotifications', 'smsNotifications',
         'notifyLowInventory', 'notifyVaccination', 'notifyMaintenance',
         'notifyBirths', 'notifyLoans'].forEach(id => {
            document.getElementById(id).addEventListener('change', autoSaveNotifications);
        });

        async function autoSaveNotifications() {
            try {
                const { error } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: currentUser.id,
                        notifications_enabled: document.getElementById('notificationsEnabled').checked,
                        email_notifications: document.getElementById('emailNotifications').checked,
                        sms_notifications: document.getElementById('smsNotifications').checked
                    });

                if (error) throw error;

                showAlert('notificationsAlert', '✅ تم حفظ إعدادات الإشعارات تلقائياً', 'success');
                setTimeout(() => {
                    hideAlert('notificationsAlert');
                }, 2000);

            } catch (error) {
                console.error('Error saving notifications:', error);
                showAlert('notificationsAlert', 'حدث خطأ في الحفظ', 'error');
            }
        }

        // ============================================
        // Password Modal
        // ============================================
        function openPasswordModal() {
            document.getElementById('passwordModal').classList.add('show');
            document.getElementById('passwordForm').reset();
            hideAlert('passwordAlert');
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('show');
        }

        // Change Password
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            const btn = document.getElementById('changePasswordBtn');

            // Validate passwords match
            if (newPassword !== confirmNewPassword) {
                showAlert('passwordAlert', 'كلمتا المرور غير متطابقتين', 'error');
                return;
            }

            // Validate password strength
            if (newPassword.length < 8) {
                showAlert('passwordAlert', 'كلمة المرور يجب أن تحتوي على 8 أحرف على الأقل', 'error');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '🔑 جاري التحديث<span class="loading-spinner"></span>';

            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                showAlert('passwordAlert', '✅ تم تغيير كلمة المرور بنجاح', 'success');
                
                setTimeout(() => {
                    closePasswordModal();
                    showAlert('securityAlert', '✅ تم تحديث كلمة المرور بنجاح', 'success');
                }, 1500);

            } catch (error) {
                console.error('Error changing password:', error);
                showAlert('passwordAlert', 'حدث خطأ في تغيير كلمة المرور', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '🔑 تحديث كلمة المرور';
            }
        });

        // ============================================
        // Helper Functions
        // ============================================
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            alert.className = `alert alert-${type} show`;
        }

        function hideAlert(elementId) {
            const alert = document.getElementById(elementId);
            alert.classList.remove('show');
        }

        function goBack() {
            window.location.href = 'index.html';
        }

        // ============================================
        // Initialize
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            const isAuthenticated = await checkAuth();
            
            if (isAuthenticated) {
                await loadSettings();
                document.getElementById('authLoading').classList.add('hidden');
                console.log('✅ Settings loaded successfully');
            }
        });

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
