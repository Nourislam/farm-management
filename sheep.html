<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘ Ù…Ø´Ø±ÙˆØ¹ ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø£ØºÙ†Ø§Ù…</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #f5f7fa;
            direction: rtl;
        }

        /* Navbar */
        .navbar {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            flex-shrink: 0;
        }

        .stat-icon.ewes {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: white;
        }

        .stat-icon.lambs {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .stat-icon.rams {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .stat-icon.total {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .stat-content {
            flex: 1;
        }

        .stat-content h3 {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-content .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d5016;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .tab:hover {
            color: #4a7c2a;
            background: rgba(74, 124, 42, 0.05);
        }

        .tab.active {
            color: #4a7c2a;
            border-bottom-color: #4a7c2a;
            background: rgba(74, 124, 42, 0.05);
        }

        /* Section */
        .section {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-header h2 {
            color: #2d5016;
            font-size: 1.3rem;
            font-weight: 700;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a7c2a 0%, #2d5016 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(74, 124, 42, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 124, 42, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            color: #374151;
            font-weight: 700;
            font-size: 0.9rem;
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #f9fafb;
            transform: translateX(-2px);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        /* Action Buttons */
        .action-btn {
            padding: 0.4rem 0.8rem;
            margin: 0 0.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }

        .action-btn.delete {
            background: #ef4444;
            color: white;
        }

        .action-btn.delete:hover {
            background: #dc2626;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: #2d5016;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #ef4444;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.3rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a7c2a;
            box-shadow: 0 0 0 3px rgba(74, 124, 42, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Feed Items */
        .feed-items {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .feed-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        /* Loading & Empty States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }

        /* Stats Section */
        .stats-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .financial-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .financial-card {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            text-align: center;
            transition: all 0.3s;
        }

        .financial-card:hover {
            border-color: #4a7c2a;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .financial-card h3 {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .financial-card .amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .financial-card.expenses .amount {
            color: #ef4444;
        }

        .financial-card.sales .amount {
            color: #10b981;
        }

        .financial-card.profit .amount {
            color: #3b82f6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .navbar {
                padding: 1rem;
            }

            .navbar h1 {
                font-size: 1.2rem;
            }

            .tabs {
                overflow-x: scroll;
            }

            .feed-item {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <h1><i class="fas fa-sheep"></i> Ù…Ø´Ø±ÙˆØ¹ ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø£ØºÙ†Ø§Ù…</h1>
        <button class="back-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </button>
    </nav>

    <!-- Container -->
    <div class="container">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon ewes">
                    <i class="fas fa-venus"></i>
                </div>
                <div class="stat-content">
                    <h3>Ø§Ù„Ù†Ø¹Ø§Ø¬</h3>
                    <div class="value" id="ewesCount">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon lambs">
                    <i class="fas fa-baby"></i>
                </div>
                <div class="stat-content">
                    <h3>Ø§Ù„Ø­Ù…Ù„Ø§Ù†</h3>
                    <div class="value" id="lambsCount">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon rams">
                    <i class="fas fa-mars"></i>
                </div>
                <div class="stat-content">
                    <h3>Ø§Ù„ÙƒØ¨Ø§Ø´</h3>
                    <div class="value" id="ramsCount">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-list-ol"></i>
                </div>
                <div class="stat-content">
                    <h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h3>
                    <div class="value" id="totalCount">0</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('herd')">
                <i class="fas fa-sheep"></i> Ø§Ù„Ù‚Ø·ÙŠØ¹
            </button>
            <button class="tab" onclick="showTab('health')">
                <i class="fas fa-syringe"></i> Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµØ­ÙŠØ©
            </button>
            <button class="tab" onclick="showTab('births')">
                <i class="fas fa-baby-carriage"></i> Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª
            </button>
            <button class="tab" onclick="showTab('feeding')">
                <i class="fas fa-wheat-awn"></i> Ø§Ù„ØªØºØ°ÙŠØ©
            </button>
            <button class="tab" onclick="showTab('employees')">
                <i class="fas fa-users"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            </button>
            <button class="tab" onclick="showTab('expenses')">
                <i class="fas fa-receipt"></i> Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            </button>
            <button class="tab" onclick="showTab('sales')">
                <i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
            </button>
            <button class="tab" onclick="showTab('debts')">
                <i class="fas fa-file-invoice-dollar"></i> Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¹ÙŠØ¯
            </button>
        </div>

        <!-- Herd Section -->
        <div id="herd" class="section active">
            <div class="section-header">
                <h2><i class="fas fa-sheep"></i> Ø§Ù„Ù‚Ø·ÙŠØ¹</h2>
                <button class="btn btn-primary" onclick="openAddAnimalModal()">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø­ÙŠÙˆØ§Ù†
                </button>
            </div>
            <div id="herdAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ø¬Ù†Ø³</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th>
                            <th>Ø§Ù„Ø¹Ù…Ø±</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="herdBody">
                        <tr><td colspan="7" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Health Section -->
        <div id="health" class="section">
            <div class="section-header">
                <h2><i class="fas fa-syringe"></i> Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµØ­ÙŠØ©</h2>
                <button class="btn btn-primary" onclick="openAddHealthModal()">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØµØ­ÙŠ
                </button>
            </div>
            <div id="healthAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„ÙˆØµÙ</th>
                            <th>Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
                            <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                            <th>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù…</th>
                        </tr>
                    </thead>
                    <tbody id="healthBody">
                        <tr><td colspan="7" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Births Section -->
        <div id="births" class="section">
            <div class="section-header">
                <h2><i class="fas fa-baby-carriage"></i> Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª</h2>
                <button class="btn btn-primary" onclick="openAddBirthModal()">
                    <i class="fas fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ ÙˆÙ„Ø§Ø¯Ø©
                </button>
            </div>
            <div id="birthsAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø£Ù…</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ù„Ø§Ù†</th>
                            <th>Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</th>
                            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="birthsBody">
                        <tr><td colspan="5" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Feeding Section -->
        <div id="feeding" class="section">
            <div class="section-header">
                <h2><i class="fas fa-wheat-awn"></i> Ø§Ù„ØªØºØ°ÙŠØ©</h2>
                <button class="btn btn-primary" onclick="openAddFeedModal()">
                    <i class="fas fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ ØªØºØ°ÙŠØ©
                </button>
            </div>
            <div id="feedingAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¤ÙˆØ³</th>
                            <th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</th>
                            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="feedingBody">
                        <tr><td colspan="5" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Employees Section -->
        <div id="employees" class="section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
                <button class="btn btn-primary" onclick="openAddProjectEmployeeModal()">
                    <i class="fas fa-user-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù
                </button>
            </div>
            <div id="employeesAlert"></div>
            
            <!-- Auto Salary Info -->
            <div style="background: #dbeafe; border: 2px solid #3b82f6; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; color: #1e40af; margin-bottom: 0.5rem;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Ù†Ø¸Ø§Ù… Ø§Ù„Ø±ÙˆØ§ØªØ¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</strong>
                </div>
                <p style="color: #1e40af; font-size: 0.9rem; margin: 0;">
                    Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† Ø¨Ø£Ø¬Ø± <strong>Ø«Ø§Ø¨Øª (Ø´Ù‡Ø±ÙŠ)</strong> Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø±ÙˆØ§ØªØ¨Ù‡Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ. 
                    Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø®Ø±Ù‰ (ÙŠÙˆÙ…ÙŠØŒ Ø³Ø§Ø¹ÙŠØŒ Ù†Ø³Ø¨Ø©) ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ.
                </p>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù…Ù‡Ø§Ù…</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø£Ø¬Ø±</th>
                            <th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¬Ø±</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="employeesBody">
                        <tr><td colspan="7" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenses Section -->
        <div id="expenses" class="section">
            <div class="section-header">
                <h2><i class="fas fa-receipt"></i> Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
                <button class="btn btn-primary" onclick="openAddExpenseModal()">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
                </button>
            </div>
            <div id="expensesAlert"></div>
            
            <!-- Financial Stats Overview -->
            <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 2px solid #e5e7eb; margin-bottom: 2rem;">
                <h3 style="color: #2d5016; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-line"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
                </h3>
                <div class="financial-overview">
                    <div class="financial-card expenses">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
                        <div class="amount" id="totalExpenses">0 Ø¯</div>
                    </div>
                    <div class="financial-card sales">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                        <div class="amount" id="totalSales">0 Ø¯</div>
                    </div>
                    <div class="financial-card profit">
                        <h3>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</h3>
                        <div class="amount" id="netProfit">0 Ø¯</div>
                    </div>
                </div>
            </div>

            <!-- Expense Categories Summary -->
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #2d5016; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-pie"></i> Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #92400e; margin-bottom: 0.3rem;">ğŸŒ¾ Ø£Ø¹Ù„Ø§Ù</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #92400e;" id="feedExpenses">0 Ø¯</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #1e40af; margin-bottom: 0.3rem;">ğŸ‘¥ Ø±ÙˆØ§ØªØ¨</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #1e40af;" id="salaryExpenses">0 Ø¯</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #991b1b; margin-bottom: 0.3rem;">ğŸ’Š Ø£Ø¯ÙˆÙŠØ©</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #991b1b;" id="medicineExpenses">0 Ø¯</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #3730a3; margin-bottom: 0.3rem;">ğŸ”§ ØµÙŠØ§Ù†Ø©</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #3730a3;" id="maintenanceExpenses">0 Ø¯</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #6b21a8; margin-bottom: 0.3rem;">ğŸ“¦ Ø£Ø®Ø±Ù‰</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #6b21a8;" id="otherExpenses">0 Ø¯</div>
                    </div>
                </div>
            </div>

            <!-- Expenses Table -->
            <h3 style="color: #2d5016; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-list"></i> Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ
            </h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„ÙØ¦Ø©</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th>Ø§Ù„ÙˆØµÙ</th>
                            <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody">
                        <tr><td colspan="7" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Section -->
        <div id="sales" class="section">
            <div class="section-header">
                <h2><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
                <button class="btn btn-primary" onclick="openAddSaleModal()">
                    <i class="fas fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ¹
                </button>
            </div>
            <div id="salesAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th>
                            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody">
                        <tr><td colspan="6" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Debts Section -->
        <div id="debts" class="section">
            <div class="section-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> Ø¯ÙŠÙˆÙ† Ø§Ù„Ø¹ÙŠØ¯</h2>
                <button class="btn btn-primary" onclick="openAddDebtModal()">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ†
                </button>
            </div>
            <div id="debtsAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</th>
                            <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                            <th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="debtsBody">
                        <tr><td colspan="7" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Stats Section -->
        <div id="stats" class="section">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
            </div>
            <div class="financial-overview">
                <div class="financial-card expenses">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
                    <div class="amount" id="totalExpenses">0 Ø¯</div>
                </div>
                <div class="financial-card sales">
                    <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                    <div class="amount" id="totalSales">0 Ø¯</div>
                </div>
                <div class="financial-card profit">
                    <h3>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­/Ø§Ù„Ø®Ø³Ø§Ø±Ø©</h3>
                    <div class="amount" id="netProfit">0 Ø¯</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Animal Modal -->
    <div id="addAnimalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø¥Ø¶Ø§ÙØ© Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</h3>
                <button class="close-btn" onclick="closeModal('addAnimalModal')">&times;</button>
            </div>
            <form id="addAnimalForm" onsubmit="addAnimal(event)">
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© *</label>
                    <input type="text" name="tag_number" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù†ÙˆØ¹ *</label>
                    <select name="type" required>
                        <option value="ewe">Ù†Ø¹Ø¬Ø©</option>
                        <option value="ram">ÙƒØ¨Ø´</option>
                        <option value="lamb">Ø­Ù…Ù„</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¬Ù†Ø³ *</label>
                    <select name="sex" required>
                        <option value="F">Ø£Ù†Ø«Ù‰</option>
                        <option value="M">Ø°ÙƒØ±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
                    <input type="date" name="birth_date">
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</label>
                    <input type="date" name="purchase_date">
                </div>
                <div class="form-group">
                    <label>Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡</label>
                    <input type="number" name="purchase_price" step="0.01">
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Ø­ÙØ¸</button>
            </form>
        </div>
    </div>

    <!-- Add Health Modal -->
    <div id="addHealthModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØµØ­ÙŠ</h3>
                <button class="close-btn" onclick="closeModal('addHealthModal')">&times;</button>
            </div>
            <form id="addHealthForm" onsubmit="addHealthRecord(event)">
                <div class="form-group">
                    <label>Ø§Ù„Ø­ÙŠÙˆØ§Ù† *</label>
                    <select name="animal_id" id="healthAnimalSelect" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠÙˆØ§Ù†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù†ÙˆØ¹ *</label>
                    <select name="record_type" required>
                        <option value="vaccination">ØªØ·Ø¹ÙŠÙ…</option>
                        <option value="treatment">Ø¹Ù„Ø§Ø¬</option>
                        <option value="checkup">ÙØ­Øµ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                    <input type="date" name="record_date" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ</label>
                    <textarea name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
                    <input type="text" name="medication">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¬Ø±Ø¹Ø©</label>
                    <input type="text" name="dosage">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªÙƒÙ„ÙØ©</label>
                    <input type="number" name="cost" step="0.01">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
                    <input type="date" name="next_due_date">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Ø­ÙØ¸</button>
            </form>
        </div>
    </div>

    <!-- Add Birth Modal -->
    <div id="addBirthModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ØªØ³Ø¬ÙŠÙ„ ÙˆÙ„Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
                <button class="close-btn" onclick="closeModal('addBirthModal')">&times;</button>
            </div>
            <form id="addBirthForm" onsubmit="addBirth(event)">
                <div class="form-group">
                    <label>Ø§Ù„Ø£Ù… *</label>
                    <select name="mother_id" id="birthMotherSelect" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ù…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© *</label>
                    <input type="date" name="birth_date" required>
                </div>
                <div class="form-group">
                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ù„Ø§Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ *</label>
                    <input type="number" name="total_lambs" min="1" required>
                </div>
                <div class="form-group">
                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ù„Ø§Ù† Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ *</label>
                    <input type="number" name="live_lambs" min="0" required>
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Ø­ÙØ¸</button>
            </form>
        </div>
    </div>

    <!-- Add Feed Modal -->
    <div id="addFeedModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ØªØ³Ø¬ÙŠÙ„ ØªØºØ°ÙŠØ©</h3>
                <button class="close-btn" onclick="closeModal('addFeedModal')">&times;</button>
            </div>
            <form id="addFeedForm" onsubmit="addFeedLog(event)">
                <div class="form-group">
                    <label><i class="fas fa-sheep"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¤ÙˆØ³ *</label>
                    <input type="number" name="animal_count" min="1" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label><i class="fas fa-calendar-alt"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© *</label>
                        <input type="date" name="start_date" id="startDate" required onchange="updateEndDateMin()">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar-check"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© *</label>
                        <input type="date" name="end_date" id="endDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea name="notes" rows="2"></textarea>
                </div>
                <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid #e5e7eb;">
                <h4 style="color: #2d5016; margin-bottom: 1rem;">
                    <i class="fas fa-boxes"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© (ÙŠÙˆÙ…ÙŠØ§Ù‹)
                </h4>
                <div id="feedItems">
                    <div class="feed-item-row" style="display: grid; gap: 0.8rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„ØªØµÙ†ÙŠÙ *</label>
                                <select name="category_id[]" onchange="loadItemsByCategory(this)" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„Ù…Ø§Ø¯Ø© *</label>
                                <select name="item_id[]" onchange="fillItemPrice(this)" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.8rem; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© *</label>
                                <input type="number" name="quantity[]" placeholder="Ù…Ø«Ø§Ù„: 50" step="0.01" min="0.01" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                                <input type="text" name="unit[]" readonly style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; background: #f3f4f6; font-family: 'Cairo', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„Ø³Ø¹Ø±/ÙˆØ­Ø¯Ø©</label>
                                <input type="number" name="unit_cost[]" readonly step="0.01" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; background: #f3f4f6; font-family: 'Cairo', sans-serif;">
                            </div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="removeFeedItem(this)" style="margin-bottom: 0;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="background: #e0f2fe; padding: 0.5rem; border-radius: 4px; font-size: 0.85rem; color: #075985;">
                            <i class="fas fa-info-circle"></i> <span class="item-stock-info">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addFeedItem()" style="width: 100%; margin-bottom: 1rem;">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø£Ø®Ø±Ù‰
                </button>
                <div id="feedSummary" style="background: #f0fdf4; border: 2px solid #86efac; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none;">
                    <h4 style="color: #166534; margin-bottom: 0.5rem;"><i class="fas fa-calculator"></i> Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒÙ„ÙØ©</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem; color: #166534;">
                        <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…: <strong id="totalDays">0</strong></div>
                        <div>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: <strong id="dailyCost">0 Ø¯</strong></div>
                        <div style="grid-column: 1 / -1; font-size: 1.1rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #86efac;">
                            Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: <strong id="totalCost">0 Ø¯</strong>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Ø­ÙØ¸ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØºØ°ÙŠØ©
                </button>
            </form>
        </div>
    </div>

    <!-- Add Sale Modal -->
    <div id="addSaleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ¹</h3>
                <button class="close-btn" onclick="closeModal('addSaleModal')">&times;</button>
            </div>
            <form id="addSaleForm" onsubmit="addSale(event)">
                <div class="form-group">
                    <label>Ø§Ù„Ø­ÙŠÙˆØ§Ù† *</label>
                    <select name="animal_id" id="saleAnimalSelect" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠÙˆØ§Ù†</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨ÙŠØ¹ *</label>
                    <input type="date" name="sale_date" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø³Ø¹Ø± *</label>
                    <input type="number" name="sale_price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <input type="text" name="customer_name">
                </div>
                <div class="form-group">
                    <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ *</label>
                    <select name="payment_status" required>
                        <option value="paid">Ù…Ø¯ÙÙˆØ¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</option>
                        <option value="partial">Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹</option>
                        <option value="pending">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label>
                    <input type="number" name="remaining_amount" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Ø­ÙØ¸</button>
            </form>
        </div>
    </div>

    <!-- Add Debt Modal -->
    <div id="addDebtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ø¹ÙŠØ¯</h3>
                <button class="close-btn" onclick="closeModal('addDebtModal')">&times;</button>
            </div>
            <form id="addDebtForm" onsubmit="addDebt(event)">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
                    <input type="text" name="customer_name" required>
                </div>
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label>
                    <input type="text" name="animal_type" placeholder="Ù…Ø«Ø§Ù„: ÙƒØ¨Ø´ØŒ Ù†Ø¹Ø¬Ø©">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                    <input type="number" name="quantity" min="1">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ *</label>
                    <input type="number" name="total_amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                    <input type="number" name="paid_amount" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
                    <input type="date" name="due_date">
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Ø­ÙØ¸</button>
            </form>
        </div>
    </div>

    <!-- Add Project Employee Modal -->
    <div id="addProjectEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ù„Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
                <button class="close-btn" onclick="closeModal('addProjectEmployeeModal')">&times;</button>
            </div>
            <form id="addProjectEmployeeForm" onsubmit="addProjectEmployee(event)">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Ø§Ù„Ù…ÙˆØ¸Ù *</label>
                    <select name="employee_id" id="employeeSelect" required onchange="fillEmployeeDefaults(this)">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© *</label>
                    <input type="date" name="start_date" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tasks"></i> Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø³Ù†Ø¯Ø©</label>
                    <input type="text" name="assigned_tasks" placeholder="Ù…Ø«Ø§Ù„: Ø±Ø¹Ø§ÙŠØ©ØŒ ØªØºØ°ÙŠØ©ØŒ ØªÙ†Ø¸ÙŠÙ">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-money-bill-wave"></i> Ù†ÙˆØ¹ Ø§Ù„Ø£Ø¬Ø± *</label>
                    <select name="salary_type" id="salaryTypeSelect" required onchange="toggleSalaryInfo()">
                        <option value="fixed">Ø«Ø§Ø¨Øª (Ø´Ù‡Ø±ÙŠ)</option>
                        <option value="daily">ÙŠÙˆÙ…ÙŠ</option>
                        <option value="hourly">Ø³Ø§Ø¹ÙŠ</option>
                        <option value="percentage">Ù†Ø³Ø¨Ø© Ù…Ù† Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-dollar-sign"></i> Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£Ø¬Ø± *</label>
                    <input type="number" name="salary_amount" step="0.01" required>
                    <small id="salaryHint" style="color: #6b7280; display: block; margin-top: 0.3rem;">
                        Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø±
                    </small>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Ø­ÙØ¸
                </button>
            </form>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
                <button class="close-btn" onclick="closeModal('addExpenseModal')">&times;</button>
            </div>
            <form id="addExpenseForm" onsubmit="addExpense(event)">
                <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                    <input type="date" name="expense_date" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tags"></i> Ø§Ù„ÙØ¦Ø© *</label>
                    <select name="category" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
                        <option value="Ø£Ø¹Ù„Ø§Ù">Ø£Ø¹Ù„Ø§Ù</option>
                        <option value="Ø£Ø¯ÙˆÙŠØ©">Ø£Ø¯ÙˆÙŠØ©</option>
                        <option value="Ø±ÙˆØ§ØªØ¨">Ø±ÙˆØ§ØªØ¨</option>
                        <option value="ØµÙŠØ§Ù†Ø©">ØµÙŠØ§Ù†Ø©</option>
                        <option value="ØªØ¹Ù‚ÙŠÙ…">ØªØ¹Ù‚ÙŠÙ…</option>
                        <option value="Ù†Ø¸Ø§ÙØ©">Ù†Ø¸Ø§ÙØ©</option>
                        <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                        <option value="Ù…Ø§Ø¡">Ù…Ø§Ø¡</option>
                        <option value="Ù†Ù‚Ù„">Ù†Ù‚Ù„</option>
                        <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-dollar-sign"></i> Ø§Ù„Ù…Ø¨Ù„Øº *</label>
                    <input type="number" name="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø±ØªØ¨Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <select name="employee_id" id="expenseEmployeeSelect">
                        <option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-credit-card"></i> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                    <select name="payment_method">
                        <option value="">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</option>
                        <option value="Ù†Ù‚Ø¯ÙŠ">Ù†Ù‚Ø¯ÙŠ</option>
                        <option value="ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                        <option value="Ø´ÙŠÙƒ">Ø´ÙŠÙƒ</option>
                        <option value="Ø¨Ø·Ø§Ù‚Ø©">Ø¨Ø·Ø§Ù‚Ø©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-align-right"></i> Ø§Ù„ÙˆØµÙ</label>
                    <textarea name="description" rows="3" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Ø­ÙØ¸
                </button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sstvsknmmhbwubzajeix.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdHZza25tbWhid3ViemFqZWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDM0NjIsImV4cCI6MjA3NDkxOTQ2Mn0.EeVUU9DxRYUi38nUHgWEsnG8li7KZjqAGPNW9IDokhg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentProject = null;
        let allAnimals = [];
        let inventoryItems = [];
        let inventoryCategories = [];
        let allEmployees = [];
        let projectEmployees = [];

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '../../login.html';
                return false;
            }
            currentUser = session.user;
            return true;
        }

        function getProjectId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        async function loadProject() {
            const projectId = getProjectId();
            if (!projectId) {
                alert('Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                window.location.href = '../../index.html';
                return;
            }

            const { data, error } = await supabase
                .from('projects')
                .select('*')
                .eq('id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            if (error || !data) {
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
                window.location.href = '../../index.html';
                return;
            }

            currentProject = data;
            document.querySelector('.navbar h1').innerHTML = `<i class="fas fa-sheep"></i> ${data.name}`;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.closest('.tab').classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        async function loadOverview() {
            const { data, error } = await supabase
                .from('sheep_animals')
                .select('type')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .eq('status', 'active');

            if (!error && data) {
                const ewes = data.filter(a => a.type === 'ewe').length;
                const lambs = data.filter(a => a.type === 'lamb').length;
                const rams = data.filter(a => a.type === 'ram').length;
                
                document.getElementById('ewesCount').textContent = ewes;
                document.getElementById('lambsCount').textContent = lambs;
                document.getElementById('ramsCount').textContent = rams;
                document.getElementById('totalCount').textContent = data.length;
            }
        }

        async function loadHerd() {
            const { data, error } = await supabase
                .from('sheep_animals')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('herdBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                return;
            }

            allAnimals = data;

            tbody.innerHTML = data.map(animal => {
                const age = animal.birth_date ? calculateAge(animal.birth_date) : '-';
                const typeText = animal.type === 'ewe' ? 'Ù†Ø¹Ø¬Ø©' : animal.type === 'ram' ? 'ÙƒØ¨Ø´' : 'Ø­Ù…Ù„';
                const sexText = animal.sex === 'F' ? 'Ø£Ù†Ø«Ù‰' : 'Ø°ÙƒØ±';
                const statusBadge = animal.status === 'active' ? 
                    '<span class="badge badge-success">Ù†Ø´Ø·</span>' : 
                    '<span class="badge badge-danger">Ù…Ø¨Ø§Ø¹</span>';

                return `
                    <tr>
                        <td><strong>${animal.tag_number}</strong></td>
                        <td>${typeText}</td>
                        <td>${sexText}</td>
                        <td>${animal.birth_date || '-'}</td>
                        <td>${age}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn delete" onclick="deleteAnimal('${animal.id}')">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateAnimalSelects();
        }

        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const now = new Date();
            const months = (now.getFullYear() - birth.getFullYear()) * 12 + (now.getMonth() - birth.getMonth());
            const years = Math.floor(months / 12);
            const remainingMonths = months % 12;
            
            if (years > 0) {
                return `${years} Ø³Ù†Ø© ${remainingMonths > 0 ? `Ùˆ ${remainingMonths} Ø´Ù‡Ø±` : ''}`;
            }
            return `${months} Ø´Ù‡Ø±`;
        }

        function updateAnimalSelects() {
            const healthSelect = document.getElementById('healthAnimalSelect');
            const saleSelect = document.getElementById('saleAnimalSelect');
            const birthSelect = document.getElementById('birthMotherSelect');

            const activeAnimals = allAnimals.filter(a => a.status === 'active');
            const ewes = activeAnimals.filter(a => a.type === 'ewe');

            const animalOptions = activeAnimals.map(a => 
                `<option value="${a.id}">${a.tag_number} - ${a.type === 'ewe' ? 'Ù†Ø¹Ø¬Ø©' : a.type === 'ram' ? 'ÙƒØ¨Ø´' : 'Ø­Ù…Ù„'}</option>`
            ).join('');

            const eweOptions = ewes.map(e => 
                `<option value="${e.id}">${e.tag_number} - Ù†Ø¹Ø¬Ø©</option>`
            ).join('');

            healthSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠÙˆØ§Ù†</option>' + animalOptions;
            saleSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠÙˆØ§Ù†</option>' + animalOptions;
            birthSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ù…</option>' + eweOptions;
        }

        async function addAnimal(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const { data, error } = await supabase
                .from('sheep_animals')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    tag_number: formData.get('tag_number'),
                    type: formData.get('type'),
                    sex: formData.get('sex'),
                    birth_date: formData.get('birth_date') || null,
                    purchase_date: formData.get('purchase_date') || null,
                    purchase_price: formData.get('purchase_price') || null,
                    notes: formData.get('notes') || null
                });

            if (error) {
                showAlert('herdAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­ÙŠÙˆØ§Ù†: ' + error.message);
                return;
            }

            showAlert('herdAlert', 'success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­');
            closeModal('addAnimalModal');
            e.target.reset();
            loadHerd();
            loadOverview();
        }

        async function deleteAnimal(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŸ')) return;

            const { error } = await supabase
                .from('sheep_animals')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id);

            if (error) {
                showAlert('herdAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­ÙŠÙˆØ§Ù†');
                return;
            }

            showAlert('herdAlert', 'success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­');
            loadHerd();
            loadOverview();
        }

        async function loadHealthRecords() {
            const { data, error } = await supabase
                .from('sheep_health_records')
                .select(`
                    *,
                    sheep_animals!inner(tag_number)
                `)
                .eq('user_id', currentUser.id)
                .order('record_date', { ascending: false });

            const tbody = document.getElementById('healthBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØµØ­ÙŠØ©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(record => {
                const typeText = record.record_type === 'vaccination' ? 
                    '<span class="badge badge-info">ØªØ·Ø¹ÙŠÙ…</span>' : 
                    record.record_type === 'treatment' ? 
                    '<span class="badge badge-warning">Ø¹Ù„Ø§Ø¬</span>' : 
                    '<span class="badge badge-success">ÙØ­Øµ</span>';
                
                return `
                    <tr>
                        <td><strong>${record.sheep_animals.tag_number}</strong></td>
                        <td>${typeText}</td>
                        <td>${record.record_date}</td>
                        <td>${record.description || '-'}</td>
                        <td>${record.medication || '-'}</td>
                        <td>${record.cost ? '<strong>' + record.cost.toLocaleString() + ' Ø¯</strong>' : '-'}</td>
                        <td>${record.next_due_date || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function addHealthRecord(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const { data, error } = await supabase
                .from('sheep_health_records')
                .insert({
                    user_id: currentUser.id,
                    animal_id: formData.get('animal_id'),
                    record_type: formData.get('record_type'),
                    record_date: formData.get('record_date'),
                    description: formData.get('description') || null,
                    medication: formData.get('medication') || null,
                    dosage: formData.get('dosage') || null,
                    cost: formData.get('cost') || null,
                    next_due_date: formData.get('next_due_date') || null
                });

            if (error) {
                showAlert('healthAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØµØ­ÙŠ');
                return;
            }

            const cost = formData.get('cost');
            if (cost && parseFloat(cost) > 0) {
                await supabase.from('expenses').insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    category: 'Ø£Ø¯ÙˆÙŠØ©',
                    amount: parseFloat(cost),
                    description: `Ø³Ø¬Ù„ ØµØ­ÙŠ: ${formData.get('description') || 'Ø¹Ù„Ø§Ø¬'}`,
                    expense_date: formData.get('record_date')
                });
            }

            showAlert('healthAlert', 'success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØµØ­ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            closeModal('addHealthModal');
            e.target.reset();
            loadHealthRecords();
        }

        async function loadBirths() {
            const { data, error } = await supabase
                .from('sheep_births')
                .select(`
                    *,
                    sheep_animals!inner(tag_number)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('birth_date', { ascending: false });

            const tbody = document.getElementById('birthsBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆÙ„Ø§Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(birth => `
                <tr>
                    <td><strong>${birth.sheep_animals.tag_number}</strong></td>
                    <td>${birth.birth_date}</td>
                    <td><span class="badge badge-info">${birth.total_lambs}</span></td>
                    <td><span class="badge badge-success">${birth.live_lambs}</span></td>
                    <td>${birth.notes || '-'}</td>
                </tr>
            `).join('');
        }

        async function addBirth(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const { data, error } = await supabase
                .from('sheep_births')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    mother_id: formData.get('mother_id'),
                    birth_date: formData.get('birth_date'),
                    total_lambs: parseInt(formData.get('total_lambs')),
                    live_lambs: parseInt(formData.get('live_lambs')),
                    notes: formData.get('notes') || null
                });

            if (error) {
                showAlert('birthsAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©');
                return;
            }

            showAlert('birthsAlert', 'success', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
            closeModal('addBirthModal');
            e.target.reset();
            loadBirths();
            loadOverview();
        }

        async function loadInventoryItems() {
            // Load categories
            const { data: categories, error: catError } = await supabase
                .from('inventory_categories')
                .select('id, name')
                .eq('user_id', currentUser.id)
                .order('name');

            if (!catError && categories) {
                inventoryCategories = categories;
            }

            // Load items with category info
            const { data, error } = await supabase
                .from('inventory_items')
                .select('id, name, unit, current_quantity, cost_price, category_id, expiry_date')
                .eq('user_id', currentUser.id)
                .order('name');

            if (!error && data) {
                inventoryItems = data;
                updateFeedCategorySelects();
            }
        }

        function updateFeedCategorySelects() {
            const selects = document.querySelectorAll('select[name="category_id[]"]');
            const options = inventoryCategories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>' + options;
                if (currentValue) select.value = currentValue;
            });
        }

        function loadItemsByCategory(selectElement) {
            const categoryId = selectElement.value;
            const row = selectElement.closest('.feed-item-row');
            const itemSelect = row.querySelector('select[name="item_id[]"]');
            const unitInput = row.querySelector('input[name="unit[]"]');
            const priceInput = row.querySelector('input[name="unit_cost[]"]');
            const stockInfo = row.querySelector('.item-stock-info');

            // Reset
            itemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>';
            unitInput.value = '';
            priceInput.value = '';
            stockInfo.innerHTML = '<i class="fas fa-info-circle"></i> Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­';

            if (!categoryId) return;

            const items = inventoryItems.filter(item => item.category_id === categoryId);
            
            if (items.length === 0) {
                itemSelect.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ</option>';
                return;
            }

            const options = items.map(item => {
                const expiryWarning = item.expiry_date && new Date(item.expiry_date) < new Date() ? ' âš ï¸ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©' : '';
                return `<option value="${item.id}" data-unit="${item.unit}" data-price="${item.cost_price || 0}" data-stock="${item.current_quantity}" data-expiry="${item.expiry_date || ''}">${item.name}${expiryWarning}</option>`;
            }).join('');

            itemSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>' + options;
        }

        function fillItemPrice(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const row = selectElement.closest('.feed-item-row');
            const unitInput = row.querySelector('input[name="unit[]"]');
            const priceInput = row.querySelector('input[name="unit_cost[]"]');
            const stockInfo = row.querySelector('.item-stock-info');

            if (!selectedOption.value) {
                unitInput.value = '';
                priceInput.value = '';
                stockInfo.innerHTML = '<i class="fas fa-info-circle"></i> Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­';
                return;
            }

            const unit = selectedOption.dataset.unit || '';
            const price = selectedOption.dataset.price || 0;
            const stock = selectedOption.dataset.stock || 0;
            const expiry = selectedOption.dataset.expiry || '';

            unitInput.value = unit;
            priceInput.value = parseFloat(price).toFixed(2);

            // Check expiry
            let expiryWarning = '';
            if (expiry) {
                const expiryDate = new Date(expiry);
                const today = new Date();
                if (expiryDate < today) {
                    expiryWarning = ' <span style="color: #dc2626;">âš ï¸ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</span>';
                }
            }

            stockInfo.innerHTML = `
                <i class="fas fa-warehouse"></i> Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­: <strong>${parseFloat(stock).toFixed(2)} ${unit}</strong>${expiryWarning}
            `;

            calculateFeedSummary();
        }

        function updateEndDateMin() {
            const startDate = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate');
            if (startDate) {
                endDateInput.min = startDate;
                if (endDateInput.value && endDateInput.value < startDate) {
                    endDateInput.value = startDate;
                }
            }
            calculateFeedSummary();
        }

        function calculateFeedSummary() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const summary = document.getElementById('feedSummary');

            if (!startDate || !endDate) {
                summary.style.display = 'none';
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            let dailyCost = 0;
            const rows = document.querySelectorAll('.feed-item-row');
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="unit_cost[]"]').value) || 0;
                dailyCost += quantity * price;
            });

            const totalCost = dailyCost * diffDays;

            document.getElementById('totalDays').textContent = diffDays;
            document.getElementById('dailyCost').textContent = dailyCost.toLocaleString() + ' Ø¯';
            document.getElementById('totalCost').textContent = totalCost.toLocaleString() + ' Ø¯';
            summary.style.display = 'block';
        }

        // Listen to quantity and price changes
        document.addEventListener('input', function(e) {
            if (e.target.matches('input[name="quantity[]"]') || e.target.matches('input[name="unit_cost[]"]')) {
                calculateFeedSummary();
            }
        });

        function addFeedItem() {
            const container = document.getElementById('feedItems');
            const div = document.createElement('div');
            div.className = 'feed-item-row';
            div.style.cssText = 'display: grid; gap: 0.8rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 1rem;';
            div.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„ØªØµÙ†ÙŠÙ *</label>
                        <select name="category_id[]" onchange="loadItemsByCategory(this)" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>
                            ${inventoryCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„Ù…Ø§Ø¯Ø© *</label>
                        <select name="item_id[]" onchange="fillItemPrice(this)" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.8rem; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© *</label>
                        <input type="number" name="quantity[]" placeholder="Ù…Ø«Ø§Ù„: 50" step="0.01" min="0.01" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                        <input type="text" name="unit[]" readonly style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; background: #f3f4f6; font-family: 'Cairo', sans-serif;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">Ø§Ù„Ø³Ø¹Ø±/ÙˆØ­Ø¯Ø©</label>
                        <input type="number" name="unit_cost[]" readonly step="0.01" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; background: #f3f4f6; font-family: 'Cairo', sans-serif;">
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="removeFeedItem(this)" style="margin-bottom: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="background: #e0f2fe; padding: 0.5rem; border-radius: 4px; font-size: 0.85rem; color: #075985;">
                    <i class="fas fa-info-circle"></i> <span class="item-stock-info">Ø§Ø®ØªØ± Ù…Ø§Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­</span>
                </div>
            `;
            container.appendChild(div);
        }

        function removeFeedItem(btn) {
            const container = document.getElementById('feedItems');
            if (container.children.length > 1) {
                btn.closest('.feed-item-row').remove();
                calculateFeedSummary();
            } else {
                alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            }
        }

        async function loadFeedLogs() {
            const { data, error } = await supabase
                .from('sheep_feed_logs')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('feed_date', { ascending: false });

            const tbody = document.getElementById('feedingBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØºØ°ÙŠØ©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(log => `
                <tr>
                    <td>${log.feed_date}</td>
                    <td><span class="badge badge-info">${log.animal_count}</span></td>
                    <td><strong>${log.total_cost ? log.total_cost.toLocaleString() + ' Ø¯' : '-'}</strong></td>
                    <td>${log.notes || '-'}</td>
                    <td>
                        <button class="action-btn delete" onclick="deleteFeedLog('${log.id}')">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function addFeedLog(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const startDate = formData.get('start_date');
            const endDate = formData.get('end_date');
            const animalCount = parseInt(formData.get('animal_count'));
            const notes = formData.get('notes');
            
            const itemIds = formData.getAll('item_id[]');
            const quantities = formData.getAll('quantity[]');
            const unitCosts = formData.getAll('unit_cost[]');
            
            // Calculate number of days
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            // Validate and prepare items
            let dailyCost = 0;
            const items = [];
            
            for (let i = 0; i < itemIds.length; i++) {
                const itemId = itemIds[i];
                const quantity = parseFloat(quantities[i]);
                const unitCost = parseFloat(unitCosts[i]);
                const itemTotal = quantity * unitCost;
                
                const item = inventoryItems.find(inv => inv.id === itemId);
                if (!item) {
                    showAlert('feedingAlert', 'error', `Ø§Ù„Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©`);
                    return;
                }
                
                // Check if enough stock for entire period
                const totalNeeded = quantity * totalDays;
                if (item.current_quantity < totalNeeded) {
                    showAlert('feedingAlert', 'error', `Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ù„Ù…Ø§Ø¯Ø© "${item.name}". Ø§Ù„Ù…ØªØ§Ø­: ${item.current_quantity} ${item.unit}ØŒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${totalNeeded.toFixed(2)} ${item.unit}`);
                    return;
                }
                
                // Check expiry date
                if (item.expiry_date) {
                    const expiryDate = new Date(item.expiry_date);
                    const planEndDate = new Date(endDate);
                    if (expiryDate < planEndDate) {
                        if (!confirm(`ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…Ø§Ø¯Ø© "${item.name}" Ø³ØªÙ†ØªÙ‡ÙŠ ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§ ÙÙŠ ${item.expiry_date} Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ ÙØªØ±Ø© Ø§Ù„ØªØºØ°ÙŠØ© (${endDate}). Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) {
                            return;
                        }
                    }
                }
                
                dailyCost += itemTotal;
                items.push({ itemId, itemName: item.name, quantity, unitCost, itemTotal, unit: item.unit });
            }
            
            const totalCost = dailyCost * totalDays;
            
            // Confirm before proceeding
            const confirmMsg = `
                Ù…Ù„Ø®Øµ Ø§Ù„ØªØºØ°ÙŠØ©:
                - Ø§Ù„ÙØªØ±Ø©: Ù…Ù† ${startDate} Ø¥Ù„Ù‰ ${endDate} (${totalDays} ÙŠÙˆÙ…)
                - Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¤ÙˆØ³: ${animalCount}
                - Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©: ${dailyCost.toLocaleString()} Ø¯
                - Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: ${totalCost.toLocaleString()} Ø¯
                
                Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø¯ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ.
                Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ
            `;
            
            if (!confirm(confirmMsg)) return;
            
            // Create main feed log
            const { data: feedLog, error: logError } = await supabase
                .from('sheep_feed_logs')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    feed_date: startDate,
                    animal_count: animalCount,
                    total_cost: totalCost,
                    notes: notes || `ØªØºØ°ÙŠØ© ÙŠÙˆÙ…ÙŠØ© Ù…Ù† ${startDate} Ø¥Ù„Ù‰ ${endDate}`
                })
                .select()
                .single();

            if (logError) {
                showAlert('feedingAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºØ°ÙŠØ©: ' + logError.message);
                return;
            }

            // Create daily records for each day in the period
            let currentDate = new Date(start);
            let successfulDays = 0;
            
            while (currentDate <= end) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // Check if we still have stock for this day
                let canContinue = true;
                
                for (const item of items) {
                    // Get current stock
                    const { data: currentItem } = await supabase
                        .from('inventory_items')
                        .select('current_quantity, expiry_date')
                        .eq('id', item.itemId)
                        .single();
                    
                    if (!currentItem || currentItem.current_quantity < item.quantity) {
                        showAlert('feedingAlert', 'error', `Ù†ÙØ° Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù…Ù† "${item.itemName}" ÙÙŠ ${dateStr}. ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${successfulDays} ÙŠÙˆÙ… Ù…Ù† Ø£ØµÙ„ ${totalDays}.`);
                        canContinue = false;
                        break;
                    }
                    
                    // Check expiry
                    if (currentItem.expiry_date && new Date(currentItem.expiry_date) < new Date(dateStr)) {
                        showAlert('feedingAlert', 'error', `Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© "${item.itemName}" ÙÙŠ ${dateStr}. ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${successfulDays} ÙŠÙˆÙ… Ù…Ù† Ø£ØµÙ„ ${totalDays}.`);
                        canContinue = false;
                        break;
                    }
                }
                
                if (!canContinue) break;
                
                // Process items for this day
                for (const item of items) {
                    // Insert feed detail
                    await supabase.from('sheep_feed_details').insert({
                        feed_log_id: feedLog.id,
                        inventory_item_id: item.itemId,
                        quantity: item.quantity,
                        unit_cost: item.unitCost,
                        total_cost: item.itemTotal
                    });

                    // Create inventory movement (will trigger automatic deduction)
                    await supabase.from('inventory_movements').insert({
                        user_id: currentUser.id,
                        item_id: item.itemId,
                        project_id: currentProject.id,
                        type: 'project_usage',
                        quantity: item.quantity,
                        reference_type: 'sheep_feed_log',
                        reference_id: feedLog.id,
                        notes: `ØªØºØ°ÙŠØ© ÙŠÙˆÙ…ÙŠØ© - ${dateStr}`
                    });
                }

                // Add daily expense
                await supabase.from('expenses').insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    category: 'Ø£Ø¹Ù„Ø§Ù',
                    amount: dailyCost,
                    description: `ØªØºØ°ÙŠØ© ÙŠÙˆÙ…ÙŠØ©: ${notes || 'ØªØºØ°ÙŠØ© Ø§Ù„Ø£ØºÙ†Ø§Ù…'}`,
                    expense_date: dateStr
                });
                
                successfulDays++;
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (successfulDays === totalDays) {
                showAlert('feedingAlert', 'success', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºØ°ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù…Ø¯Ø© ${totalDays} ÙŠÙˆÙ…!`);
            } else {
                showAlert('feedingAlert', 'error', `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${successfulDays} ÙŠÙˆÙ… ÙÙ‚Ø· Ù…Ù† Ø£ØµÙ„ ${totalDays} ÙŠÙˆÙ… Ø¨Ø³Ø¨Ø¨ Ù†ÙØ§Ø° Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø£Ùˆ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.`);
            }
            
            closeModal('addFeedModal');
            e.target.reset();
            document.getElementById('feedSummary').style.display = 'none';
            
            // Reset feed items to one row
            const firstRow = document.querySelector('.feed-item-row');
            document.getElementById('feedItems').innerHTML = '';
            document.getElementById('feedItems').appendChild(firstRow);
            updateFeedCategorySelects();
            
            loadFeedLogs();
            loadInventoryItems();
            loadStats();
        }

        async function deleteFeedLog(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØªØºØ°ÙŠØ©ØŸ')) return;

            const { error } = await supabase
                .from('sheep_feed_logs')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id);

            if (error) {
                showAlert('feedingAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØªØºØ°ÙŠØ©');
                return;
            }

            showAlert('feedingAlert', 'success', 'ØªÙ… Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØªØºØ°ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
            loadFeedLogs();
        }

        async function loadSales() {
            const { data, error } = await supabase
                .from('sheep_sales')
                .select(`
                    *,
                    sheep_animals!inner(tag_number)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('sale_date', { ascending: false });

            const tbody = document.getElementById('salesBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(sale => {
                const statusBadge = sale.payment_status === 'paid' ? 
                    '<span class="badge badge-success">Ù…Ø¯ÙÙˆØ¹</span>' :
                    sale.payment_status === 'partial' ?
                    '<span class="badge badge-warning">Ø¬Ø²Ø¦ÙŠ</span>' :
                    '<span class="badge badge-danger">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</span>';

                return `
                    <tr>
                        <td><strong>${sale.sheep_animals.tag_number}</strong></td>
                        <td>${sale.sale_date}</td>
                        <td><strong>${sale.sale_price.toLocaleString()} Ø¯</strong></td>
                        <td>${sale.customer_name || '-'}</td>
                        <td>${statusBadge}</td>
                        <td><strong>${sale.remaining_amount ? sale.remaining_amount.toLocaleString() + ' Ø¯' : '0 Ø¯'}</strong></td>
                    </tr>
                `;
            }).join('');
        }

        async function addSale(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const animalId = formData.get('animal_id');
            const salePrice = parseFloat(formData.get('sale_price'));
            
            const { data, error } = await supabase
                .from('sheep_sales')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    animal_id: animalId,
                    sale_date: formData.get('sale_date'),
                    sale_price: salePrice,
                    customer_name: formData.get('customer_name') || null,
                    payment_status: formData.get('payment_status'),
                    remaining_amount: parseFloat(formData.get('remaining_amount')) || 0,
                    notes: formData.get('notes') || null
                });

            if (error) {
                showAlert('salesAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹');
                return;
            }

            await supabase
                .from('sheep_animals')
                .update({ status: 'sold' })
                .eq('id', animalId);

            await supabase.from('sales').insert({
                user_id: currentUser.id,
                project_id: currentProject.id,
                type: 'Ø­ÙŠÙˆØ§Ù†',
                quantity: 1,
                unit_price: salePrice,
                total_amount: salePrice,
                customer_name: formData.get('customer_name') || null,
                payment_status: formData.get('payment_status'),
                sale_date: formData.get('sale_date')
            });

            showAlert('salesAlert', 'success', 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­');
            closeModal('addSaleModal');
            e.target.reset();
            loadSales();
            loadHerd();
            loadOverview();
        }

        async function loadDebts() {
            const { data, error } = await supabase
                .from('sheep_eid_debts')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('debtsBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ† Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(debt => {
                const statusBadge = debt.status === 'paid' ? 
                    '<span class="badge badge-success">Ù…Ø¯ÙÙˆØ¹</span>' :
                    debt.status === 'partial' ?
                    '<span class="badge badge-warning">Ø¬Ø²Ø¦ÙŠ</span>' :
                    '<span class="badge badge-danger">Ù…Ø¹Ù„Ù‚</span>';

                return `
                    <tr>
                        <td><strong>${debt.customer_name}</strong></td>
                        <td>${debt.animal_type || '-'}</td>
                        <td>${debt.quantity || '-'}</td>
                        <td><strong>${debt.total_amount.toLocaleString()} Ø¯</strong></td>
                        <td><strong>${debt.paid_amount.toLocaleString()} Ø¯</strong></td>
                        <td><strong style="color: #ef4444;">${debt.remaining_amount.toLocaleString()} Ø¯</strong></td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        async function addDebt(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const { data, error } = await supabase
                .from('sheep_eid_debts')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    customer_name: formData.get('customer_name'),
                    animal_type: formData.get('animal_type') || null,
                    quantity: formData.get('quantity') || null,
                    total_amount: parseFloat(formData.get('total_amount')),
                    paid_amount: parseFloat(formData.get('paid_amount')) || 0,
                    due_date: formData.get('due_date') || null,
                    notes: formData.get('notes') || null
                });

            if (error) {
                showAlert('debtsAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙŠÙ†');
                return;
            }

            showAlert('debtsAlert', 'success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
            closeModal('addDebtModal');
            e.target.reset();
            loadDebts();
        }

        async function loadStats() {
            const { data: expenses } = await supabase
                .from('expenses')
                .select('amount')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id);

            const { data: sales } = await supabase
                .from('sales')
                .select('total_amount')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id);

            const totalExpenses = expenses?.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0) || 0;
            const totalSales = sales?.reduce((sum, s) => sum + (parseFloat(s.total_amount) || 0), 0) || 0;
            const netProfit = totalSales - totalExpenses;

            document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString() + ' Ø¯';
            document.getElementById('totalSales').textContent = totalSales.toLocaleString() + ' Ø¯';
            document.getElementById('netProfit').textContent = (netProfit >= 0 ? '+' : '') + netProfit.toLocaleString() + ' Ø¯';
            document.getElementById('netProfit').style.color = netProfit >= 0 ? '#10b981' : '#ef4444';
        }

        function openAddAnimalModal() {
            document.getElementById('addAnimalModal').classList.add('active');
        }

        function openAddHealthModal() {
            document.getElementById('addHealthModal').classList.add('active');
        }

        function openAddBirthModal() {
            document.getElementById('addBirthModal').classList.add('active');
        }

        function openAddFeedModal() {
            // Set default dates (today to tomorrow)
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = tomorrow;
            document.getElementById('endDate').min = today;
            
            document.getElementById('addFeedModal').classList.add('active');
        }

        function openAddSaleModal() {
            document.getElementById('addSaleModal').classList.add('active');
        }

        function openAddDebtModal() {
            document.getElementById('addDebtModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            container.innerHTML = `<div class="alert ${alertClass}"><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // =================== EMPLOYEES FUNCTIONS ===================
        
        async function loadEmployees() {
            // Load all employees for selection
            const { data: employees, error: empError } = await supabase
                .from('employees')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('status', 'active')
                .order('name');

            if (!empError && employees) {
                allEmployees = employees;
                updateEmployeeSelects();
            }

            // Load project employees
            const { data: projEmployees, error: projError } = await supabase
                .from('project_employees')
                .select(`
                    *,
                    employees!inner(name, phone, position)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('employeesBody');
            
            if (projError || !projEmployees || projEmployees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø±ØªØ¨Ø·ÙŠÙ† Ø¨Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</td></tr>';
                projectEmployees = [];
                return;
            }

            projectEmployees = projEmployees;

            tbody.innerHTML = projEmployees.map(emp => {
                const salaryTypeText = {
                    'fixed': 'Ø«Ø§Ø¨Øª (Ø´Ù‡Ø±ÙŠ)',
                    'daily': 'ÙŠÙˆÙ…ÙŠ',
                    'hourly': 'Ø³Ø§Ø¹ÙŠ',
                    'percentage': 'Ù†Ø³Ø¨Ø©'
                }[emp.salary_type] || emp.salary_type;

                const statusBadge = emp.status === 'active' ? 
                    '<span class="badge badge-success">Ù†Ø´Ø·</span>' : 
                    '<span class="badge badge-danger">Ù…ØªÙˆÙ‚Ù</span>';

                const tasks = emp.assigned_tasks ? (Array.isArray(emp.assigned_tasks) ? emp.assigned_tasks.join(', ') : emp.assigned_tasks) : '-';

                return `
                    <tr>
                        <td><strong>${emp.employees.name}</strong><br><small style="color: #6b7280;">${emp.employees.position || ''}</small></td>
                        <td>${tasks}</td>
                        <td>${salaryTypeText}</td>
                        <td><strong>${emp.salary_amount ? emp.salary_amount.toLocaleString() + ' Ø¯' : '-'}</strong></td>
                        <td>${emp.start_date || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn delete" onclick="removeProjectEmployee('${emp.id}')">
                                <i class="fas fa-times"></i> Ø¥Ø²Ø§Ù„Ø©
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateEmployeeSelects() {
            const employeeSelect = document.getElementById('employeeSelect');
            const expenseEmployeeSelect = document.getElementById('expenseEmployeeSelect');

            const options = allEmployees.map(emp => 
                `<option value="${emp.id}" data-salary-type="${emp.salary_type}" data-salary-amount="${emp.salary_amount}">${emp.name} - ${emp.position || 'Ù…ÙˆØ¸Ù'}</option>`
            ).join('');

            if (employeeSelect) {
                employeeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù</option>' + options;
            }

            if (expenseEmployeeSelect) {
                expenseEmployeeSelect.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>' + options;
            }
        }

        function fillEmployeeDefaults(select) {
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption.value) return;

            const salaryType = selectedOption.dataset.salaryType;
            const salaryAmount = selectedOption.dataset.salaryAmount;

            document.getElementById('salaryTypeSelect').value = salaryType || 'fixed';
            document.querySelector('input[name="salary_amount"]').value = salaryAmount || '';
            toggleSalaryInfo();
        }

        function toggleSalaryInfo() {
            const salaryType = document.getElementById('salaryTypeSelect').value;
            const hint = document.getElementById('salaryHint');
            
            const hints = {
                'fixed': 'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¬Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø±',
                'daily': 'Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¬Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ©',
                'hourly': 'Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¬Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ©',
                'percentage': 'Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¬Ø± ÙƒÙ†Ø³Ø¨Ø© Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª'
            };

            hint.textContent = hints[salaryType] || '';
        }

        async function addProjectEmployee(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const tasksInput = formData.get('assigned_tasks');
            const tasks = tasksInput ? tasksInput.split(',').map(t => t.trim()) : [];

            const { data, error } = await supabase
                .from('project_employees')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    employee_id: formData.get('employee_id'),
                    start_date: formData.get('start_date'),
                    salary_type: formData.get('salary_type'),
                    salary_amount: parseFloat(formData.get('salary_amount')),
                    assigned_tasks: tasks,
                    notes: formData.get('notes') || null,
                    status: 'active'
                });

            if (error) {
                showAlert('employeesAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù: ' + error.message);
                return;
            }

            // If salary is fixed (monthly), create initial expense
            const salaryType = formData.get('salary_type');
            if (salaryType === 'fixed') {
                const startDate = formData.get('start_date');
                const amount = parseFloat(formData.get('salary_amount'));
                const employeeName = document.getElementById('employeeSelect').selectedOptions[0].text;

                await supabase.from('expenses').insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    employee_id: formData.get('employee_id'),
                    category: 'Ø±ÙˆØ§ØªØ¨',
                    amount: amount,
                    description: `Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ: ${employeeName}`,
                    expense_date: startDate,
                    payment_method: 'Ù†Ù‚Ø¯ÙŠ'
                });
            }

            showAlert('employeesAlert', 'success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
            closeModal('addProjectEmployeeModal');
            e.target.reset();
            loadEmployees();
            loadExpenses();
        }

        async function removeProjectEmployee(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ')) return;

            const { error } = await supabase
                .from('project_employees')
                .update({ status: 'inactive', end_date: new Date().toISOString().split('T')[0] })
                .eq('id', id)
                .eq('user_id', currentUser.id);

            if (error) {
                showAlert('employeesAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù');
                return;
            }

            showAlert('employeesAlert', 'success', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
            loadEmployees();
        }

        function openAddProjectEmployeeModal() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#addProjectEmployeeForm input[name="start_date"]').value = today;
            document.getElementById('addProjectEmployeeModal').classList.add('active');
        }

        // =================== EXPENSES FUNCTIONS ===================

        async function loadExpenses() {
            const { data, error } = await supabase
                .from('expenses')
                .select(`
                    *,
                    employees(name)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('expense_date', { ascending: false });

            const tbody = document.getElementById('expensesBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                updateExpenseSummary([]);
                return;
            }

            tbody.innerHTML = data.map(expense => {
                const categoryBadges = {
                    'Ø£Ø¹Ù„Ø§Ù': 'badge-warning',
                    'Ø±ÙˆØ§ØªØ¨': 'badge-info',
                    'Ø£Ø¯ÙˆÙŠØ©': 'badge-danger',
                    'ØµÙŠØ§Ù†Ø©': 'badge-secondary',
                    'ØªØ¹Ù‚ÙŠÙ…': 'badge-info'
                };

                const badgeClass = categoryBadges[expense.category] || 'badge-secondary';
                
                return `
                    <tr>
                        <td>${expense.expense_date}</td>
                        <td><span class="badge ${badgeClass}">${expense.category}</span></td>
                        <td><strong>${expense.amount.toLocaleString()} Ø¯</strong></td>
                        <td>${expense.employees ? expense.employees.name : '-'}</td>
                        <td>${expense.description || '-'}</td>
                        <td>
                            <button class="action-btn delete" onclick="deleteExpense('${expense.id}')">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateExpenseSummary(data);
        }

        function updateExpenseSummary(expenses) {
            const categories = {
                'Ø£Ø¹Ù„Ø§Ù': 0,
                'Ø±ÙˆØ§ØªØ¨': 0,
                'Ø£Ø¯ÙˆÙŠØ©': 0,
                'ØµÙŠØ§Ù†Ø©': 0
            };

            let otherTotal = 0;

            expenses.forEach(expense => {
                const amount = parseFloat(expense.amount) || 0;
                if (categories.hasOwnProperty(expense.category)) {
                    categories[expense.category] += amount;
                } else {
                    otherTotal += amount;
                }
            });

            document.getElementById('feedExpenses').textContent = categories['Ø£Ø¹Ù„Ø§Ù'].toLocaleString() + ' Ø¯';
            document.getElementById('salaryExpenses').textContent = categories['Ø±ÙˆØ§ØªØ¨'].toLocaleString() + ' Ø¯';
            document.getElementById('medicineExpenses').textContent = categories['Ø£Ø¯ÙˆÙŠØ©'].toLocaleString() + ' Ø¯';
            document.getElementById('maintenanceExpenses').textContent = categories['ØµÙŠØ§Ù†Ø©'].toLocaleString() + ' Ø¯';
            document.getElementById('otherExpenses').textContent = otherTotal.toLocaleString() + ' Ø¯';
        }

        async function addExpense(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const employeeId = formData.get('employee_id') || null;

            const { data, error } = await supabase
                .from('expenses')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    category: formData.get('category'),
                    amount: parseFloat(formData.get('amount')),
                    description: formData.get('description') || null,
                    employee_id: employeeId,
                    payment_method: formData.get('payment_method') || null,
                    expense_date: formData.get('expense_date')
                });

            if (error) {
                showAlert('expensesAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + error.message);
                return;
            }

            showAlert('expensesAlert', 'success', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­');
            closeModal('addExpenseModal');
            e.target.reset();
            loadExpenses();
            loadStats();
        }

        async function deleteExpense(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;

            const { error } = await supabase
                .from('expenses')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id);

            if (error) {
                showAlert('expensesAlert', 'error', 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ');
                return;
            }

            showAlert('expensesAlert', 'success', 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­');
            loadExpenses();
            loadStats();
        }

        function openAddExpenseModal() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#addExpenseForm input[name="expense_date"]').value = today;
            document.getElementById('addExpenseModal').classList.add('active');
        }

        async function init() {
            if (await checkAuth()) {
                await loadProject();
                await checkAndAddMonthlySalaries(); // Check for monthly salaries
                await loadOverview();
                await loadHerd();
                await loadHealthRecords();
                await loadBirths();
                await loadInventoryItems();
                await loadFeedLogs();
                await loadEmployees();
                await loadExpenses();
                await loadSales();
                await loadDebts();
                await loadStats();
            }
        }

        // =================== AUTO MONTHLY SALARY ===================
        
        async function checkAndAddMonthlySalaries() {
            // Get current month and year
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentYear = now.getFullYear();
            const firstDayOfMonth = `${currentYear}-${String(currentMonth).padStart(2, '0')}-01`;

            // Get active employees with fixed salary
            const { data: employees, error } = await supabase
                .from('project_employees')
                .select(`
                    *,
                    employees!inner(name)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .eq('status', 'active')
                .eq('salary_type', 'fixed');

            if (error || !employees || employees.length === 0) return;

            for (const emp of employees) {
                // Check if salary for this month already exists
                const { data: existingSalary } = await supabase
                    .from('expenses')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('project_id', currentProject.id)
                    .eq('employee_id', emp.employee_id)
                    .eq('category', 'Ø±ÙˆØ§ØªØ¨')
                    .gte('expense_date', firstDayOfMonth)
                    .lt('expense_date', `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-01`);

                // If no salary for this month, add it
                if (!existingSalary || existingSalary.length === 0) {
                    await supabase.from('expenses').insert({
                        user_id: currentUser.id,
                        project_id: currentProject.id,
                        employee_id: emp.employee_id,
                        category: 'Ø±ÙˆØ§ØªØ¨',
                        amount: emp.salary_amount,
                        description: `Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ: ${emp.employees.name} - ${currentMonth}/${currentYear}`,
                        expense_date: firstDayOfMonth,
                        payment_method: 'Ù†Ù‚Ø¯ÙŠ'
                    });
                }
            }
        }

        init();
    </script>
</body>
</html>
