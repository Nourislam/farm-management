<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêë ŸÖÿ¥ÿ±Ÿàÿπ ÿ™ÿ±ÿ®Ÿäÿ© ÿßŸÑÿ£ÿ∫ŸÜÿßŸÖ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #f5f7fa;
            direction: rtl;
        }

        /* Navbar */
        .navbar {
            background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            color: white;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            flex-shrink: 0;
        }

        .stat-icon.ewes {
            background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
            color: white;
        }

        .stat-icon.lambs {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .stat-icon.rams {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .stat-icon.total {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .stat-content {
            flex: 1;
        }

        .stat-content h3 {
            color: #6b7280;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .stat-content .value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d5016;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .tab:hover {
            color: #4a7c2a;
            background: rgba(74, 124, 42, 0.05);
        }

        .tab.active {
            color: #4a7c2a;
            border-bottom-color: #4a7c2a;
            background: rgba(74, 124, 42, 0.05);
        }

        /* Section */
        .section {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-header h2 {
            color: #2d5016;
            font-size: 1.3rem;
            font-weight: 700;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a7c2a 0%, #2d5016 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(74, 124, 42, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 124, 42, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            color: #374151;
            font-weight: 700;
            font-size: 0.9rem;
        }

        tbody tr {
            transition: all 0.2s;
        }

        tbody tr:hover {
            background: #f9fafb;
            transform: translateX(-2px);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        /* Action Buttons */
        .action-btn {
            padding: 0.4rem 0.8rem;
            margin: 0 0.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
        }

        .action-btn.delete {
            background: #ef4444;
            color: white;
        }

        .action-btn.delete:hover {
            background: #dc2626;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: #2d5016;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #ef4444;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.3rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4a7c2a;
            box-shadow: 0 0 0 3px rgba(74, 124, 42, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Feed Items */
        .feed-items {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .feed-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        /* Loading & Empty States */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #9ca3af;
        }

        /* Stats Section */
        .stats-section {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .financial-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .financial-card {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            text-align: center;
            transition: all 0.3s;
        }

        .financial-card:hover {
            border-color: #4a7c2a;
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .financial-card h3 {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .financial-card .amount {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .financial-card.expenses .amount {
            color: #ef4444;
        }

        .financial-card.sales .amount {
            color: #10b981;
        }

        .financial-card.profit .amount {
            color: #3b82f6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 0.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }

            .navbar {
                padding: 1rem;
            }

            .navbar h1 {
                font-size: 1.2rem;
            }

            .tabs {
                overflow-x: scroll;
            }

            .feed-item {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <h1><i class="fas fa-sheep"></i> ŸÖÿ¥ÿ±Ÿàÿπ ÿ™ÿ±ÿ®Ÿäÿ© ÿßŸÑÿ£ÿ∫ŸÜÿßŸÖ</h1>
        <button class="back-btn" onclick="window.location.href='index.html'">
            <i class="fas fa-arrow-right"></i> ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        </button>
    </nav>

    <!-- Container -->
    <div class="container">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon ewes">
                    <i class="fas fa-venus"></i>
                </div>
                <div class="stat-content">
                    <h3>ÿßŸÑŸÜÿπÿßÿ¨</h3>
                    <div class="value" id="ewesCount">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon lambs">
                    <i class="fas fa-baby"></i>
                </div>
                <div class="stat-content">
                    <h3>ÿßŸÑÿ≠ŸÖŸÑÿßŸÜ</h3>
                    <div class="value" id="lambsCount">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon rams">
                    <i class="fas fa-mars"></i>
                </div>
                <div class="stat-content">
                    <h3>ÿßŸÑŸÉÿ®ÿßÿ¥</h3>
                    <div class="value" id="ramsCount">0</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon total">
                    <i class="fas fa-list-ol"></i>
                </div>
                <div class="stat-content">
                    <h3>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</h3>
                    <div class="value" id="totalCount">0</div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('herd')">
                <i class="fas fa-sheep"></i> ÿßŸÑŸÇÿ∑Ÿäÿπ
            </button>
            <button class="tab" onclick="showTab('health')">
                <i class="fas fa-syringe"></i> ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿµÿ≠Ÿäÿ©
            </button>
            <button class="tab" onclick="showTab('births')">
                <i class="fas fa-baby-carriage"></i> ÿßŸÑŸàŸÑÿßÿØÿßÿ™
            </button>
            <button class="tab" onclick="showTab('feeding')">
                <i class="fas fa-wheat-awn"></i> ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©
            </button>
            <button class="tab" onclick="showTab('employees')">
                <i class="fas fa-users"></i> ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ
            </button>
            <button class="tab" onclick="showTab('expenses')">
                <i class="fas fa-receipt"></i> ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™
            </button>
            <button class="tab" onclick="showTab('sales')">
                <i class="fas fa-money-bill-wave"></i> ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™
            </button>
            <button class="tab" onclick="showTab('debts')">
                <i class="fas fa-file-invoice-dollar"></i> ÿØŸäŸàŸÜ ÿßŸÑÿπŸäÿØ
            </button>
        </div>

        <!-- Herd Section -->
        <div id="herd" class="section active">
            <div class="section-header">
                <h2><i class="fas fa-sheep"></i> ÿßŸÑŸÇÿ∑Ÿäÿπ</h2>
                <button class="btn btn-primary" onclick="openAddAnimalModal()">
                    <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ŸäŸàÿßŸÜ
                </button>
            </div>
            <div id="herdAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿ±ŸÇŸÖ ÿßŸÑÿπŸÑÿßŸÖÿ©</th>
                            <th>ÿßŸÑŸÜŸàÿπ</th>
                            <th>ÿßŸÑÿ¨ŸÜÿ≥</th>
                            <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ</th>
                            <th>ÿßŸÑÿπŸÖÿ±</th>
                            <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                            <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="herdBody">
                        <tr><td colspan="7" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Health Section -->
        <div id="health" class="section">
            <div class="section-header">
                <h2><i class="fas fa-syringe"></i> ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿµÿ≠Ÿäÿ©</h2>
                <button class="btn btn-primary" onclick="openAddHealthModal()">
                    <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ¨ŸÑ ÿµÿ≠Ÿä
                </button>
            </div>
            <div id="healthAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿ±ŸÇŸÖ ÿßŸÑÿπŸÑÿßŸÖÿ©</th>
                            <th>ÿßŸÑŸÜŸàÿπ</th>
                            <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                            <th>ÿßŸÑŸàÿµŸÅ</th>
                            <th>ÿßŸÑÿØŸàÿßÿ°</th>
                            <th>ÿßŸÑÿ™ŸÉŸÑŸÅÿ©</th>
                            <th>ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÇÿßÿØŸÖ</th>
                        </tr>
                    </thead>
                    <tbody id="healthBody">
                        <tr><td colspan="7" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Births Section -->
        <div id="births" class="section">
            <div class="section-header">
                <h2><i class="fas fa-baby-carriage"></i> ÿßŸÑŸàŸÑÿßÿØÿßÿ™</h2>
                <button class="btn btn-primary" onclick="openAddBirthModal()">
                    <i class="fas fa-plus"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ŸàŸÑÿßÿØÿ©
                </button>
            </div>
            <div id="birthsAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿßŸÑÿ£ŸÖ</th>
                            <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÑÿßÿØÿ©</th>
                            <th>ÿπÿØÿØ ÿßŸÑÿ≠ŸÖŸÑÿßŸÜ</th>
                            <th>ÿßŸÑÿ£ÿ≠Ÿäÿßÿ°</th>
                            <th>ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="birthsBody">
                        <tr><td colspan="5" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Feeding Section -->
        <div id="feeding" class="section">
            <div class="section-header">
                <h2><i class="fas fa-wheat-awn"></i> ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©</h2>
                <button class="btn btn-primary" onclick="openAddFeedModal()">
                    <i class="fas fa-plus"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ™ÿ∫ÿ∞Ÿäÿ©
                </button>
            </div>
            <div id="feedingAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©</th>
                            <th>ÿπÿØÿØ ÿßŸÑÿ±ÿ§Ÿàÿ≥</th>
                            <th>ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©</th>
                            <th>ÿßŸÑŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</th>
                            <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="feedingBody">
                        <tr><td colspan="5" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Employees Section -->
        <div id="employees" class="section">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ŸäŸÜ ÿ®ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</h2>
                <button class="btn btn-primary" onclick="openAddProjectEmployeeModal()">
                    <i class="fas fa-user-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ
                </button>
            </div>
            <div id="employeesAlert"></div>
            
            <!-- Auto Salary Info -->
            <div style="background: #dbeafe; border: 2px solid #3b82f6; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; color: #1e40af; margin-bottom: 0.5rem;">
                    <i class="fas fa-info-circle"></i>
                    <strong>ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ±Ÿàÿßÿ™ÿ® ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä</strong>
                </div>
                <p style="color: #1e40af; font-size: 0.9rem; margin: 0;">
                    ÿßŸÑŸÖŸàÿ∏ŸÅŸàŸÜ ÿ®ÿ£ÿ¨ÿ± <strong>ÿ´ÿßÿ®ÿ™ (ÿ¥Ÿáÿ±Ÿä)</strong> ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ±Ÿàÿßÿ™ÿ®ŸáŸÖ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä ÿ®ÿØÿßŸäÿ© ŸÉŸÑ ÿ¥Ÿáÿ± ÿ•ŸÑŸâ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ. 
                    ÿßŸÑÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ£ÿÆÿ±Ÿâ (ŸäŸàŸÖŸäÿå ÿ≥ÿßÿπŸäÿå ŸÜÿ≥ÿ®ÿ©) Ÿäÿ¨ÿ® ÿ™ÿ≥ÿ¨ŸäŸÑŸáÿß ŸäÿØŸàŸäÿßŸã ŸÅŸä ŸÇÿ≥ŸÖ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ.
                </p>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿßŸÑÿßÿ≥ŸÖ</th>
                            <th>ÿßŸÑŸÖŸáÿßŸÖ</th>
                            <th>ŸÜŸàÿπ ÿßŸÑÿ£ÿ¨ÿ±</th>
                            <th>ŸÇŸäŸÖÿ© ÿßŸÑÿ£ÿ¨ÿ±</th>
                            <th>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ©</th>
                            <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                            <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="employeesBody">
                        <tr><td colspan="7" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Expenses Section -->
        <div id="expenses" class="section">
            <div class="section-header">
                <h2><i class="fas fa-receipt"></i> ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ŸàÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©</h2>
                <button class="btn btn-primary" onclick="openAddExpenseModal()">
                    <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ
                </button>
            </div>
            <div id="expensesAlert"></div>
            
            <!-- Financial Stats Overview -->
            <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 2px solid #e5e7eb; margin-bottom: 2rem;">
                <h3 style="color: #2d5016; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-line"></i> ŸÖŸÑÿÆÿµ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©
                </h3>
                <div class="financial-overview">
                    <div class="financial-card expenses">
                        <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ</h3>
                        <div class="amount" id="totalExpenses">0 ÿØ</div>
                    </div>
                    <div class="financial-card sales">
                        <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</h3>
                        <div class="amount" id="totalSales">0 ÿØ</div>
                    </div>
                    <div class="financial-card profit">
                        <h3>ÿµÿßŸÅŸä ÿßŸÑÿ±ÿ®ÿ≠/ÿßŸÑÿÆÿ≥ÿßÿ±ÿ©</h3>
                        <div class="amount" id="netProfit">0 ÿØ</div>
                    </div>
                </div>
            </div>

            <!-- Expense Categories Summary -->
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #2d5016; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-chart-pie"></i> ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿ≠ÿ≥ÿ® ÿßŸÑŸÅÿ¶ÿ©
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #92400e; margin-bottom: 0.3rem;">üåæ ÿ£ÿπŸÑÿßŸÅ</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #92400e;" id="feedExpenses">0 ÿØ</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #1e40af; margin-bottom: 0.3rem;">üë• ÿ±Ÿàÿßÿ™ÿ®</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #1e40af;" id="salaryExpenses">0 ÿØ</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #991b1b; margin-bottom: 0.3rem;">üíä ÿ£ÿØŸàŸäÿ©</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #991b1b;" id="medicineExpenses">0 ÿØ</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #3730a3; margin-bottom: 0.3rem;">üîß ÿµŸäÿßŸÜÿ©</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #3730a3;" id="maintenanceExpenses">0 ÿØ</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 0.85rem; color: #6b21a8; margin-bottom: 0.3rem;">üì¶ ÿ£ÿÆÿ±Ÿâ</div>
                        <div style="font-size: 1.3rem; font-weight: 700; color: #6b21a8;" id="otherExpenses">0 ÿØ</div>
                    </div>
                </div>
            </div>

            <!-- Expenses Table -->
            <h3 style="color: #2d5016; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-list"></i> ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿ™ŸÅÿµŸäŸÑŸä
            </h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                            <th>ÿßŸÑŸÅÿ¶ÿ©</th>
                            <th>ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                            <th>ÿßŸÑŸÖŸàÿ∏ŸÅ</th>
                            <th>ÿßŸÑŸàÿµŸÅ</th>
                            <th>ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</th>
                            <th>ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                    </thead>
                    <tbody id="expensesBody">
                        <tr><td colspan="7" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sales Section -->
        <div id="sales" class="section">
            <div class="section-header">
                <h2><i class="fas fa-money-bill-wave"></i> ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</h2>
                <button class="btn btn-primary" onclick="openAddSaleModal()">
                    <i class="fas fa-plus"></i> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®Ÿäÿπ
                </button>
            </div>
            <div id="salesAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿ±ŸÇŸÖ ÿßŸÑÿπŸÑÿßŸÖÿ©</th>
                            <th>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ</th>
                            <th>ÿßŸÑÿ≥ÿπÿ±</th>
                            <th>ÿßŸÑÿπŸÖŸäŸÑ</th>
                            <th>ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ</th>
                            <th>ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</th>
                        </tr>
                    </thead>
                    <tbody id="salesBody">
                        <tr><td colspan="6" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Debts Section -->
        <div id="debts" class="section">
            <div class="section-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> ÿØŸäŸàŸÜ ÿßŸÑÿπŸäÿØ</h2>
                <button class="btn btn-primary" onclick="openAddDebtModal()">
                    <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸÜ
                </button>
            </div>
            <div id="debtsAlert"></div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</th>
                            <th>ÿßŸÑŸÜŸàÿπ</th>
                            <th>ÿßŸÑŸÉŸÖŸäÿ©</th>
                            <th>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÉŸÑŸä</th>
                            <th>ÿßŸÑŸÖÿØŸÅŸàÿπ</th>
                            <th>ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</th>
                            <th>ÿßŸÑÿ≠ÿßŸÑÿ©</th>
                        </tr>
                    </thead>
                    <tbody id="debtsBody">
                        <tr><td colspan="7" class="loading">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Stats Section -->
        <div id="stats" class="section">
            <div class="section-header">
                <h2><i class="fas fa-chart-line"></i> ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©</h2>
            </div>
            <div class="financial-overview">
                <div class="financial-card expenses">
                    <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿµÿßÿ±ŸäŸÅ</h3>
                    <div class="amount" id="totalExpenses">0 ÿØ</div>
                </div>
                <div class="financial-card sales">
                    <h3>ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</h3>
                    <div class="amount" id="totalSales">0 ÿØ</div>
                </div>
                <div class="financial-card profit">
                    <h3>ÿµÿßŸÅŸä ÿßŸÑÿ±ÿ®ÿ≠/ÿßŸÑÿÆÿ≥ÿßÿ±ÿ©</h3>
                    <div class="amount" id="netProfit">0 ÿØ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Animal Modal -->
    <div id="addAnimalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ŸäŸàÿßŸÜ ÿ¨ÿØŸäÿØ</h3>
                <button class="close-btn" onclick="closeModal('addAnimalModal')">&times;</button>
            </div>
            <form id="addAnimalForm" onsubmit="addAnimal(event)">
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ ÿßŸÑÿπŸÑÿßŸÖÿ© *</label>
                    <input type="text" name="tag_number" required>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÜŸàÿπ *</label>
                    <select name="type" required>
                        <option value="ewe">ŸÜÿπÿ¨ÿ©</option>
                        <option value="ram">ŸÉÿ®ÿ¥</option>
                        <option value="lamb">ÿ≠ŸÖŸÑ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ¨ŸÜÿ≥ *</label>
                    <select name="sex" required>
                        <option value="F">ÿ£ŸÜÿ´Ÿâ</option>
                        <option value="M">ÿ∞ŸÉÿ±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÖŸäŸÑÿßÿØ</label>
                    <input type="date" name="birth_date">
                </div>
                <div class="form-group">
                    <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ¥ÿ±ÿßÿ°</label>
                    <input type="date" name="purchase_date">
                </div>
                <div class="form-group">
                    <label>ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°</label>
                    <input type="number" name="purchase_price" step="0.01">
                </div>
                <div class="form-group">
                    <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ÿ≠ŸÅÿ∏</button>
            </form>
        </div>
    </div>

    <!-- Add Health Modal -->
    <div id="addHealthModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ¨ŸÑ ÿµÿ≠Ÿä</h3>
                <button class="close-btn" onclick="closeModal('addHealthModal')">&times;</button>
            </div>
            <form id="addHealthForm" onsubmit="addHealthRecord(event)">
                <div class="form-group">
                    <label>ÿßŸÑÿ≠ŸäŸàÿßŸÜ *</label>
                    <select name="animal_id" id="healthAnimalSelect" required>
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ≠ŸäŸàÿßŸÜ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÜŸàÿπ *</label>
                    <select name="record_type" required>
                        <option value="vaccination">ÿ™ÿ∑ÿπŸäŸÖ</option>
                        <option value="treatment">ÿπŸÑÿßÿ¨</option>
                        <option value="checkup">ŸÅÿ≠ÿµ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ™ÿßÿ±ŸäÿÆ *</label>
                    <input type="date" name="record_date" required>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸàÿµŸÅ</label>
                    <textarea name="description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿØŸàÿßÿ°</label>
                    <input type="text" name="medication">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ¨ÿ±ÿπÿ©</label>
                    <input type="text" name="dosage">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ™ŸÉŸÑŸÅÿ©</label>
                    <input type="number" name="cost" step="0.01">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÖŸàÿπÿØ ÿßŸÑŸÇÿßÿØŸÖ</label>
                    <input type="date" name="next_due_date">
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ÿ≠ŸÅÿ∏</button>
            </form>
        </div>
    </div>

    <!-- Add Birth Modal -->
    <div id="addBirthModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÿ™ÿ≥ÿ¨ŸäŸÑ ŸàŸÑÿßÿØÿ© ÿ¨ÿØŸäÿØÿ©</h3>
                <button class="close-btn" onclick="closeModal('addBirthModal')">&times;</button>
            </div>
            <form id="addBirthForm" onsubmit="addBirth(event)">
                <div class="form-group">
                    <label>ÿßŸÑÿ£ŸÖ *</label>
                    <select name="mother_id" id="birthMotherSelect" required>
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ£ŸÖ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸàŸÑÿßÿØÿ© *</label>
                    <input type="date" name="birth_date" required>
                </div>
                <div class="form-group">
                    <label>ÿπÿØÿØ ÿßŸÑÿ≠ŸÖŸÑÿßŸÜ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä *</label>
                    <input type="number" name="total_lambs" min="1" required>
                </div>
                <div class="form-group">
                    <label>ÿπÿØÿØ ÿßŸÑÿ≠ŸÖŸÑÿßŸÜ ÿßŸÑÿ£ÿ≠Ÿäÿßÿ° *</label>
                    <input type="number" name="live_lambs" min="0" required>
                </div>
                <div class="form-group">
                    <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ÿ≠ŸÅÿ∏</button>
            </form>
        </div>
    </div>

    <!-- Add Feed Modal -->
    <div id="addFeedModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ™ÿ∫ÿ∞Ÿäÿ©</h3>
                <button class="close-btn" onclick="closeModal('addFeedModal')">&times;</button>
            </div>
            <form id="addFeedForm" onsubmit="addFeedLog(event)">
                <div class="form-group">
                    <label><i class="fas fa-sheep"></i> ÿπÿØÿØ ÿßŸÑÿ±ÿ§Ÿàÿ≥ *</label>
                    <input type="number" name="animal_count" min="1" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label><i class="fas fa-calendar-alt"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© *</label>
                        <input type="date" name="start_date" id="startDate" required onchange="updateEndDateMin()">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calendar-check"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÜŸáÿßŸäÿ© *</label>
                        <input type="date" name="end_date" id="endDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                    <textarea name="notes" rows="2"></textarea>
                </div>
                <hr style="margin: 1.5rem 0; border: none; border-top: 2px solid #e5e7eb;">
                <h4 style="color: #2d5016; margin-bottom: 1rem;">
                    <i class="fas fa-boxes"></i> ÿßŸÑŸÖŸàÿßÿØ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© (ŸäŸàŸÖŸäÿßŸã)
                </h4>
                <div id="feedItems">
                    <div class="feed-item-row" style="display: grid; gap: 0.8rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑÿ™ÿµŸÜŸäŸÅ *</label>
                                <select name="category_id[]" onchange="loadItemsByCategory(this)" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                                    <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑŸÖÿßÿØÿ© *</label>
                                <select name="item_id[]" onchange="fillItemPrice(this)" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                                    <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ©</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.8rem; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸäŸàŸÖŸäÿ© *</label>
                                <input type="number" name="quantity[]" placeholder="ŸÖÿ´ÿßŸÑ: 50" step="0.01" min="0.01" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑŸàÿ≠ÿØÿ©</label>
                                <input type="text" name="unit[]" readonly style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; background: #f3f4f6; font-family: 'Cairo', sans-serif;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑÿ≥ÿπÿ±/Ÿàÿ≠ÿØÿ©</label>
                                <input type="number" name="unit_cost[]" readonly step="0.01" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; background: #f3f4f6; font-family: 'Cairo', sans-serif;">
                            </div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="removeFeedItem(this)" style="margin-bottom: 0;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div style="background: #e0f2fe; padding: 0.5rem; border-radius: 4px; font-size: 0.85rem; color: #075985;">
                            <i class="fas fa-info-circle"></i> <span class="item-stock-info">ÿßÿÆÿ™ÿ± ŸÖÿßÿØÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖÿ™ÿßÿ≠</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addFeedItem()" style="width: 100%; margin-bottom: 1rem;">
                    <i class="fas fa-plus"></i> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿßÿØÿ© ÿ£ÿÆÿ±Ÿâ
                </button>
                <div id="feedSummary" style="background: #f0fdf4; border: 2px solid #86efac; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none;">
                    <h4 style="color: #166534; margin-bottom: 0.5rem;"><i class="fas fa-calculator"></i> ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸÉŸÑŸÅÿ©</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem; color: #166534;">
                        <div>ÿπÿØÿØ ÿßŸÑÿ£ŸäÿßŸÖ: <strong id="totalDays">0</strong></div>
                        <div>ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑŸäŸàŸÖŸäÿ©: <strong id="dailyCost">0 ÿØ</strong></div>
                        <div style="grid-column: 1 / -1; font-size: 1.1rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #86efac;">
                            ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©: <strong id="totalCost">0 ÿØ</strong>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏ Ÿàÿ®ÿØÿ° ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©
                </button>
            </form>
        </div>
    </div>

    <!-- Add Sale Modal -->
    <div id="addSaleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®Ÿäÿπ</h3>
                <button class="close-btn" onclick="closeModal('addSaleModal')">&times;</button>
            </div>
            <form id="addSaleForm" onsubmit="addSale(event)">
                <div class="form-group">
                    <label>ÿßŸÑÿ≠ŸäŸàÿßŸÜ *</label>
                    <select name="animal_id" id="saleAnimalSelect" required>
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ≠ŸäŸàÿßŸÜ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®Ÿäÿπ *</label>
                    <input type="date" name="sale_date" required>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ≥ÿπÿ± *</label>
                    <input type="number" name="sale_price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</label>
                    <input type="text" name="customer_name">
                </div>
                <div class="form-group">
                    <label>ÿ≠ÿßŸÑÿ© ÿßŸÑÿØŸÅÿπ *</label>
                    <select name="payment_status" required>
                        <option value="paid">ŸÖÿØŸÅŸàÿπ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ</option>
                        <option value="partial">ŸÖÿØŸÅŸàÿπ ÿ¨ÿ≤ÿ¶ŸäÿßŸã</option>
                        <option value="pending">ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿ™ÿ®ŸÇŸä</label>
                    <input type="number" name="remaining_amount" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ÿ≠ŸÅÿ∏</button>
            </form>
        </div>
    </div>

    <!-- Add Debt Modal -->
    <div id="addDebtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÿ•ÿ∂ÿßŸÅÿ© ÿØŸäŸÜ ÿπŸäÿØ</h3>
                <button class="close-btn" onclick="closeModal('addDebtModal')">&times;</button>
            </div>
            <form id="addDebtForm" onsubmit="addDebt(event)">
                <div class="form-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ *</label>
                    <input type="text" name="customer_name" required>
                </div>
                <div class="form-group">
                    <label>ŸÜŸàÿπ ÿßŸÑÿ≠ŸäŸàÿßŸÜ</label>
                    <input type="text" name="animal_type" placeholder="ŸÖÿ´ÿßŸÑ: ŸÉÿ®ÿ¥ÿå ŸÜÿπÿ¨ÿ©">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÉŸÖŸäÿ©</label>
                    <input type="number" name="quantity" min="1">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä *</label>
                    <input type="number" name="total_amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑŸÖÿØŸÅŸàÿπ</label>
                    <input type="number" name="paid_amount" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label>ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</label>
                    <input type="date" name="due_date">
                </div>
                <div class="form-group">
                    <label>ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ÿ≠ŸÅÿ∏</button>
            </form>
        </div>
    </div>

    <!-- Add Project Employee Modal -->
    <div id="addProjectEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ ŸÑŸÑŸÖÿ¥ÿ±Ÿàÿπ</h3>
                <button class="close-btn" onclick="closeModal('addProjectEmployeeModal')">&times;</button>
            </div>
            <form id="addProjectEmployeeForm" onsubmit="addProjectEmployee(event)">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> ÿßŸÑŸÖŸàÿ∏ŸÅ *</label>
                    <select name="employee_id" id="employeeSelect" required onchange="fillEmployeeDefaults(this)">
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿßŸäÿ© *</label>
                    <input type="date" name="start_date" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tasks"></i> ÿßŸÑŸÖŸáÿßŸÖ ÿßŸÑŸÖÿ≥ŸÜÿØÿ©</label>
                    <input type="text" name="assigned_tasks" placeholder="ŸÖÿ´ÿßŸÑ: ÿ±ÿπÿßŸäÿ©ÿå ÿ™ÿ∫ÿ∞Ÿäÿ©ÿå ÿ™ŸÜÿ∏ŸäŸÅ">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-money-bill-wave"></i> ŸÜŸàÿπ ÿßŸÑÿ£ÿ¨ÿ± *</label>
                    <select name="salary_type" id="salaryTypeSelect" required onchange="toggleSalaryInfo()">
                        <option value="fixed">ÿ´ÿßÿ®ÿ™ (ÿ¥Ÿáÿ±Ÿä)</option>
                        <option value="daily">ŸäŸàŸÖŸä</option>
                        <option value="hourly">ÿ≥ÿßÿπŸä</option>
                        <option value="percentage">ŸÜÿ≥ÿ®ÿ© ŸÖŸÜ ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-dollar-sign"></i> ŸÇŸäŸÖÿ© ÿßŸÑÿ£ÿ¨ÿ± *</label>
                    <input type="number" name="salary_amount" step="0.01" required>
                    <small id="salaryHint" style="color: #6b7280; display: block; margin-top: 0.3rem;">
                        ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ÿ¨ÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä ÿ®ÿØÿßŸäÿ© ŸÉŸÑ ÿ¥Ÿáÿ±
                    </small>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-sticky-note"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™</label>
                    <textarea name="notes" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏
                </button>
            </form>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div id="addExpenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿµÿ±ŸàŸÅ</h3>
                <button class="close-btn" onclick="closeModal('addExpenseModal')">&times;</button>
            </div>
            <form id="addExpenseForm" onsubmit="addExpense(event)">
                <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> ÿßŸÑÿ™ÿßÿ±ŸäÿÆ *</label>
                    <input type="date" name="expense_date" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-tags"></i> ÿßŸÑŸÅÿ¶ÿ© *</label>
                    <select name="category" required>
                        <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÅÿ¶ÿ©</option>
                        <option value="ÿ£ÿπŸÑÿßŸÅ">ÿ£ÿπŸÑÿßŸÅ</option>
                        <option value="ÿ£ÿØŸàŸäÿ©">ÿ£ÿØŸàŸäÿ©</option>
                        <option value="ÿ±Ÿàÿßÿ™ÿ®">ÿ±Ÿàÿßÿ™ÿ®</option>
                        <option value="ÿµŸäÿßŸÜÿ©">ÿµŸäÿßŸÜÿ©</option>
                        <option value="ÿ™ÿπŸÇŸäŸÖ">ÿ™ÿπŸÇŸäŸÖ</option>
                        <option value="ŸÜÿ∏ÿßŸÅÿ©">ŸÜÿ∏ÿßŸÅÿ©</option>
                        <option value="ŸÉŸáÿ±ÿ®ÿßÿ°">ŸÉŸáÿ±ÿ®ÿßÿ°</option>
                        <option value="ŸÖÿßÿ°">ŸÖÿßÿ°</option>
                        <option value="ŸÜŸÇŸÑ">ŸÜŸÇŸÑ</option>
                        <option value="ÿ£ÿÆÿ±Ÿâ">ÿ£ÿÆÿ±Ÿâ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-dollar-sign"></i> ÿßŸÑŸÖÿ®ŸÑÿ∫ *</label>
                    <input type="number" name="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-user"></i> ÿßŸÑŸÖŸàÿ∏ŸÅ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)</label>
                    <select name="employee_id" id="expenseEmployeeSelect">
                        <option value="">ŸÑÿß ŸäŸàÿ¨ÿØ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-credit-card"></i> ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</label>
                    <select name="payment_method">
                        <option value="">ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ</option>
                        <option value="ŸÜŸÇÿØŸä">ŸÜŸÇÿØŸä</option>
                        <option value="ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä">ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä</option>
                        <option value="ÿ¥ŸäŸÉ">ÿ¥ŸäŸÉ</option>
                        <option value="ÿ®ÿ∑ÿßŸÇÿ©">ÿ®ÿ∑ÿßŸÇÿ©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-align-right"></i> ÿßŸÑŸàÿµŸÅ</label>
                    <textarea name="description" rows="3" placeholder="ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑŸÖÿµÿ±ŸàŸÅ..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> ÿ≠ŸÅÿ∏
                </button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sstvsknmmhbwubzajeix.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdHZza25tbWhid3ViemFqZWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDM0NjIsImV4cCI6MjA3NDkxOTQ2Mn0.EeVUU9DxRYUi38nUHgWEsnG8li7KZjqAGPNW9IDokhg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentProject = null;
        let allAnimals = [];
        let inventoryItems = [];
        let inventoryCategories = [];
        let allEmployees = [];
        let projectEmployees = [];

        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '../../login.html';
                return false;
            }
            currentUser = session.user;
            return true;
        }

        function getProjectId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        async function loadProject() {
            const projectId = getProjectId();
            if (!projectId) {
                alert('ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ');
                window.location.href = '../../index.html';
                return;
            }

            const { data, error } = await supabase
                .from('projects')
                .select('*')
                .eq('id', projectId)
                .eq('user_id', currentUser.id)
                .single();

            if (error || !data) {
                alert('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ');
                window.location.href = '../../index.html';
                return;
            }

            currentProject = data;
            document.querySelector('.navbar h1').innerHTML = `<i class="fas fa-sheep"></i> ${data.name}`;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.target.closest('.tab').classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        async function loadOverview() {
            const { data, error } = await supabase
                .from('sheep_animals')
                .select('type')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .eq('status', 'active');

            if (!error && data) {
                const ewes = data.filter(a => a.type === 'ewe').length;
                const lambs = data.filter(a => a.type === 'lamb').length;
                const rams = data.filter(a => a.type === 'ram').length;
                
                document.getElementById('ewesCount').textContent = ewes;
                document.getElementById('lambsCount').textContent = lambs;
                document.getElementById('ramsCount').textContent = rams;
                document.getElementById('totalCount').textContent = data.length;
            }
        }

        async function loadHerd() {
            const { data, error } = await supabase
                .from('sheep_animals')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('herdBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≠ŸäŸàÿßŸÜÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ©</td></tr>';
                return;
            }

            allAnimals = data;

            tbody.innerHTML = data.map(animal => {
                const age = animal.birth_date ? calculateAge(animal.birth_date) : '-';
                const typeText = animal.type === 'ewe' ? 'ŸÜÿπÿ¨ÿ©' : animal.type === 'ram' ? 'ŸÉÿ®ÿ¥' : 'ÿ≠ŸÖŸÑ';
                const sexText = animal.sex === 'F' ? 'ÿ£ŸÜÿ´Ÿâ' : 'ÿ∞ŸÉÿ±';
                const statusBadge = animal.status === 'active' ? 
                    '<span class="badge badge-success">ŸÜÿ¥ÿ∑</span>' : 
                    '<span class="badge badge-danger">ŸÖÿ®ÿßÿπ</span>';

                return `
                    <tr>
                        <td><strong>${animal.tag_number}</strong></td>
                        <td>${typeText}</td>
                        <td>${sexText}</td>
                        <td>${animal.birth_date || '-'}</td>
                        <td>${age}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn delete" onclick="deleteAnimal('${animal.id}')">
                                <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateAnimalSelects();
        }

        function calculateAge(birthDate) {
            const birth = new Date(birthDate);
            const now = new Date();
            const months = (now.getFullYear() - birth.getFullYear()) * 12 + (now.getMonth() - birth.getMonth());
            const years = Math.floor(months / 12);
            const remainingMonths = months % 12;
            
            if (years > 0) {
                return `${years} ÿ≥ŸÜÿ© ${remainingMonths > 0 ? `Ÿà ${remainingMonths} ÿ¥Ÿáÿ±` : ''}`;
            }
            return `${months} ÿ¥Ÿáÿ±`;
        }

        function updateAnimalSelects() {
            const healthSelect = document.getElementById('healthAnimalSelect');
            const saleSelect = document.getElementById('saleAnimalSelect');
            const birthSelect = document.getElementById('birthMotherSelect');

            const activeAnimals = allAnimals.filter(a => a.status === 'active');
            const ewes = activeAnimals.filter(a => a.type === 'ewe');

            const animalOptions = activeAnimals.map(a => 
                `<option value="${a.id}">${a.tag_number} - ${a.type === 'ewe' ? 'ŸÜÿπÿ¨ÿ©' : a.type === 'ram' ? 'ŸÉÿ®ÿ¥' : 'ÿ≠ŸÖŸÑ'}</option>`
            ).join('');

            const eweOptions = ewes.map(e => 
                `<option value="${e.id}">${e.tag_number} - ŸÜÿπÿ¨ÿ©</option>`
            ).join('');

            healthSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ≠ŸäŸàÿßŸÜ</option>' + animalOptions;
            saleSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ≠ŸäŸàÿßŸÜ</option>' + animalOptions;
            birthSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ£ŸÖ</option>' + eweOptions;
        }

        async function addAnimal(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const { data, error } = await supabase
                .from('sheep_animals')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    tag_number: formData.get('tag_number'),
                    type: formData.get('type'),
                    sex: formData.get('sex'),
                    birth_date: formData.get('birth_date') || null,
                    purchase_date: formData.get('purchase_date') || null,
                    purchase_price: formData.get('purchase_price') || null,
                    notes: formData.get('notes') || null
                });

            if (error) {
                showAlert('herdAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≠ŸäŸàÿßŸÜ: ' + error.message);
                return;
            }

            showAlert('herdAlert', 'success', 'ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≠ŸäŸàÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
            closeModal('addAnimalModal');
            e.target.reset();
            loadHerd();
            loadOverview();
        }

        async function deleteAnimal(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ≠ŸäŸàÿßŸÜÿü')) return;

            const { error } = await supabase
                .from('sheep_animals')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id);

            if (error) {
                showAlert('herdAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ŸäŸàÿßŸÜ');
                return;
            }

            showAlert('herdAlert', 'success', 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ≠ŸäŸàÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
            loadHerd();
            loadOverview();
        }

        async function loadHealthRecords() {
            const { data, error } = await supabase
                .from('sheep_health_records')
                .select(`
                    *,
                    sheep_animals!inner(tag_number)
                `)
                .eq('user_id', currentUser.id)
                .order('record_date', { ascending: false });

            const tbody = document.getElementById('healthBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ÿµÿ≠Ÿäÿ©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(record => {
                const typeText = record.record_type === 'vaccination' ? 
                    '<span class="badge badge-info">ÿ™ÿ∑ÿπŸäŸÖ</span>' : 
                    record.record_type === 'treatment' ? 
                    '<span class="badge badge-warning">ÿπŸÑÿßÿ¨</span>' : 
                    '<span class="badge badge-success">ŸÅÿ≠ÿµ</span>';
                
                return `
                    <tr>
                        <td><strong>${record.sheep_animals.tag_number}</strong></td>
                        <td>${typeText}</td>
                        <td>${record.record_date}</td>
                        <td>${record.description || '-'}</td>
                        <td>${record.medication || '-'}</td>
                        <td>${record.cost ? '<strong>' + record.cost.toLocaleString() + ' ÿØ</strong>' : '-'}</td>
                        <td>${record.next_due_date || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function addHealthRecord(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const { data, error } = await supabase
                .from('sheep_health_records')
                .insert({
                    user_id: currentUser.id,
                    animal_id: formData.get('animal_id'),
                    record_type: formData.get('record_type'),
                    record_date: formData.get('record_date'),
                    description: formData.get('description') || null,
                    medication: formData.get('medication') || null,
                    dosage: formData.get('dosage') || null,
                    cost: formData.get('cost') || null,
                    next_due_date: formData.get('next_due_date') || null
                });

            if (error) {
                showAlert('healthAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿµÿ≠Ÿä');
                return;
            }

            const cost = formData.get('cost');
            if (cost && parseFloat(cost) > 0) {
                await supabase.from('expenses').insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    category: 'ÿ£ÿØŸàŸäÿ©',
                    amount: parseFloat(cost),
                    description: `ÿ≥ÿ¨ŸÑ ÿµÿ≠Ÿä: ${formData.get('description') || 'ÿπŸÑÿßÿ¨'}`,
                    expense_date: formData.get('record_date')
                });
            }

            showAlert('healthAlert', 'success', 'ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑÿµÿ≠Ÿä ÿ®ŸÜÿ¨ÿßÿ≠');
            closeModal('addHealthModal');
            e.target.reset();
            loadHealthRecords();
        }

        async function loadBirths() {
            const { data, error } = await supabase
                .from('sheep_births')
                .select(`
                    *,
                    sheep_animals!inner(tag_number)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('birth_date', { ascending: false });

            const tbody = document.getElementById('birthsBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸàŸÑÿßÿØÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(birth => `
                <tr>
                    <td><strong>${birth.sheep_animals.tag_number}</strong></td>
                    <td>${birth.birth_date}</td>
                    <td><span class="badge badge-info">${birth.total_lambs}</span></td>
                    <td><span class="badge badge-success">${birth.live_lambs}</span></td>
                    <td>${birth.notes || '-'}</td>
                </tr>
            `).join('');
        }

        async function addBirth(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const { data, error } = await supabase
                .from('sheep_births')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    mother_id: formData.get('mother_id'),
                    birth_date: formData.get('birth_date'),
                    total_lambs: parseInt(formData.get('total_lambs')),
                    live_lambs: parseInt(formData.get('live_lambs')),
                    notes: formData.get('notes') || null
                });

            if (error) {
                showAlert('birthsAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸàŸÑÿßÿØÿ©');
                return;
            }

            showAlert('birthsAlert', 'success', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑŸàŸÑÿßÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
            closeModal('addBirthModal');
            e.target.reset();
            loadBirths();
            loadOverview();
        }

        async function loadInventoryItems() {
            // Load categories
            const { data: categories, error: catError } = await supabase
                .from('inventory_categories')
                .select('id, name')
                .eq('user_id', currentUser.id)
                .order('name');

            if (!catError && categories) {
                inventoryCategories = categories;
            }

            // Load items with category info
            const { data, error } = await supabase
                .from('inventory_items')
                .select('id, name, unit, current_quantity, cost_price, category_id, expiry_date')
                .eq('user_id', currentUser.id)
                .order('name');

            if (!error && data) {
                inventoryItems = data;
                updateFeedCategorySelects();
            }
        }

        function updateFeedCategorySelects() {
            const selects = document.querySelectorAll('select[name="category_id[]"]');
            const options = inventoryCategories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');

            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ</option>' + options;
                if (currentValue) select.value = currentValue;
            });
        }

        function loadItemsByCategory(selectElement) {
            const categoryId = selectElement.value;
            const row = selectElement.closest('.feed-item-row');
            const itemSelect = row.querySelector('select[name="item_id[]"]');
            const unitInput = row.querySelector('input[name="unit[]"]');
            const priceInput = row.querySelector('input[name="unit_cost[]"]');
            const stockInfo = row.querySelector('.item-stock-info');

            // Reset
            itemSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ©</option>';
            unitInput.value = '';
            priceInput.value = '';
            stockInfo.innerHTML = '<i class="fas fa-info-circle"></i> ÿßÿÆÿ™ÿ± ŸÖÿßÿØÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖÿ™ÿßÿ≠';

            if (!categoryId) return;

            const items = inventoryItems.filter(item => item.category_id === categoryId);
            
            if (items.length === 0) {
                itemSelect.innerHTML = '<option value="">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸàÿßÿØ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ™ÿµŸÜŸäŸÅ</option>';
                return;
            }

            const options = items.map(item => {
                const expiryWarning = item.expiry_date && new Date(item.expiry_date) < new Date() ? ' ‚ö†Ô∏è ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©' : '';
                return `<option value="${item.id}" data-unit="${item.unit}" data-price="${item.cost_price || 0}" data-stock="${item.current_quantity}" data-expiry="${item.expiry_date || ''}">${item.name}${expiryWarning}</option>`;
            }).join('');

            itemSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ©</option>' + options;
        }

        function fillItemPrice(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const row = selectElement.closest('.feed-item-row');
            const unitInput = row.querySelector('input[name="unit[]"]');
            const priceInput = row.querySelector('input[name="unit_cost[]"]');
            const stockInfo = row.querySelector('.item-stock-info');

            if (!selectedOption.value) {
                unitInput.value = '';
                priceInput.value = '';
                stockInfo.innerHTML = '<i class="fas fa-info-circle"></i> ÿßÿÆÿ™ÿ± ŸÖÿßÿØÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖÿ™ÿßÿ≠';
                return;
            }

            const unit = selectedOption.dataset.unit || '';
            const price = selectedOption.dataset.price || 0;
            const stock = selectedOption.dataset.stock || 0;
            const expiry = selectedOption.dataset.expiry || '';

            unitInput.value = unit;
            priceInput.value = parseFloat(price).toFixed(2);

            // Check expiry
            let expiryWarning = '';
            if (expiry) {
                const expiryDate = new Date(expiry);
                const today = new Date();
                if (expiryDate < today) {
                    expiryWarning = ' <span style="color: #dc2626;">‚ö†Ô∏è ŸÖŸÜÿ™ŸáŸä ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©</span>';
                }
            }

            stockInfo.innerHTML = `
                <i class="fas fa-warehouse"></i> ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖÿ™ÿßÿ≠: <strong>${parseFloat(stock).toFixed(2)} ${unit}</strong>${expiryWarning}
            `;

            calculateFeedSummary();
        }

        function updateEndDateMin() {
            const startDate = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate');
            if (startDate) {
                endDateInput.min = startDate;
                if (endDateInput.value && endDateInput.value < startDate) {
                    endDateInput.value = startDate;
                }
            }
            calculateFeedSummary();
        }

        function calculateFeedSummary() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const summary = document.getElementById('feedSummary');

            if (!startDate || !endDate) {
                summary.style.display = 'none';
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            let dailyCost = 0;
            const rows = document.querySelectorAll('.feed-item-row');
            rows.forEach(row => {
                const quantity = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
                const price = parseFloat(row.querySelector('input[name="unit_cost[]"]').value) || 0;
                dailyCost += quantity * price;
            });

            const totalCost = dailyCost * diffDays;

            document.getElementById('totalDays').textContent = diffDays;
            document.getElementById('dailyCost').textContent = dailyCost.toLocaleString() + ' ÿØ';
            document.getElementById('totalCost').textContent = totalCost.toLocaleString() + ' ÿØ';
            summary.style.display = 'block';
        }

        // Listen to quantity and price changes
        document.addEventListener('input', function(e) {
            if (e.target.matches('input[name="quantity[]"]') || e.target.matches('input[name="unit_cost[]"]')) {
                calculateFeedSummary();
            }
        });

        function addFeedItem() {
            const container = document.getElementById('feedItems');
            const div = document.createElement('div');
            div.className = 'feed-item-row';
            div.style.cssText = 'display: grid; gap: 0.8rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 1rem;';
            div.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑÿ™ÿµŸÜŸäŸÅ *</label>
                        <select name="category_id[]" onchange="loadItemsByCategory(this)" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ</option>
                            ${inventoryCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑŸÖÿßÿØÿ© *</label>
                        <select name="item_id[]" onchange="fillItemPrice(this)" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                            <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿßÿØÿ©</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.8rem; align-items: end;">
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸäŸàŸÖŸäÿ© *</label>
                        <input type="number" name="quantity[]" placeholder="ŸÖÿ´ÿßŸÑ: 50" step="0.01" min="0.01" required style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; font-family: 'Cairo', sans-serif;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑŸàÿ≠ÿØÿ©</label>
                        <input type="text" name="unit[]" readonly style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; background: #f3f4f6; font-family: 'Cairo', sans-serif;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.3rem; color: #6b7280; font-size: 0.85rem;">ÿßŸÑÿ≥ÿπÿ±/Ÿàÿ≠ÿØÿ©</label>
                        <input type="number" name="unit_cost[]" readonly step="0.01" style="width: 100%; padding: 0.6rem; border: 2px solid #e5e7eb; border-radius: 6px; background: #f3f4f6; font-family: 'Cairo', sans-serif;">
                    </div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="removeFeedItem(this)" style="margin-bottom: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="background: #e0f2fe; padding: 0.5rem; border-radius: 4px; font-size: 0.85rem; color: #075985;">
                    <i class="fas fa-info-circle"></i> <span class="item-stock-info">ÿßÿÆÿ™ÿ± ŸÖÿßÿØÿ© ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑŸÖÿ™ÿßÿ≠</span>
                </div>
            `;
            container.appendChild(div);
        }

        function removeFeedItem(btn) {
            const container = document.getElementById('feedItems');
            if (container.children.length > 1) {
                btn.closest('.feed-item-row').remove();
                calculateFeedSummary();
            } else {
                alert('Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ŸáŸÜÿßŸÉ ŸÖÿßÿØÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
            }
        }

        async function loadFeedLogs() {
            const { data, error } = await supabase
                .from('sheep_feed_logs')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('feed_date', { ascending: false });

            const tbody = document.getElementById('feedingBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ÿ™ÿ∫ÿ∞Ÿäÿ©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(log => `
                <tr>
                    <td>${log.feed_date}</td>
                    <td><span class="badge badge-info">${log.animal_count}</span></td>
                    <td><strong>${log.total_cost ? log.total_cost.toLocaleString() + ' ÿØ' : '-'}</strong></td>
                    <td>${log.notes || '-'}</td>
                    <td>
                        <button class="action-btn delete" onclick="deleteFeedLog('${log.id}')">
                            <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function addFeedLog(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const startDate = formData.get('start_date');
            const endDate = formData.get('end_date');
            const animalCount = parseInt(formData.get('animal_count'));
            const notes = formData.get('notes');
            
            const itemIds = formData.getAll('item_id[]');
            const quantities = formData.getAll('quantity[]');
            const unitCosts = formData.getAll('unit_cost[]');
            
            // Calculate number of days
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            
            // Validate and prepare items
            let dailyCost = 0;
            const items = [];
            
            for (let i = 0; i < itemIds.length; i++) {
                const itemId = itemIds[i];
                const quantity = parseFloat(quantities[i]);
                const unitCost = parseFloat(unitCosts[i]);
                const itemTotal = quantity * unitCost;
                
                const item = inventoryItems.find(inv => inv.id === itemId);
                if (!item) {
                    showAlert('feedingAlert', 'error', `ÿßŸÑŸÖÿßÿØÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©`);
                    return;
                }
                
                // Check if enough stock for entire period
                const totalNeeded = quantity * totalDays;
                if (item.current_quantity < totalNeeded) {
                    showAlert('feedingAlert', 'error', `ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä ŸÑŸÑŸÖÿßÿØÿ© "${item.name}". ÿßŸÑŸÖÿ™ÿßÿ≠: ${item.current_quantity} ${item.unit}ÿå ÿßŸÑŸÖÿ∑ŸÑŸàÿ®: ${totalNeeded.toFixed(2)} ${item.unit}`);
                    return;
                }
                
                // Check expiry date
                if (item.expiry_date) {
                    const expiryDate = new Date(item.expiry_date);
                    const planEndDate = new Date(endDate);
                    if (expiryDate < planEndDate) {
                        if (!confirm(`ÿ™ŸÜÿ®ŸäŸá: ÿßŸÑŸÖÿßÿØÿ© "${item.name}" ÿ≥ÿ™ŸÜÿ™ŸáŸä ÿµŸÑÿßÿ≠Ÿäÿ™Ÿáÿß ŸÅŸä ${item.expiry_date} ŸÇÿ®ŸÑ ÿßŸÜÿ™Ÿáÿßÿ° ŸÅÿ™ÿ±ÿ© ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ© (${endDate}). ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü`)) {
                            return;
                        }
                    }
                }
                
                dailyCost += itemTotal;
                items.push({ itemId, itemName: item.name, quantity, unitCost, itemTotal, unit: item.unit });
            }
            
            const totalCost = dailyCost * totalDays;
            
            // Confirm before proceeding
            const confirmMsg = `
                ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©:
                - ÿßŸÑŸÅÿ™ÿ±ÿ©: ŸÖŸÜ ${startDate} ÿ•ŸÑŸâ ${endDate} (${totalDays} ŸäŸàŸÖ)
                - ÿπÿØÿØ ÿßŸÑÿ±ÿ§Ÿàÿ≥: ${animalCount}
                - ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑŸäŸàŸÖŸäÿ©: ${dailyCost.toLocaleString()} ÿØ
                - ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©: ${totalCost.toLocaleString()} ÿØ
                
                ÿ≥Ÿäÿ™ŸÖ ÿÆÿµŸÖ ÿßŸÑŸÖŸàÿßÿØ ŸäŸàŸÖŸäÿßŸã ŸÖŸÜ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿ®ÿ¥ŸÉŸÑ ÿ™ŸÑŸÇÿßÿ¶Ÿä.
                ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑŸÖÿ™ÿßÿ®ÿπÿ©ÿü
            `;
            
            if (!confirm(confirmMsg)) return;
            
            // Create main feed log
            const { data: feedLog, error: logError } = await supabase
                .from('sheep_feed_logs')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    feed_date: startDate,
                    animal_count: animalCount,
                    total_cost: totalCost,
                    notes: notes || `ÿ™ÿ∫ÿ∞Ÿäÿ© ŸäŸàŸÖŸäÿ© ŸÖŸÜ ${startDate} ÿ•ŸÑŸâ ${endDate}`
                })
                .select()
                .single();

            if (logError) {
                showAlert('feedingAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©: ' + logError.message);
                return;
            }

            // Create daily records for each day in the period
            let currentDate = new Date(start);
            let successfulDays = 0;
            
            while (currentDate <= end) {
                const dateStr = currentDate.toISOString().split('T')[0];
                
                // Check if we still have stock for this day
                let canContinue = true;
                
                for (const item of items) {
                    // Get current stock
                    const { data: currentItem } = await supabase
                        .from('inventory_items')
                        .select('current_quantity, expiry_date')
                        .eq('id', item.itemId)
                        .single();
                    
                    if (!currentItem || currentItem.current_quantity < item.quantity) {
                        showAlert('feedingAlert', 'error', `ŸÜŸÅÿ∞ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ŸÖŸÜ "${item.itemName}" ŸÅŸä ${dateStr}. ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ${successfulDays} ŸäŸàŸÖ ŸÖŸÜ ÿ£ÿµŸÑ ${totalDays}.`);
                        canContinue = false;
                        break;
                    }
                    
                    // Check expiry
                    if (currentItem.expiry_date && new Date(currentItem.expiry_date) < new Date(dateStr)) {
                        showAlert('feedingAlert', 'error', `ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© "${item.itemName}" ŸÅŸä ${dateStr}. ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ${successfulDays} ŸäŸàŸÖ ŸÖŸÜ ÿ£ÿµŸÑ ${totalDays}.`);
                        canContinue = false;
                        break;
                    }
                }
                
                if (!canContinue) break;
                
                // Process items for this day
                for (const item of items) {
                    // Insert feed detail
                    await supabase.from('sheep_feed_details').insert({
                        feed_log_id: feedLog.id,
                        inventory_item_id: item.itemId,
                        quantity: item.quantity,
                        unit_cost: item.unitCost,
                        total_cost: item.itemTotal
                    });

                    // Create inventory movement (will trigger automatic deduction)
                    await supabase.from('inventory_movements').insert({
                        user_id: currentUser.id,
                        item_id: item.itemId,
                        project_id: currentProject.id,
                        type: 'project_usage',
                        quantity: item.quantity,
                        reference_type: 'sheep_feed_log',
                        reference_id: feedLog.id,
                        notes: `ÿ™ÿ∫ÿ∞Ÿäÿ© ŸäŸàŸÖŸäÿ© - ${dateStr}`
                    });
                }

                // Add daily expense
                await supabase.from('expenses').insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    category: 'ÿ£ÿπŸÑÿßŸÅ',
                    amount: dailyCost,
                    description: `ÿ™ÿ∫ÿ∞Ÿäÿ© ŸäŸàŸÖŸäÿ©: ${notes || 'ÿ™ÿ∫ÿ∞Ÿäÿ© ÿßŸÑÿ£ÿ∫ŸÜÿßŸÖ'}`,
                    expense_date: dateStr
                });
                
                successfulDays++;
                currentDate.setDate(currentDate.getDate() + 1);
            }

            if (successfulDays === totalDays) {
                showAlert('feedingAlert', 'success', `ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠ ŸÑŸÖÿØÿ© ${totalDays} ŸäŸàŸÖ!`);
            } else {
                showAlert('feedingAlert', 'error', `ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ${successfulDays} ŸäŸàŸÖ ŸÅŸÇÿ∑ ŸÖŸÜ ÿ£ÿµŸÑ ${totalDays} ŸäŸàŸÖ ÿ®ÿ≥ÿ®ÿ® ŸÜŸÅÿßÿ∞ ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿ£Ÿà ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿ©.`);
            }
            
            closeModal('addFeedModal');
            e.target.reset();
            document.getElementById('feedSummary').style.display = 'none';
            
            // Reset feed items to one row
            const firstRow = document.querySelector('.feed-item-row');
            document.getElementById('feedItems').innerHTML = '';
            document.getElementById('feedItems').appendChild(firstRow);
            updateFeedCategorySelects();
            
            loadFeedLogs();
            loadInventoryItems();
            loadStats();
        }

        async function deleteFeedLog(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©ÿü')) return;

            const { error } = await supabase
                .from('sheep_feed_logs')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id);

            if (error) {
                showAlert('feedingAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ©');
                return;
            }

            showAlert('feedingAlert', 'success', 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ∫ÿ∞Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
            loadFeedLogs();
        }

        async function loadSales() {
            const { data, error } = await supabase
                .from('sheep_sales')
                .select(`
                    *,
                    sheep_animals!inner(tag_number)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('sale_date', { ascending: false });

            const tbody = document.getElementById('salesBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ®Ÿäÿπÿßÿ™ ŸÖÿ≥ÿ¨ŸÑÿ©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(sale => {
                const statusBadge = sale.payment_status === 'paid' ? 
                    '<span class="badge badge-success">ŸÖÿØŸÅŸàÿπ</span>' :
                    sale.payment_status === 'partial' ?
                    '<span class="badge badge-warning">ÿ¨ÿ≤ÿ¶Ÿä</span>' :
                    '<span class="badge badge-danger">ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ</span>';

                return `
                    <tr>
                        <td><strong>${sale.sheep_animals.tag_number}</strong></td>
                        <td>${sale.sale_date}</td>
                        <td><strong>${sale.sale_price.toLocaleString()} ÿØ</strong></td>
                        <td>${sale.customer_name || '-'}</td>
                        <td>${statusBadge}</td>
                        <td><strong>${sale.remaining_amount ? sale.remaining_amount.toLocaleString() + ' ÿØ' : '0 ÿØ'}</strong></td>
                    </tr>
                `;
            }).join('');
        }

        async function addSale(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const animalId = formData.get('animal_id');
            const salePrice = parseFloat(formData.get('sale_price'));
            
            const { data, error } = await supabase
                .from('sheep_sales')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    animal_id: animalId,
                    sale_date: formData.get('sale_date'),
                    sale_price: salePrice,
                    customer_name: formData.get('customer_name') || null,
                    payment_status: formData.get('payment_status'),
                    remaining_amount: parseFloat(formData.get('remaining_amount')) || 0,
                    notes: formData.get('notes') || null
                });

            if (error) {
                showAlert('salesAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ®Ÿäÿπ');
                return;
            }

            await supabase
                .from('sheep_animals')
                .update({ status: 'sold' })
                .eq('id', animalId);

            await supabase.from('sales').insert({
                user_id: currentUser.id,
                project_id: currentProject.id,
                type: 'ÿ≠ŸäŸàÿßŸÜ',
                quantity: 1,
                unit_price: salePrice,
                total_amount: salePrice,
                customer_name: formData.get('customer_name') || null,
                payment_status: formData.get('payment_status'),
                sale_date: formData.get('sale_date')
            });

            showAlert('salesAlert', 'success', 'ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿ®Ÿäÿπ ÿ®ŸÜÿ¨ÿßÿ≠');
            closeModal('addSaleModal');
            e.target.reset();
            loadSales();
            loadHerd();
            loadOverview();
        }

        async function loadDebts() {
            const { data, error } = await supabase
                .from('sheep_eid_debts')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('debtsBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿØŸäŸàŸÜ ŸÖÿ≥ÿ¨ŸÑÿ©</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(debt => {
                const statusBadge = debt.status === 'paid' ? 
                    '<span class="badge badge-success">ŸÖÿØŸÅŸàÿπ</span>' :
                    debt.status === 'partial' ?
                    '<span class="badge badge-warning">ÿ¨ÿ≤ÿ¶Ÿä</span>' :
                    '<span class="badge badge-danger">ŸÖÿπŸÑŸÇ</span>';

                return `
                    <tr>
                        <td><strong>${debt.customer_name}</strong></td>
                        <td>${debt.animal_type || '-'}</td>
                        <td>${debt.quantity || '-'}</td>
                        <td><strong>${debt.total_amount.toLocaleString()} ÿØ</strong></td>
                        <td><strong>${debt.paid_amount.toLocaleString()} ÿØ</strong></td>
                        <td><strong style="color: #ef4444;">${debt.remaining_amount.toLocaleString()} ÿØ</strong></td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        async function addDebt(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const { data, error } = await supabase
                .from('sheep_eid_debts')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    customer_name: formData.get('customer_name'),
                    animal_type: formData.get('animal_type') || null,
                    quantity: formData.get('quantity') || null,
                    total_amount: parseFloat(formData.get('total_amount')),
                    paid_amount: parseFloat(formData.get('paid_amount')) || 0,
                    due_date: formData.get('due_date') || null,
                    notes: formData.get('notes') || null
                });

            if (error) {
                showAlert('debtsAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸäŸÜ');
                return;
            }

            showAlert('debtsAlert', 'success', 'ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸäŸÜ ÿ®ŸÜÿ¨ÿßÿ≠');
            closeModal('addDebtModal');
            e.target.reset();
            loadDebts();
        }

        async function loadStats() {
            const { data: expenses } = await supabase
                .from('expenses')
                .select('amount')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id);

            const { data: sales } = await supabase
                .from('sales')
                .select('total_amount')
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id);

            const totalExpenses = expenses?.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0) || 0;
            const totalSales = sales?.reduce((sum, s) => sum + (parseFloat(s.total_amount) || 0), 0) || 0;
            const netProfit = totalSales - totalExpenses;

            document.getElementById('totalExpenses').textContent = totalExpenses.toLocaleString() + ' ÿØ';
            document.getElementById('totalSales').textContent = totalSales.toLocaleString() + ' ÿØ';
            document.getElementById('netProfit').textContent = (netProfit >= 0 ? '+' : '') + netProfit.toLocaleString() + ' ÿØ';
            document.getElementById('netProfit').style.color = netProfit >= 0 ? '#10b981' : '#ef4444';
        }

        function openAddAnimalModal() {
            document.getElementById('addAnimalModal').classList.add('active');
        }

        function openAddHealthModal() {
            document.getElementById('addHealthModal').classList.add('active');
        }

        function openAddBirthModal() {
            document.getElementById('addBirthModal').classList.add('active');
        }

        function openAddFeedModal() {
            // Set default dates (today to tomorrow)
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = tomorrow;
            document.getElementById('endDate').min = today;
            
            document.getElementById('addFeedModal').classList.add('active');
        }

        function openAddSaleModal() {
            document.getElementById('addSaleModal').classList.add('active');
        }

        function openAddDebtModal() {
            document.getElementById('addDebtModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAlert(containerId, type, message) {
            const container = document.getElementById(containerId);
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            container.innerHTML = `<div class="alert ${alertClass}"><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        // =================== EMPLOYEES FUNCTIONS ===================
        
        async function loadEmployees() {
            // Load all employees for selection
            const { data: employees, error: empError } = await supabase
                .from('employees')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('status', 'active')
                .order('name');

            if (!empError && employees) {
                allEmployees = employees;
                updateEmployeeSelects();
            }

            // Load project employees
            const { data: projEmployees, error: projError } = await supabase
                .from('project_employees')
                .select(`
                    *,
                    employees!inner(name, phone, position)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('created_at', { ascending: false });

            const tbody = document.getElementById('employeesBody');
            
            if (projError || !projEmployees || projEmployees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸàÿ∏ŸÅŸäŸÜ ŸÖÿ±ÿ™ÿ®ÿ∑ŸäŸÜ ÿ®ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ</td></tr>';
                projectEmployees = [];
                return;
            }

            projectEmployees = projEmployees;

            tbody.innerHTML = projEmployees.map(emp => {
                const salaryTypeText = {
                    'fixed': 'ÿ´ÿßÿ®ÿ™ (ÿ¥Ÿáÿ±Ÿä)',
                    'daily': 'ŸäŸàŸÖŸä',
                    'hourly': 'ÿ≥ÿßÿπŸä',
                    'percentage': 'ŸÜÿ≥ÿ®ÿ©'
                }[emp.salary_type] || emp.salary_type;

                const statusBadge = emp.status === 'active' ? 
                    '<span class="badge badge-success">ŸÜÿ¥ÿ∑</span>' : 
                    '<span class="badge badge-danger">ŸÖÿ™ŸàŸÇŸÅ</span>';

                const tasks = emp.assigned_tasks ? (Array.isArray(emp.assigned_tasks) ? emp.assigned_tasks.join(', ') : emp.assigned_tasks) : '-';

                return `
                    <tr>
                        <td><strong>${emp.employees.name}</strong><br><small style="color: #6b7280;">${emp.employees.position || ''}</small></td>
                        <td>${tasks}</td>
                        <td>${salaryTypeText}</td>
                        <td><strong>${emp.salary_amount ? emp.salary_amount.toLocaleString() + ' ÿØ' : '-'}</strong></td>
                        <td>${emp.start_date || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn delete" onclick="removeProjectEmployee('${emp.id}')">
                                <i class="fas fa-times"></i> ÿ•ÿ≤ÿßŸÑÿ©
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateEmployeeSelects() {
            const employeeSelect = document.getElementById('employeeSelect');
            const expenseEmployeeSelect = document.getElementById('expenseEmployeeSelect');

            const options = allEmployees.map(emp => 
                `<option value="${emp.id}" data-salary-type="${emp.salary_type}" data-salary-amount="${emp.salary_amount}">${emp.name} - ${emp.position || 'ŸÖŸàÿ∏ŸÅ'}</option>`
            ).join('');

            if (employeeSelect) {
                employeeSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖŸàÿ∏ŸÅ</option>' + options;
            }

            if (expenseEmployeeSelect) {
                expenseEmployeeSelect.innerHTML = '<option value="">ŸÑÿß ŸäŸàÿ¨ÿØ</option>' + options;
            }
        }

        function fillEmployeeDefaults(select) {
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption.value) return;

            const salaryType = selectedOption.dataset.salaryType;
            const salaryAmount = selectedOption.dataset.salaryAmount;

            document.getElementById('salaryTypeSelect').value = salaryType || 'fixed';
            document.querySelector('input[name="salary_amount"]').value = salaryAmount || '';
            toggleSalaryInfo();
        }

        function toggleSalaryInfo() {
            const salaryType = document.getElementById('salaryTypeSelect').value;
            const hint = document.getElementById('salaryHint');
            
            const hints = {
                'fixed': 'ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ÿ¨ÿ± ÿßŸÑÿ¥Ÿáÿ±Ÿä ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÅŸä ÿ®ÿØÿßŸäÿ© ŸÉŸÑ ÿ¥Ÿáÿ±',
                'daily': 'ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ÿ± ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ ÿßŸÑŸÅÿπŸÑŸäÿ©',
                'hourly': 'ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ÿ± ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ ÿßŸÑŸÅÿπŸÑŸäÿ©',
                'percentage': 'ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ£ÿ¨ÿ± ŸÉŸÜÿ≥ÿ®ÿ© ŸÖŸÜ ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™'
            };

            hint.textContent = hints[salaryType] || '';
        }

        async function addProjectEmployee(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const tasksInput = formData.get('assigned_tasks');
            const tasks = tasksInput ? tasksInput.split(',').map(t => t.trim()) : [];

            const { data, error } = await supabase
                .from('project_employees')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    employee_id: formData.get('employee_id'),
                    start_date: formData.get('start_date'),
                    salary_type: formData.get('salary_type'),
                    salary_amount: parseFloat(formData.get('salary_amount')),
                    assigned_tasks: tasks,
                    notes: formData.get('notes') || null,
                    status: 'active'
                });

            if (error) {
                showAlert('employeesAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ: ' + error.message);
                return;
            }

            // If salary is fixed (monthly), create initial expense
            const salaryType = formData.get('salary_type');
            if (salaryType === 'fixed') {
                const startDate = formData.get('start_date');
                const amount = parseFloat(formData.get('salary_amount'));
                const employeeName = document.getElementById('employeeSelect').selectedOptions[0].text;

                await supabase.from('expenses').insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    employee_id: formData.get('employee_id'),
                    category: 'ÿ±Ÿàÿßÿ™ÿ®',
                    amount: amount,
                    description: `ÿ±ÿßÿ™ÿ® ÿ¥Ÿáÿ±Ÿä: ${employeeName}`,
                    expense_date: startDate,
                    payment_method: 'ŸÜŸÇÿØŸä'
                });
            }

            showAlert('employeesAlert', 'success', 'ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠');
            closeModal('addProjectEmployeeModal');
            e.target.reset();
            loadEmployees();
            loadExpenses();
        }

        async function removeProjectEmployee(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿ≤ÿßŸÑÿ© Ÿáÿ∞ÿß ÿßŸÑŸÖŸàÿ∏ŸÅ ŸÖŸÜ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπÿü')) return;

            const { error } = await supabase
                .from('project_employees')
                .update({ status: 'inactive', end_date: new Date().toISOString().split('T')[0] })
                .eq('id', id)
                .eq('user_id', currentUser.id);

            if (error) {
                showAlert('employeesAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ');
                return;
            }

            showAlert('employeesAlert', 'success', 'ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠');
            loadEmployees();
        }

        function openAddProjectEmployeeModal() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#addProjectEmployeeForm input[name="start_date"]').value = today;
            document.getElementById('addProjectEmployeeModal').classList.add('active');
        }

        // =================== EXPENSES FUNCTIONS ===================

        async function loadExpenses() {
            const { data, error } = await supabase
                .from('expenses')
                .select(`
                    *,
                    employees(name)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .order('expense_date', { ascending: false });

            const tbody = document.getElementById('expensesBody');
            
            if (error || !data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿµÿßÿ±ŸäŸÅ ŸÖÿ≥ÿ¨ŸÑÿ©</td></tr>';
                updateExpenseSummary([]);
                return;
            }

            tbody.innerHTML = data.map(expense => {
                const categoryBadges = {
                    'ÿ£ÿπŸÑÿßŸÅ': 'badge-warning',
                    'ÿ±Ÿàÿßÿ™ÿ®': 'badge-info',
                    'ÿ£ÿØŸàŸäÿ©': 'badge-danger',
                    'ÿµŸäÿßŸÜÿ©': 'badge-secondary',
                    'ÿ™ÿπŸÇŸäŸÖ': 'badge-info'
                };

                const badgeClass = categoryBadges[expense.category] || 'badge-secondary';
                
                return `
                    <tr>
                        <td>${expense.expense_date}</td>
                        <td><span class="badge ${badgeClass}">${expense.category}</span></td>
                        <td><strong>${expense.amount.toLocaleString()} ÿØ</strong></td>
                        <td>${expense.employees ? expense.employees.name : '-'}</td>
                        <td>${expense.description || '-'}</td>
                        <td>
                            <button class="action-btn delete" onclick="deleteExpense('${expense.id}')">
                                <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateExpenseSummary(data);
        }

        function updateExpenseSummary(expenses) {
            const categories = {
                'ÿ£ÿπŸÑÿßŸÅ': 0,
                'ÿ±Ÿàÿßÿ™ÿ®': 0,
                'ÿ£ÿØŸàŸäÿ©': 0,
                'ÿµŸäÿßŸÜÿ©': 0
            };

            let otherTotal = 0;

            expenses.forEach(expense => {
                const amount = parseFloat(expense.amount) || 0;
                if (categories.hasOwnProperty(expense.category)) {
                    categories[expense.category] += amount;
                } else {
                    otherTotal += amount;
                }
            });

            document.getElementById('feedExpenses').textContent = categories['ÿ£ÿπŸÑÿßŸÅ'].toLocaleString() + ' ÿØ';
            document.getElementById('salaryExpenses').textContent = categories['ÿ±Ÿàÿßÿ™ÿ®'].toLocaleString() + ' ÿØ';
            document.getElementById('medicineExpenses').textContent = categories['ÿ£ÿØŸàŸäÿ©'].toLocaleString() + ' ÿØ';
            document.getElementById('maintenanceExpenses').textContent = categories['ÿµŸäÿßŸÜÿ©'].toLocaleString() + ' ÿØ';
            document.getElementById('otherExpenses').textContent = otherTotal.toLocaleString() + ' ÿØ';
        }

        async function addExpense(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const employeeId = formData.get('employee_id') || null;

            const { data, error } = await supabase
                .from('expenses')
                .insert({
                    user_id: currentUser.id,
                    project_id: currentProject.id,
                    category: formData.get('category'),
                    amount: parseFloat(formData.get('amount')),
                    description: formData.get('description') || null,
                    employee_id: employeeId,
                    payment_method: formData.get('payment_method') || null,
                    expense_date: formData.get('expense_date')
                });

            if (error) {
                showAlert('expensesAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿµÿ±ŸàŸÅ: ' + error.message);
                return;
            }

            showAlert('expensesAlert', 'success', 'ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿµÿ±ŸàŸÅ ÿ®ŸÜÿ¨ÿßÿ≠');
            closeModal('addExpenseModal');
            e.target.reset();
            loadExpenses();
            loadStats();
        }

        async function deleteExpense(id) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿµÿ±ŸàŸÅÿü')) return;

            const { error } = await supabase
                .from('expenses')
                .delete()
                .eq('id', id)
                .eq('user_id', currentUser.id);

            if (error) {
                showAlert('expensesAlert', 'error', 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿµÿ±ŸàŸÅ');
                return;
            }

            showAlert('expensesAlert', 'success', 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿµÿ±ŸàŸÅ ÿ®ŸÜÿ¨ÿßÿ≠');
            loadExpenses();
            loadStats();
        }

        function openAddExpenseModal() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('#addExpenseForm input[name="expense_date"]').value = today;
            document.getElementById('addExpenseModal').classList.add('active');
        }

        async function init() {
            if (await checkAuth()) {
                await loadProject();
                await checkAndAddMonthlySalaries(); // Check for monthly salaries
                await loadOverview();
                await loadHerd();
                await loadHealthRecords();
                await loadBirths();
                await loadInventoryItems();
                await loadFeedLogs();
                await loadEmployees();
                await loadExpenses();
                await loadSales();
                await loadDebts();
                await loadStats();
            }
        }

        // =================== AUTO MONTHLY SALARY ===================
        
        async function checkAndAddMonthlySalaries() {
            // Get current month and year
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-12
            const currentYear = now.getFullYear();
            const firstDayOfMonth = `${currentYear}-${String(currentMonth).padStart(2, '0')}-01`;

            // Get active employees with fixed salary
            const { data: employees, error } = await supabase
                .from('project_employees')
                .select(`
                    *,
                    employees!inner(name)
                `)
                .eq('user_id', currentUser.id)
                .eq('project_id', currentProject.id)
                .eq('status', 'active')
                .eq('salary_type', 'fixed');

            if (error || !employees || employees.length === 0) return;

            for (const emp of employees) {
                // Check if salary for this month already exists
                const { data: existingSalary } = await supabase
                    .from('expenses')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('project_id', currentProject.id)
                    .eq('employee_id', emp.employee_id)
                    .eq('category', 'ÿ±Ÿàÿßÿ™ÿ®')
                    .gte('expense_date', firstDayOfMonth)
                    .lt('expense_date', `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-01`);

                // If no salary for this month, add it
                if (!existingSalary || existingSalary.length === 0) {
                    await supabase.from('expenses').insert({
                        user_id: currentUser.id,
                        project_id: currentProject.id,
                        employee_id: emp.employee_id,
                        category: 'ÿ±Ÿàÿßÿ™ÿ®',
                        amount: emp.salary_amount,
                        description: `ÿ±ÿßÿ™ÿ® ÿ¥Ÿáÿ±Ÿä: ${emp.employees.name} - ${currentMonth}/${currentYear}`,
                        expense_date: firstDayOfMonth,
                        payment_method: 'ŸÜŸÇÿØŸä'
                    });
                }
            }
        }

        init();
    </script>
</body>
</html>
