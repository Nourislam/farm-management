<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø±ÙˆØ¹ ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø£ØºÙ†Ø§Ù…</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; direction: rtl; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #5d4037 0%, #8d6e63 100%); color: white; padding: 20px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(93, 64, 55, 0.3); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .project-title { display: flex; align-items: center; gap: 15px; }
        .project-title h1 { font-size: 28px; font-weight: 700; }
        .project-icon { font-size: 40px; }
        .project-status { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 14px; font-weight: 600; }
        .status-active { background: #4caf50; color: white; }
        .status-inactive { background: #ff9800; color: white; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #5d4037; color: white; }
        .btn-primary:hover { background: #4e342e; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(93, 64, 55, 0.4); }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 5px 12px; font-size: 12px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
        .stat-card-header { display: flex; justify-content: space-between; align-items: center; }
        .stat-card-icon { font-size: 32px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .stat-card-title { font-size: 14px; color: #6c757d; font-weight: 600; }
        .stat-card-value { font-size: 32px; font-weight: 700; color: #5d4037; margin: 10px 0; }
        .stat-card-subtitle { font-size: 12px; color: #6c757d; }
        .tabs { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 30px; }
        .tab-header { display: flex; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; overflow-x: auto; }
        .tab-button { padding: 15px 25px; background: none; border: none; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 14px; color: #6c757d; transition: all 0.3s; white-space: nowrap; }
        .tab-button.active { background: white; color: #5d4037; border-bottom: 3px solid #5d4037; }
        .tab-button:hover:not(.active) { background: #e9ecef; }
        .tab-content { padding: 30px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 15px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 20px 25px; background: #5d4037; color: white; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 20px; font-weight: 700; }
        .modal-close { background: none; border: none; color: white; font-size: 28px; cursor: pointer; line-height: 1; padding: 0; width: 30px; height: 30px; }
        .modal-body { padding: 25px; }
        .modal-footer { padding: 20px 25px; background: #f8f9fa; border-radius: 0 0 15px 15px; display: flex; justify-content: flex-end; gap: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 14px; }
        .form-control { width: 100%; padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Cairo', sans-serif; font-size: 14px; transition: border-color 0.3s; }
        .form-control:focus { outline: none; border-color: #5d4037; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        select.form-control { cursor: pointer; }
        textarea.form-control { resize: vertical; min-height: 100px; }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: #f8f9fa; }
        th, td { padding: 12px 15px; text-align: right; border-bottom: 1px solid #e0e0e0; }
        th { font-weight: 700; color: #5d4037; font-size: 14px; }
        td { font-size: 13px; }
        tbody tr:hover { background: #f8f9fa; }
        .filters-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 60px; height: 60px; border: 6px solid #f0f0f0; border-top: 6px solid #5d4037; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-secondary { background: #e2e3e5; color: #383d41; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .info-box { background: #e3f2fd; border: 1px solid #90caf9; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .info-box p { margin: 5px 0; font-size: 13px; }
        .material-item { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .material-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; animation: fadeIn 0.3s; }
        .alert.show { display: block; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: flex-start; }
            .stats-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .filters-row { grid-template-columns: 1fr; }
            .modal-content { width: 95%; }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #5d4037; font-weight: 600;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="project-title">
                    <span class="project-icon">ğŸ‘</span>
                    <div>
                        <h1 id="projectName">Ù…Ø´Ø±ÙˆØ¹ ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø£ØºÙ†Ø§Ù…</h1>
                        <span id="projectStatus" class="project-status status-active">Ù†Ø´Ø·</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-info btn-sm" onclick="window.location.href='index.html'">ğŸ  Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <button class="btn btn-warning btn-sm" onclick="editProject()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
                    <button class="btn btn-warning btn-sm" id="toggleStatusBtn" onclick="toggleProjectStatus()">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteProject()">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
        <div id="successAlert" class="alert alert-success"></div>
        <div id="errorAlert" class="alert alert-danger"></div>
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-card-header"><div><div class="stat-card-title">Ø§Ù„Ù†Ø¹Ø§Ø¬</div><div class="stat-card-value" id="ewesCount">0</div><div class="stat-card-subtitle">Ø¥Ù†Ø§Ø« Ø¨Ø§Ù„ØºØ©</div></div><div class="stat-card-icon" style="background: #fce4ec; color: #e91e63;">ğŸ‘</div></div></div>
            <div class="stat-card"><div class="stat-card-header"><div><div class="stat-card-title">Ø§Ù„Ø­Ù…Ù„Ø§Ù†</div><div class="stat-card-value" id="lambsCount">0</div><div class="stat-card-subtitle">ØµØºØ§Ø± (Ø£Ù‚Ù„ Ù…Ù† Ø³Ù†Ø©)</div></div><div class="stat-card-icon" style="background: #fff3e0; color: #ff9800;">ğŸ</div></div></div>
            <div class="stat-card"><div class="stat-card-header"><div><div class="stat-card-title">Ø§Ù„ÙƒØ¨Ø§Ø´</div><div class="stat-card-value" id="ramsCount">0</div><div class="stat-card-subtitle">Ø°ÙƒÙˆØ± Ø¨Ø§Ù„ØºØ©</div></div><div class="stat-card-icon" style="background: #e3f2fd; color: #2196f3;">ğŸ</div></div></div>
            <div class="stat-card"><div class="stat-card-header"><div><div class="stat-card-title">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div><div class="stat-card-value" id="totalCount">0</div><div class="stat-card-subtitle">Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ©</div></div><div class="stat-card-icon" style="background: #f3e5f5; color: #9c27b0;">ğŸ‘</div></div></div>
        </div>
        <div class="tabs">
            <div class="tab-header">
                <button class="tab-button active" onclick="showTab('animals')">ğŸ‘ Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</button>
                <button class="tab-button" onclick="showTab('health')">ğŸ’‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµØ­ÙŠØ©</button>
                <button class="tab-button" onclick="showTab('births')">ğŸ‘¶ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª</button>
                <button class="tab-button" onclick="showTab('feeding')">ğŸŒ¾ Ø§Ù„ØªØºØ°ÙŠØ©</button>
                <button class="tab-button" onclick="showTab('sales')">ğŸ’° Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</button>
                <button class="tab-button" onclick="showTab('loans')">ğŸ Ù‚Ø±ÙˆØ¶ Ø§Ù„Ø¹ÙŠØ¯</button>
                <button class="tab-button" onclick="showTab('expenses')">ğŸ’¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</button>
            </div>
            <div id="animalsTab" class="tab-content tab-pane active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #5d4037;">ğŸ‘ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</h3>
                    <button class="btn btn-primary" onclick="openAddAnimalModal()">â• Ø¥Ø¶Ø§ÙØ© Ø­ÙŠÙˆØ§Ù†</button>
                </div>
                <div class="filters-row">
                    <div class="form-group"><label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†</label><select class="form-control" id="filterStatus" onchange="loadAnimals()"><option value="">Ø§Ù„ÙƒÙ„</option><option value="alive" selected>Ø­ÙŠ</option><option value="sold">Ù…Ø¨Ø§Ø¹</option><option value="died">Ù†Ø§ÙÙ‚</option><option value="slaughtered">Ù…Ø°Ø¨ÙˆØ­</option></select></div>
                    <div class="form-group"><label class="form-label">Ø§Ù„Ø¬Ù†Ø³</label><select class="form-control" id="filterSex" onchange="loadAnimals()"><option value="">Ø§Ù„ÙƒÙ„</option><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option></select></div>
                </div>
                <div class="table-container"><table><thead><tr><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="animalsTableBody"><tr><td colspan="9" style="text-align: center; padding: 40px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table></div>
            </div>
            <div id="healthTab" class="tab-content tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #5d4037;">ğŸ’‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØµØ­ÙŠØ©</h3>
                    <button class="btn btn-primary" onclick="openAddHealthRecordModal()">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØµØ­ÙŠ</button>
                </div>
                <div class="table-container"><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¬Ù„</th><th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="healthTableBody"><tr><td colspan="8" style="text-align: center; padding: 40px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table></div>
            </div>
            <div id="birthsTab" class="tab-content tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #5d4037;">ğŸ‘¶ Ø³Ø¬Ù„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø§Øª</h3>
                    <button class="btn btn-primary" onclick="openAddBirthModal()">â• ØªØ³Ø¬ÙŠÙ„ ÙˆÙ„Ø§Ø¯Ø©</button>
                </div>
                <div class="table-container"><table><thead><tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</th><th>Ø§Ù„Ø£Ù…</th><th>Ø§Ù„Ø£Ø¨</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</th><th>Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</th><th>Ø§Ù„ÙˆÙÙŠØ§Øª</th><th>Ù…ØªÙˆØ³Ø· Ø§Ù„ÙˆØ²Ù†</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="birthsTableBody"><tr><td colspan="9" style="text-align: center; padding: 40px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table></div>
            </div>
            <div id="feedingTab" class="tab-content tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #5d4037;">ğŸŒ¾ Ø³Ø¬Ù„ Ø§Ù„ØªØºØ°ÙŠØ©</h3>
                    <button class="btn btn-primary" onclick="openAddFeedingModal()">â• ØªØ³Ø¬ÙŠÙ„ ØªØºØ°ÙŠØ©</button>
                </div>
                <div class="table-container"><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¤ÙˆØ³</th><th>Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</th><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="feedingTableBody"><tr><td colspan="7" style="text-align: center; padding: 40px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table></div>
            </div>
            <div id="salesTab" class="tab-content tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #5d4037;">ğŸ’° Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                    <button class="btn btn-primary" onclick="openAddSaleModal()">â• ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ¹</button>
                </div>
                <div class="table-container"><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ù…Ø´ØªØ±ÙŠ</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="salesTableBody"><tr><td colspan="9" style="text-align: center; padding: 40px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table></div>
            </div>
            <div id="loansTab" class="tab-content tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #5d4037;">ğŸ Ù‚Ø±ÙˆØ¶ Ø§Ù„Ø¹ÙŠØ¯</h3>
                    <button class="btn btn-primary" onclick="openAddLoanModal()">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø±Ø¶</button>
                </div>
                <div class="table-container"><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ù‚ØªØ±Ø¶</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø©</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="loansTableBody"><tr><td colspan="9" style="text-align: center; padding: 40px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table></div>
            </div>
            <div id="expensesTab" class="tab-content tab-pane">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #5d4037;">ğŸ’¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
                    <button class="btn btn-primary" onclick="openAddExpenseModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                </div>
                <div class="filters-row">
                    <div class="form-group"><label class="form-label">Ø§Ù„ÙØ¦Ø©</label><select class="form-control" id="filterExpenseCategory" onchange="loadExpenses()"><option value="">Ø§Ù„ÙƒÙ„</option><option value="feeding">ØªØºØ°ÙŠØ©</option><option value="health">ØµØ­Ø©</option><option value="labor">Ø£Ø¬ÙˆØ± Ø¹Ù…Ø§Ù„</option><option value="cleaning">ØªÙ†Ø¸ÙŠÙ</option><option value="sterilization">ØªØ¹Ù‚ÙŠÙ…</option><option value="maintenance">ØµÙŠØ§Ù†Ø©</option><option value="other">Ø£Ø®Ø±Ù‰</option></select></div>
                </div>
                <div class="table-container"><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="expensesTableBody"><tr><td colspan="8" style="text-align: center; padding: 40px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table></div>
            </div>
        </div>
    </div>
    <div id="modalsContainer"></div>
    <script>
        const SUPABASE_URL='https://sstvsknmmhbwubzajeix.supabase.co';
        const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdHZza25tbWhid3ViemFqZWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDM0NjIsImV4cCI6MjA3NDkxOTQ2Mn0.EeVUU9DxRYUi38nUHgWEsnG8li7KZjqAGPNW9IDokhg';
        const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
        let currentUser=null,currentProjectId=null,currentProject=null,allAnimals=[],inventoryItems=[],feedMaterialCounter=0;
        
        window.addEventListener('DOMContentLoaded',async()=>{
            await checkAuth();
            await loadProject();
            await loadStats();
            await loadAnimals();
            createAllModals();
            setDefaultDate();
            hideLoading();
        });
        
        function hideLoading(){document.getElementById('loading').style.display='none';}
        
        async function checkAuth(){
            const{data:{user},error}=await supabase.auth.getUser();
            if(error||!user){window.location.href='login.html';return;}
            currentUser=user;
        }
        
        async function loadProject(){
            const urlParams=new URLSearchParams(window.location.search);
            currentProjectId=urlParams.get('id');
            if(!currentProjectId){showError('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');return;}
            try{
                const{data,error}=await supabase.from('projects').select('*').eq('id',currentProjectId).single();
                if(error)throw error;
                currentProject=data;
                document.getElementById('projectName').textContent=data.name;
                const statusBadge=document.getElementById('projectStatus');
                const toggleBtn=document.getElementById('toggleStatusBtn');
                if(data.status==='active'){
                    statusBadge.textContent='Ù†Ø´Ø·';
                    statusBadge.className='project-status status-active';
                    toggleBtn.innerHTML='â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù';
                }else{
                    statusBadge.textContent='Ù…ØªÙˆÙ‚Ù';
                    statusBadge.className='project-status status-inactive';
                    toggleBtn.innerHTML='â–¶ï¸ ØªÙØ¹ÙŠÙ„';
                }
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹');
            }
        }
        
        async function loadStats(){
            try{
                const{data:animals,error}=await supabase.from('animals').select('*').eq('project_id',currentProjectId).eq('status','alive');
                if(error)throw error;
                
                const today=new Date();
                
                let lambs=0;
                let ewes=0;
                let rams=0;
                
                animals.forEach(animal=>{
                    if(animal.birth_date){
                        const birthDate=new Date(animal.birth_date);
                        const ageInDays=Math.floor((today-birthDate)/(1000*60*60*24));
                        const isLamb=ageInDays<365;
                        
                        if(isLamb){
                            lambs++;
                        }else{
                            if(animal.sex==='female'){ewes++;}
                            else if(animal.sex==='male'){rams++;}
                        }
                    }else{
                        if(animal.sex==='female'){ewes++;}
                        else if(animal.sex==='male'){rams++;}
                    }
                });
                
                const total=animals.length;
                console.log('Stats:',{total:total,ewes:ewes,rams:rams,lambs:lambs});
                
                document.getElementById('ewesCount').textContent=ewes;
                document.getElementById('ramsCount').textContent=rams;
                document.getElementById('lambsCount').textContent=lambs;
                document.getElementById('totalCount').textContent=total;
            }catch(error){
                console.error('Error loading stats:',error);
            }
        }
        
        function showTab(tabName){
            const tabs=document.querySelectorAll('.tab-pane');
            tabs.forEach(tab=>tab.classList.remove('active'));
            const buttons=document.querySelectorAll('.tab-button');
            buttons.forEach(btn=>btn.classList.remove('active'));
            document.getElementById(tabName+'Tab').classList.add('active');
            event.target.classList.add('active');
            
            switch(tabName){
                case'animals':loadAnimals();break;
                case'health':loadHealthRecords();break;
                case'births':loadBirths();break;
                case'feeding':loadFeedings();break;
                case'sales':loadSales();break;
                case'loans':loadLoans();break;
                case'expenses':loadExpenses();break;
            }
        }
        
        async function loadAnimals(){
            const tbody=document.getElementById('animalsTableBody');
            tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            try{
                let query=supabase.from('animals').select('*').eq('project_id',currentProjectId).order('created_at',{ascending:false});
                const filterStatus=document.getElementById('filterStatus').value;
                const filterSex=document.getElementById('filterSex').value;
                if(filterStatus)query=query.eq('status',filterStatus);
                if(filterSex)query=query.eq('sex',filterSex);
                const{data,error}=await query;
                if(error)throw error;
                allAnimals=data||[];
                if(data.length===0){
                    tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙŠÙˆØ§Ù†Ø§Øª</td></tr>';
                    return;
                }
                tbody.innerHTML=data.map(animal=>`<tr><td>${animal.tag_number}</td><td>${translateSpecies(animal.species)}</td><td>${translateSex(animal.sex)}</td><td>${animal.birth_date?formatDate(animal.birth_date):'-'}</td><td>${animal.birth_date?calculateAge(animal.birth_date):'-'}</td><td>${animal.weight_kg||'-'}</td><td><span class="badge badge-${getStatusColor(animal.status)}">${translateStatus(animal.status)}</span></td><td><span class="badge badge-${getHealthColor(animal.health_status)}">${translateHealthStatus(animal.health_status)}</span></td><td><button class="btn btn-warning btn-sm" onclick='editAnimal(${JSON.stringify(animal).replace(/'/g,"&apos;")})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger btn-sm" onclick="deleteAnimal('${animal.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`).join('');
            }catch(error){
                console.error('Error:',error);
                tbody.innerHTML='<tr><td colspan="9" style="text-align: center; color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
            }
        }
        
        async function loadHealthRecords(){
            const tbody=document.getElementById('healthTableBody');
            tbody.innerHTML='<tr><td colspan="8" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            try{
                const{data,error}=await supabase.from('health_records').select('*, animals(tag_number)').eq('user_id',currentUser.id).order('date',{ascending:false});
                if(error)throw error;
                if(data.length===0){
                    tbody.innerHTML='<tr><td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØµØ­ÙŠØ©</td></tr>';
                    return;
                }
                tbody.innerHTML=data.map(record=>`<tr><td>${formatDate(record.date)}</td><td>${record.animals?.tag_number||'-'}</td><td>${translateRecordType(record.record_type)}</td><td>${record.vaccine_name||record.disease_name||'-'}</td><td>${record.veterinarian_name||'-'}</td><td>${record.cost?record.cost+' Ø¯Ø¬':'-'}</td><td>${record.next_date?formatDate(record.next_date):'-'}</td><td><button class="btn btn-warning btn-sm" onclick='editHealthRecord(${JSON.stringify(record).replace(/'/g,"&apos;")})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger btn-sm" onclick="deleteHealthRecord('${record.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`).join('');
            }catch(error){
                console.error('Error:',error);
                tbody.innerHTML='<tr><td colspan="8" style="text-align: center; color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
            }
        }
        
        async function loadBirths(){
            const tbody=document.getElementById('birthsTableBody');
            tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            try{
                const{data,error}=await supabase.from('births').select('*, mother:mother_id(tag_number), father:father_id(tag_number)').eq('project_id',currentProjectId).order('actual_birth_date',{ascending:false});
                if(error)throw error;
                if(data.length===0){
                    tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆÙ„Ø§Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                    return;
                }
                tbody.innerHTML=data.map(birth=>`<tr><td>${birth.actual_birth_date?formatDate(birth.actual_birth_date):'-'}</td><td>${birth.mother?.tag_number||'-'}</td><td>${birth.father?.tag_number||'-'}</td><td>${birth.total_born||0}</td><td>${birth.alive_count||0}</td><td>${birth.dead_count||0}</td><td>${birth.average_birth_weight?birth.average_birth_weight+' ÙƒØ¬Ù…':'-'}</td><td>${birth.notes||'-'}</td><td><button class="btn btn-warning btn-sm" onclick='editBirth(${JSON.stringify(birth).replace(/'/g,"&apos;")})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger btn-sm" onclick="deleteBirth('${birth.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`).join('');
            }catch(error){
                console.error('Error:',error);
                tbody.innerHTML='<tr><td colspan="9" style="text-align: center; color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
            }
        }
        
        async function loadFeedings(){
            const tbody=document.getElementById('feedingTableBody');
            tbody.innerHTML='<tr><td colspan="7" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            try{
                const{data,error}=await supabase.from('feed_log').select('*').eq('project_id',currentProjectId).order('feed_date',{ascending:false});
                if(error)throw error;
                if(data.length===0){
                    tbody.innerHTML='<tr><td colspan="7" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØªØºØ°ÙŠØ©</td></tr>';
                    return;
                }
                tbody.innerHTML=data.map(feed=>`<tr><td>${formatDate(feed.feed_date)}</td><td>${feed.animals_count||'-'}</td><td>${formatFeedItems(feed.feed_items)}</td><td>${feed.total_cost?feed.total_cost+' Ø¯Ø¬':'-'}</td><td>${feed.fed_by||'-'}</td><td>${feed.notes||'-'}</td><td><button class="btn btn-warning btn-sm" onclick='editFeeding(${JSON.stringify(feed).replace(/'/g,"&apos;")})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger btn-sm" onclick="deleteFeeding('${feed.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`).join('');
            }catch(error){
                console.error('Error:',error);
                tbody.innerHTML='<tr><td colspan="7" style="text-align: center; color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
            }
        }
        
        async function loadSales(){
            const tbody=document.getElementById('salesTableBody');
            tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            try{
                const{data,error}=await supabase.from('sales').select('*').eq('project_id',currentProjectId).order('sale_date',{ascending:false});
                if(error)throw error;
                if(data.length===0){
                    tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                    return;
                }
                tbody.innerHTML=data.map(sale=>`<tr><td>${formatDate(sale.sale_date)}</td><td>${translateItemType(sale.item_type)}</td><td>${sale.item_description||'-'}</td><td>${sale.quantity} ${translateUnit(sale.unit)}</td><td>${sale.total_amount} Ø¯Ø¬</td><td>${sale.buyer_name||'-'}</td><td><span class="badge badge-${getPaymentStatusColor(sale.payment_status)}">${translatePaymentStatus(sale.payment_status)}</span></td><td>${sale.amount_remaining?sale.amount_remaining+' Ø¯Ø¬':'-'}</td><td><button class="btn btn-warning btn-sm" onclick='editSale(${JSON.stringify(sale).replace(/'/g,"&apos;")})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger btn-sm" onclick="deleteSale('${sale.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`).join('');
            }catch(error){
                console.error('Error:',error);
                tbody.innerHTML='<tr><td colspan="9" style="text-align: center; color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
            }
        }
        
        async function loadLoans(){
            const tbody=document.getElementById('loansTableBody');
            tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            try{
                const{data,error}=await supabase.from('sheep_loans').select('*, animals(tag_number)').eq('project_id',currentProjectId).order('loan_date',{ascending:false});
                if(error)throw error;
                if(data.length===0){
                    tbody.innerHTML='<tr><td colspan="9" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±ÙˆØ¶ Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                    return;
                }
                tbody.innerHTML=data.map(loan=>{
                    const remaining=loan.loan_amount-(loan.amount_paid||0);
                    const status=remaining<=0?'paid':(loan.amount_paid>0?'partial':'pending');
                    return`<tr><td>${formatDate(loan.loan_date)}</td><td>${loan.borrower_name}</td><td>${loan.borrower_phone}</td><td>${loan.animals?.tag_number||'-'}</td><td>${loan.loan_amount} Ø¯Ø¬</td><td>${loan.amount_paid||0} Ø¯Ø¬</td><td>${remaining.toFixed(2)} Ø¯Ø¬</td><td><span class="badge badge-${getPaymentStatusColor(status)}">${translatePaymentStatus(status)}</span></td><td>${remaining>0?`<button class="btn btn-success btn-sm" onclick="recordLoanPayment('${loan.id}',${remaining})">ğŸ’° Ø¯ÙØ¹Ø©</button>`:''} <button class="btn btn-danger btn-sm" onclick="deleteLoan('${loan.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`;
                }).join('');
            }catch(error){
                console.error('Error:',error);
                tbody.innerHTML='<tr><td colspan="9" style="text-align: center; color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
            }
        }
        
        async function loadExpenses(){
            const tbody=document.getElementById('expensesTableBody');
            tbody.innerHTML='<tr><td colspan="8" style="text-align: center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            try{
                let query=supabase.from('expenses').select('*').eq('project_id',currentProjectId).order('expense_date',{ascending:false});
                const filterCategory=document.getElementById('filterExpenseCategory').value;
                if(filterCategory)query=query.eq('category',filterCategory);
                const{data,error}=await query;
                if(error)throw error;
                if(data.length===0){
                    tbody.innerHTML='<tr><td colspan="8" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù…Ø³Ø¬Ù„Ø©</td></tr>';
                    return;
                }
                tbody.innerHTML=data.map(expense=>`<tr><td>${formatDate(expense.expense_date)}</td><td>${translateExpenseCategory(expense.category)}</td><td>${expense.description}</td><td>${expense.amount} Ø¯Ø¬</td><td>${expense.paid_to||'-'}</td><td>${translatePaymentMethod(expense.payment_method)}</td><td>${expense.notes||'-'}</td><td><button class="btn btn-warning btn-sm" onclick='editExpense(${JSON.stringify(expense).replace(/'/g,"&apos;")})'>âœï¸ ØªØ¹Ø¯ÙŠÙ„</button> <button class="btn btn-danger btn-sm" onclick="deleteExpense('${expense.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`).join('');
            }catch(error){
                console.error('Error:',error);
                tbody.innerHTML='<tr><td colspan="8" style="text-align: center; color: red;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
            }
        }
        
        function createAllModals(){
            document.getElementById('modalsContainer').innerHTML=`${createAnimalModal()}${createHealthModal()}${createBirthModal()}${createFeedingModal()}${createSaleModal()}${createLoanModal()}${createExpenseModal()}`;
        }
        
        function createAnimalModal(){
            return`<div id="animalModal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="animalModalTitle">Ø¥Ø¶Ø§ÙØ© Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯</h3><button class="modal-close" onclick="closeModal('animalModal')">&times;</button></div><div class="modal-body"><form id="animalForm"><input type="hidden" id="animalId"><div class="form-row"><div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù„Ø§Ù…Ø© *</label><input type="text" class="form-control" id="animalTag" required></div><div class="form-group"><label class="form-label">Ø§Ù„Ù†ÙˆØ¹ *</label><select class="form-control" id="animalSpecies" required><option value="sheep">ØºÙ†Ù…</option><option value="goat">Ù…Ø§Ø¹Ø²</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„Ø¬Ù†Ø³ *</label><select class="form-control" id="animalSex" required><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option></select></div><div class="form-group"><label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input type="date" class="form-control" id="animalBirthDate"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input type="number" step="0.1" class="form-control" id="animalWeight"></div><div class="form-group"><label class="form-label">Ø§Ù„Ø³Ù„Ø§Ù„Ø©</label><input type="text" class="form-control" id="animalBreed"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„Ù„ÙˆÙ†</label><input type="text" class="form-control" id="animalColor"></div><div class="form-group"><label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ©</label><select class="form-control" id="animalHealthStatus"><option value="healthy">Ø³Ù„ÙŠÙ…</option><option value="sick">Ù…Ø±ÙŠØ¶</option><option value="quarantine">Ø­Ø¬Ø± ØµØ­ÙŠ</option><option value="treatment">ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬</option></select></div></div><div class="form-group"><label class="form-label">Ø¹Ù„Ø§Ù…Ø§Øª Ù…Ù…ÙŠØ²Ø©</label><textarea class="form-control" id="animalMarks"></textarea></div><div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-control" id="animalNotes"></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('animalModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-primary" onclick="saveAnimal()">Ø­ÙØ¸</button></div></div></div>`;
        }
        
        function createHealthModal(){
            return`<div id="healthModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ ØµØ­ÙŠ</h3><button class="modal-close" onclick="closeModal('healthModal')">&times;</button></div><div class="modal-body"><form id="healthForm"><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„Ø­ÙŠÙˆØ§Ù† *</label><select class="form-control" id="healthAnimal" required><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠÙˆØ§Ù†</option></select></div><div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¬Ù„ *</label><select class="form-control" id="healthRecordType" required><option value="vaccination">ØªØ·Ø¹ÙŠÙ…</option><option value="treatment">Ø¹Ù„Ø§Ø¬</option><option value="checkup">ÙØ­Øµ</option><option value="disease">Ù…Ø±Ø¶</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label><input type="date" class="form-control" id="healthDate" required></div><div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù„Ù‚Ø§Ø­/Ø§Ù„Ù…Ø±Ø¶</label><input type="text" class="form-control" id="healthName"></div></div><div class="form-group"><label class="form-label">Ø§Ù„Ø¹Ù„Ø§Ø¬/Ø§Ù„ØªÙØ§ØµÙŠÙ„</label><textarea class="form-control" id="healthTreatment"></textarea></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø¨ÙŠØ·Ø±ÙŠ</label><input type="text" class="form-control" id="healthVet"></div><div class="form-group"><label class="form-label">Ù‡Ø§ØªÙ Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input type="tel" class="form-control" id="healthVetPhone"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„ØªÙƒÙ„ÙØ©</label><input type="number" step="0.01" class="form-control" id="healthCost"></div><div class="form-group"><label class="form-label">Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ</label><input type="date" class="form-control" id="healthNextDate"></div></div><div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-control" id="healthNotes"></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('healthModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-primary" onclick="saveHealthRecord()">Ø­ÙØ¸</button></div></div></div>`;
        }
        
        function createBirthModal(){
            return`<div id="birthModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>ØªØ³Ø¬ÙŠÙ„ ÙˆÙ„Ø§Ø¯Ø©</h3><button class="modal-close" onclick="closeModal('birthModal')">&times;</button></div><div class="modal-body"><form id="birthForm"><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„Ø£Ù… *</label><select class="form-control" id="birthMother" required><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ù…</option></select></div><div class="form-group"><label class="form-label">Ø§Ù„Ø£Ø¨</label><select class="form-control" id="birthFather"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£Ø¨</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ„Ù‚ÙŠØ­</label><input type="date" class="form-control" id="birthMatingDate"></div><div class="form-group"><label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</label><input type="date" class="form-control" id="birthExpectedDate"></div></div><div class="form-row"><div class="form-group"><label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø§Ù„ÙØ¹Ù„ÙŠ *</label><input type="date" class="form-control" id="birthActualDate" required></div><div class="form-group"><label class="form-label">Ù…ØªÙˆØ³Ø· ÙˆØ²Ù† Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ (ÙƒØ¬Ù…)</label><input type="number" step="0.1" class="form-control" id="birthAvgWeight"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯ *</label><input type="number" class="form-control" id="birthTotal" required min="0"></div><div class="form-group"><label class="form-label">Ø§Ù„Ø£Ø­ÙŠØ§Ø¡ *</label><input type="number" class="form-control" id="birthAlive" required min="0"></div></div><div class="form-group"><label class="form-label">Ø§Ù„ÙˆÙÙŠØ§Øª</label><input type="number" class="form-control" id="birthDead" value="0" min="0"></div><div class="form-group"><label class="form-label">Ù…Ø¶Ø§Ø¹ÙØ§Øª</label><textarea class="form-control" id="birthComplications"></textarea></div><div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-control" id="birthNotes"></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('birthModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-primary" onclick="saveBirth()">Ø­ÙØ¸</button></div></div></div>`;
        }
        
        function createFeedingModal(){
            return`<div id="feedingModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>ØªØ³Ø¬ÙŠÙ„ ØªØºØ°ÙŠØ©</h3><button class="modal-close" onclick="closeModal('feedingModal')">&times;</button></div><div class="modal-body"><form id="feedingForm"><div class="info-box"><p><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</p></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label><input type="date" class="form-control" id="feedDate" required></div><div class="form-group"><label class="form-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¤ÙˆØ³</label><input type="number" class="form-control" id="feedAnimalsCount" min="0"></div></div><div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„ØªØºØ°ÙŠØ©</label><input type="text" class="form-control" id="feedFedBy"></div><div class="form-group"><label class="form-label">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©</label><button type="button" class="btn btn-success btn-sm" onclick="addFeedMaterial()" style="margin-bottom: 10px;">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button><div id="feedMaterialsContainer"></div></div><div class="form-group"><label class="form-label">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</label><input type="number" step="0.01" class="form-control" id="feedTotalCost" readonly></div><div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-control" id="feedNotes"></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('feedingModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-primary" onclick="saveFeeding()">Ø­ÙØ¸</button></div></div></div>`;
        }
        
        function createSaleModal(){
            return`<div id="saleModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ¹</h3><button class="modal-close" onclick="closeModal('saleModal')">&times;</button></div><div class="modal-body"><form id="saleForm"><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label><input type="date" class="form-control" id="saleDate" required></div><div class="form-group"><label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†ØªØ¬ *</label><select class="form-control" id="saleItemType" required><option value="live_animal">Ø­ÙŠÙˆØ§Ù† Ø­ÙŠ</option><option value="meat">Ù„Ø­ÙˆÙ…</option><option value="wool">ØµÙˆÙ</option><option value="milk">Ø­Ù„ÙŠØ¨</option><option value="other">Ø£Ø®Ø±Ù‰</option></select></div></div><div class="form-group"><label class="form-label">ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬</label><input type="text" class="form-control" id="saleDescription"></div><div class="form-group"><label class="form-label">Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><select class="form-control" id="saleAnimal"><option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option></select></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© *</label><input type="number" step="0.01" class="form-control" id="saleQuantity" required oninput="calculateSaleTotal()"></div><div class="form-group"><label class="form-label">Ø§Ù„ÙˆØ­Ø¯Ø© *</label><select class="form-control" id="saleUnit" required><option value="head">Ø±Ø£Ø³</option><option value="kg">ÙƒØ¬Ù…</option><option value="liter">Ù„ØªØ±</option><option value="piece">Ù‚Ø·Ø¹Ø©</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><input type="number" step="0.01" class="form-control" id="saleUnitPrice" oninput="calculateSaleTotal()"></div><div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ *</label><input type="number" step="0.01" class="form-control" id="saleTotalAmount" required></div></div><div class="info-box"><p><strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø© Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø­Ø³Ø§Ø¨Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø´ØªØ±ÙŠ</label><input type="text" class="form-control" id="saleBuyerName"></div><div class="form-group"><label class="form-label">Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø´ØªØ±ÙŠ</label><input type="tel" class="form-control" id="saleBuyerPhone"></div></div><div class="form-group"><label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø´ØªØ±ÙŠ</label><input type="text" class="form-control" id="saleBuyerAddress"></div><div class="form-row"><div class="form-group"><label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><select class="form-control" id="salePaymentMethod"><option value="cash">Ù†Ù‚Ø¯ÙŠ</option><option value="bank_transfer">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option><option value="check">Ø´ÙŠÙƒ</option><option value="installment">ØªÙ‚Ø³ÙŠØ·</option></select></div><div class="form-group"><label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ *</label><select class="form-control" id="salePaymentStatus" required onchange="toggleSalePaymentFields()"><option value="paid">Ù…Ø¯ÙÙˆØ¹</option><option value="partial">Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ</option><option value="pending">Ù…Ø¹Ù„Ù‚</option></select></div></div><div class="form-row" id="salePaymentDetailsRow" style="display: none;"><div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label><input type="number" step="0.01" class="form-control" id="saleAmountPaid" oninput="calculateSaleRemaining()"></div><div class="form-group"><label class="form-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label><input type="number" step="0.01" class="form-control" id="saleAmountRemaining" readonly></div></div><div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-control" id="saleNotes"></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('saleModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-primary" onclick="saveSale()">Ø­ÙØ¸</button></div></div></div>`;
        }
        
        function createLoanModal(){
            return`<div id="loanModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø±Ø¶ Ø¹ÙŠØ¯</h3><button class="modal-close" onclick="closeModal('loanModal')">&times;</button></div><div class="modal-body"><form id="loanForm"><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label><input type="date" class="form-control" id="loanDate" required></div><div class="form-group"><label class="form-label">Ø§Ù„Ø­ÙŠÙˆØ§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><select class="form-control" id="loanAnimal"><option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option></select></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù‚ØªØ±Ø¶ *</label><input type="text" class="form-control" id="loanBorrowerName" required></div><div class="form-group"><label class="form-label">Ù‡Ø§ØªÙ Ø§Ù„Ù…Ù‚ØªØ±Ø¶ *</label><input type="tel" class="form-control" id="loanBorrowerPhone" required></div></div><div class="form-group"><label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‚ØªØ±Ø¶</label><input type="text" class="form-control" id="loanBorrowerAddress"></div><div class="form-row"><div class="form-group"><label class="form-label">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø±Ø¶ *</label><input type="number" step="0.01" class="form-control" id="loanAmount" required></div><div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label><input type="number" step="0.01" class="form-control" id="loanAmountPaid" value="0"></div></div><div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-control" id="loanNotes"></textarea></div></form></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('loanModal')">Ø¥Ù„ØºØ§Ø¡</button><button class="btn btn-primary" onclick="saveLoan()">Ø­ÙØ¸</button></div></div></div>`;
        }
        
        function createExpenseModal(){
            return`<div id="expenseModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3><button class="modal-close" onclick="closeModal('expenseModal')">&times;</button></div><div class="modal-body"><form id="expenseForm" onsubmit="event.preventDefault(); saveExpense();"><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label><input type="date" class="form-control" id="expenseDate" required></div><div class="form-group"><label class="form-label">Ø§Ù„ÙØ¦Ø© *</label><select class="form-control" id="expenseCategory" required><option value="feeding">ØªØºØ°ÙŠØ©</option><option value="health">ØµØ­Ø©</option><option value="labor">Ø£Ø¬ÙˆØ± Ø¹Ù…Ø§Ù„</option><option value="cleaning">ØªÙ†Ø¸ÙŠÙ</option><option value="sterilization">ØªØ¹Ù‚ÙŠÙ…</option><option value="maintenance">ØµÙŠØ§Ù†Ø©</option><option value="other">Ø£Ø®Ø±Ù‰</option></select></div></div><div class="form-group"><label class="form-label">Ø§Ù„ÙˆØµÙ *</label><input type="text" class="form-control" id="expenseDescription" required placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±Ø§Ø¡ Ø¹Ù„ÙØŒ Ø¯ÙØ¹ Ø£Ø¬ÙˆØ± Ø¹Ø§Ù…Ù„..."></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº *</label><input type="number" step="0.01" class="form-control" id="expenseAmount" required min="0.01" placeholder="0.00"></div><div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</label><input type="text" class="form-control" id="expensePaidTo" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label><select class="form-control" id="expensePaymentMethod"><option value="cash">Ù†Ù‚Ø¯ÙŠ</option><option value="bank_transfer">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option><option value="check">Ø´ÙŠÙƒ</option></select></div><div class="form-group"><label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</label><input type="text" class="form-control" id="expenseReceiptNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø£Ùˆ Ø§Ù„ÙØ§ØªÙˆØ±Ø©"></div></div><div class="form-group"><label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea class="form-control" id="expenseNotes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea></div></form></div><div class="modal-footer"><button type="button" class="btn btn-secondary" onclick="closeModal('expenseModal')">Ø¥Ù„ØºØ§Ø¡</button><button type="button" class="btn btn-primary" onclick="saveExpense()">Ø­ÙØ¸</button></div></div></div>`;
        }
        
        function openAddAnimalModal(){
            document.getElementById('animalModalTitle').textContent='Ø¥Ø¶Ø§ÙØ© Ø­ÙŠÙˆØ§Ù† Ø¬Ø¯ÙŠØ¯';
            document.getElementById('animalForm').reset();
            document.getElementById('animalId').value='';
            document.getElementById('animalModal').classList.add('show');
        }
        
        function editAnimal(animal){
            document.getElementById('animalModalTitle').textContent='ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠÙˆØ§Ù†';
            document.getElementById('animalId').value=animal.id;
            document.getElementById('animalTag').value=animal.tag_number;
            document.getElementById('animalSpecies').value=animal.species;
            document.getElementById('animalSex').value=animal.sex;
            document.getElementById('animalBirthDate').value=animal.birth_date||'';
            document.getElementById('animalWeight').value=animal.weight_kg||'';
            document.getElementById('animalBreed').value=animal.breed||'';
            document.getElementById('animalColor').value=animal.color||'';
            document.getElementById('animalHealthStatus').value=animal.health_status;
            document.getElementById('animalMarks').value=animal.special_marks||'';
            document.getElementById('animalNotes').value=animal.notes||'';
            document.getElementById('animalModal').classList.add('show');
        }
        
        async function openAddHealthRecordModal(){
            await loadAnimalsForSelect('healthAnimal');
            document.getElementById('healthForm').reset();
            document.getElementById('healthForm').removeAttribute('data-edit-id');
            document.getElementById('healthModal').classList.add('show');
        }
        
        function editHealthRecord(record){
            document.getElementById('healthAnimal').value=record.animal_id;
            document.getElementById('healthRecordType').value=record.record_type;
            document.getElementById('healthDate').value=record.date;
            document.getElementById('healthName').value=record.vaccine_name||record.disease_name||'';
            document.getElementById('healthTreatment').value=record.treatment||'';
            document.getElementById('healthVet').value=record.veterinarian_name||'';
            document.getElementById('healthVetPhone').value=record.veterinarian_phone||'';
            document.getElementById('healthCost').value=record.cost||'';
            document.getElementById('healthNextDate').value=record.next_date||'';
            document.getElementById('healthNotes').value=record.notes||'';
            document.getElementById('healthForm').setAttribute('data-edit-id',record.id);
            document.getElementById('healthModal').classList.add('show');
        }
        
        async function openAddBirthModal(){
            await loadAnimalsForSelect('birthMother','female');
            await loadAnimalsForSelect('birthFather','male');
            document.getElementById('birthForm').reset();
            document.getElementById('birthForm').removeAttribute('data-edit-id');
            document.getElementById('birthModal').classList.add('show');
        }
        
        async function editBirth(birth){
            await loadAnimalsForSelect('birthMother','female');
            await loadAnimalsForSelect('birthFather','male');
            document.getElementById('birthMother').value=birth.mother_id;
            document.getElementById('birthFather').value=birth.father_id||'';
            document.getElementById('birthMatingDate').value=birth.mating_date||'';
            document.getElementById('birthExpectedDate').value=birth.expected_birth_date||'';
            document.getElementById('birthActualDate').value=birth.actual_birth_date;
            document.getElementById('birthTotal').value=birth.total_born;
            document.getElementById('birthAlive').value=birth.alive_count;
            document.getElementById('birthDead').value=birth.dead_count;
            document.getElementById('birthAvgWeight').value=birth.average_birth_weight||'';
            document.getElementById('birthComplications').value=birth.complications||'';
            document.getElementById('birthNotes').value=birth.notes||'';
            document.getElementById('birthForm').setAttribute('data-edit-id',birth.id);
            document.getElementById('birthModal').classList.add('show');
        }
        
        async function openAddFeedingModal(){
            await loadInventory();
            document.getElementById('feedingForm').reset();
            document.getElementById('feedingForm').removeAttribute('data-edit-id');
            document.getElementById('feedMaterialsContainer').innerHTML='';
            feedMaterialCounter=0;
            addFeedMaterial();
            document.getElementById('feedingModal').classList.add('show');
        }
        
        async function editFeeding(feed){
            await loadInventory();
            document.getElementById('feedDate').value=feed.feed_date;
            document.getElementById('feedAnimalsCount').value=feed.animals_count||'';
            document.getElementById('feedFedBy').value=feed.fed_by||'';
            document.getElementById('feedNotes').value=feed.notes||'';
            document.getElementById('feedMaterialsContainer').innerHTML='';
            feedMaterialCounter=0;
            const feedItems=typeof feed.feed_items==='string'?JSON.parse(feed.feed_items):feed.feed_items;
            feedItems.forEach(item=>{
                addFeedMaterial();
                const id=feedMaterialCounter;
                const select=document.querySelector(`.feed-material-select[data-id="${id}"]`);
                const matchingInventory=inventoryItems.find(inv=>inv.item_name===item.item_name);
                if(matchingInventory){
                    select.value=matchingInventory.id;
                    updateMaterialInfo(id);
                }
                const quantityInput=document.querySelector(`.feed-quantity[data-id="${id}"]`);
                quantityInput.value=item.quantity;
                const priceInput=document.querySelector(`.feed-unit-price[data-id="${id}"]`);
                priceInput.value=item.unit_price||0;
                calculateFeedCost();
            });
            document.getElementById('feedingForm').setAttribute('data-edit-id',feed.id);
            document.getElementById('feedingModal').classList.add('show');
        }
        
        async function openAddSaleModal(){
            await loadAnimalsForSelect('saleAnimal');
            document.getElementById('saleForm').reset();
            document.getElementById('saleForm').removeAttribute('data-edit-id');
            document.getElementById('salePaymentDetailsRow').style.display='none';
            document.getElementById('saleModal').classList.add('show');
        }
        
        async function editSale(sale){
            await loadAnimalsForSelect('saleAnimal');
            document.getElementById('saleDate').value=sale.sale_date;
            document.getElementById('saleItemType').value=sale.item_type;
            document.getElementById('saleDescription').value=sale.item_description||'';
            document.getElementById('saleAnimal').value=sale.animal_id||'';
            document.getElementById('saleQuantity').value=sale.quantity;
            document.getElementById('saleUnit').value=sale.unit;
            document.getElementById('saleUnitPrice').value=sale.unit_price||'';
            document.getElementById('saleTotalAmount').value=sale.total_amount;
            document.getElementById('saleBuyerName').value=sale.buyer_name||'';
            document.getElementById('saleBuyerPhone').value=sale.buyer_phone||'';
            document.getElementById('saleBuyerAddress').value=sale.buyer_address||'';
            document.getElementById('salePaymentMethod').value=sale.payment_method||'cash';
            document.getElementById('salePaymentStatus').value=sale.payment_status;
            document.getElementById('saleAmountPaid').value=sale.amount_paid||'';
            document.getElementById('saleAmountRemaining').value=sale.amount_remaining||'';
            document.getElementById('saleNotes').value=sale.notes||'';
            toggleSalePaymentFields();
            document.getElementById('saleForm').setAttribute('data-edit-id',sale.id);
            document.getElementById('saleModal').classList.add('show');
        }
        
        async function openAddLoanModal(){
            await loadAnimalsForSelect('loanAnimal');
            document.getElementById('loanForm').reset();
            document.getElementById('loanModal').classList.add('show');
        }
        
        function openAddExpenseModal(){
            document.getElementById('expenseForm').reset();
            document.getElementById('expenseForm').removeAttribute('data-edit-id');
            document.getElementById('expenseModal').classList.add('show');
        }
        
        function editExpense(expense){
            document.getElementById('expenseDate').value=expense.expense_date;
            document.getElementById('expenseCategory').value=expense.category;
            document.getElementById('expenseDescription').value=expense.description;
            document.getElementById('expenseAmount').value=expense.amount;
            document.getElementById('expensePaidTo').value=expense.paid_to||'';
            document.getElementById('expensePaymentMethod').value=expense.payment_method||'cash';
            document.getElementById('expenseReceiptNumber').value=expense.receipt_number||'';
            document.getElementById('expenseNotes').value=expense.notes||'';
            document.getElementById('expenseForm').setAttribute('data-edit-id',expense.id);
            document.getElementById('expenseModal').classList.add('show');
        }
        
        function closeModal(modalId){
            document.getElementById(modalId).classList.remove('show');
        }
        
        async function loadAnimalsForSelect(selectId,sex=null){
            const select=document.getElementById(selectId);
            if(!select)return;
            select.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­ÙŠÙˆØ§Ù†</option>';
            try{
                let query=supabase.from('animals').select('*').eq('project_id',currentProjectId).eq('status','alive');
                if(sex)query=query.eq('sex',sex);
                const{data,error}=await query;
                if(error)throw error;
                data.forEach(animal=>{
                    const option=document.createElement('option');
                    option.value=animal.id;
                    option.textContent=`${animal.tag_number} - ${translateSpecies(animal.species)} ${translateSex(animal.sex)}`;
                    select.appendChild(option);
                });
            }catch(error){
                console.error('Error:',error);
            }
        }
        
        async function loadInventory(){
            try{
                const{data,error}=await supabase.from('inventory').select('*').eq('user_id',currentUser.id).gt('quantity',0).order('item_name');
                if(error)throw error;
                inventoryItems=data||[];
            }catch(error){
                console.error('Error:',error);
                inventoryItems=[];
            }
        }
        
        function addFeedMaterial(){
            feedMaterialCounter++;
            const container=document.getElementById('feedMaterialsContainer');
            const materialDiv=document.createElement('div');
            materialDiv.className='material-item';
            materialDiv.id=`material-${feedMaterialCounter}`;
            materialDiv.innerHTML=`<div class="material-item-header"><strong>Ù…Ø§Ø¯Ø© #${feedMaterialCounter}</strong><button type="button" class="btn btn-danger btn-sm" onclick="removeFeedMaterial(${feedMaterialCounter})">Ø­Ø°Ù</button></div><div class="form-row"><div class="form-group"><label class="form-label">Ø§Ù„Ù…Ø§Ø¯Ø© *</label><select class="form-control feed-material-select" data-id="${feedMaterialCounter}" onchange="updateMaterialInfo(${feedMaterialCounter})" required><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>${inventoryItems.map(item=>`<option value="${item.id}" data-available="${item.quantity}" data-unit="${item.unit}" data-price="${item.unit_price||0}">${item.item_name} (Ù…ØªÙˆÙØ±: ${item.quantity} ${item.unit})</option>`).join('')}</select></div><div class="form-group"><label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ© *</label><input type="number" step="0.01" class="form-control feed-quantity" data-id="${feedMaterialCounter}" oninput="calculateFeedCost()" required><small class="form-text text-muted" id="unit-${feedMaterialCounter}"></small></div></div><div class="form-row"><div class="form-group"><label class="form-label">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</label><input type="number" step="0.01" class="form-control feed-unit-price" data-id="${feedMaterialCounter}" oninput="calculateFeedCost()" readonly></div><div class="form-group"><label class="form-label">Ø§Ù„ØªÙƒÙ„ÙØ©</label><input type="number" step="0.01" class="form-control feed-item-cost" data-id="${feedMaterialCounter}" readonly></div></div>`;
            container.appendChild(materialDiv);
        }
        
        function removeFeedMaterial(id){
            const element=document.getElementById(`material-${id}`);
            if(element){
                element.remove();
                calculateFeedCost();
            }
        }
        
        function updateMaterialInfo(id){
            const select=document.querySelector(`.feed-material-select[data-id="${id}"]`);
            if(!select)return;
            const selectedOption=select.options[select.selectedIndex];
            if(selectedOption.value){
                const unit=selectedOption.dataset.unit;
                const price=selectedOption.dataset.price;
                const unitDisplay=document.getElementById(`unit-${id}`);
                if(unitDisplay)unitDisplay.textContent=`Ø§Ù„ÙˆØ­Ø¯Ø©: ${unit}`;
                const priceInput=document.querySelector(`.feed-unit-price[data-id="${id}"]`);
                if(priceInput)priceInput.value=price;
            }else{
                const unitDisplay=document.getElementById(`unit-${id}`);
                if(unitDisplay)unitDisplay.textContent='';
                const priceInput=document.querySelector(`.feed-unit-price[data-id="${id}"]`);
                if(priceInput)priceInput.value='';
            }
            calculateFeedCost();
        }
        
        function calculateFeedCost(){
            let totalCost=0;
            document.querySelectorAll('.feed-material-select').forEach(select=>{
                if(select.value){
                    const id=select.dataset.id;
                    const quantityInput=document.querySelector(`.feed-quantity[data-id="${id}"]`);
                    const unitPriceInput=document.querySelector(`.feed-unit-price[data-id="${id}"]`);
                    const itemCostInput=document.querySelector(`.feed-item-cost[data-id="${id}"]`);
                    const quantity=parseFloat(quantityInput?.value||0);
                    const unitPrice=parseFloat(unitPriceInput?.value||0);
                    const itemCost=quantity*unitPrice;
                    if(itemCostInput)itemCostInput.value=itemCost.toFixed(2);
                    totalCost+=itemCost;
                }
            });
            const totalCostInput=document.getElementById('feedTotalCost');
            if(totalCostInput)totalCostInput.value=totalCost.toFixed(2);
        }
        
        function calculateSaleTotal(){
            const quantity=parseFloat(document.getElementById('saleQuantity').value)||0;
            const unitPrice=parseFloat(document.getElementById('saleUnitPrice').value)||0;
            if(quantity>0&&unitPrice>0){
                const total=quantity*unitPrice;
                document.getElementById('saleTotalAmount').value=total.toFixed(2);
            }
            calculateSaleRemaining();
        }
        
        function toggleSalePaymentFields(){
            const status=document.getElementById('salePaymentStatus').value;
            const detailsRow=document.getElementById('salePaymentDetailsRow');
            if(status==='partial'||status==='pending'){
                detailsRow.style.display='grid';
            }else{
                detailsRow.style.display='none';
            }
            calculateSaleRemaining();
        }
        
        function calculateSaleRemaining(){
            const total=parseFloat(document.getElementById('saleTotalAmount').value)||0;
            const paid=parseFloat(document.getElementById('saleAmountPaid').value)||0;
            const remaining=total-paid;
            document.getElementById('saleAmountRemaining').value=remaining.toFixed(2);
        }
        
        async function saveAnimal(){
            try{
                const animalData={
                    user_id:currentUser.id,
                    project_id:currentProjectId,
                    tag_number:document.getElementById('animalTag').value,
                    species:document.getElementById('animalSpecies').value,
                    sex:document.getElementById('animalSex').value,
                    birth_date:document.getElementById('animalBirthDate').value||null,
                    weight_kg:document.getElementById('animalWeight').value||null,
                    breed:document.getElementById('animalBreed').value||null,
                    color:document.getElementById('animalColor').value||null,
                    health_status:document.getElementById('animalHealthStatus').value,
                    special_marks:document.getElementById('animalMarks').value||null,
                    notes:document.getElementById('animalNotes').value||null,
                    last_weight_date:document.getElementById('animalWeight').value?new Date().toISOString().split('T')[0]:null
                };
                const animalId=document.getElementById('animalId').value;
                let error;
                if(animalId){
                    const result=await supabase.from('animals').update(animalData).eq('id',animalId);
                    error=result.error;
                }else{
                    animalData.status='alive';
                    const result=await supabase.from('animals').insert([animalData]);
                    error=result.error;
                }
                if(error)throw error;
                showSuccess('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­');
                closeModal('animalModal');
                loadAnimals();
                loadStats();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: '+error.message);
            }
        }
        
        async function deleteAnimal(id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŸ'))return;
            try{
                const{error}=await supabase.from('animals').delete().eq('id',id);
                if(error)throw error;
                showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø¨Ù†Ø¬Ø§Ø­');
                loadAnimals();
                loadStats();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
            }
        }
        
        async function saveHealthRecord(){
            try{
                const recordData={
                    user_id:currentUser.id,
                    animal_id:document.getElementById('healthAnimal').value,
                    record_type:document.getElementById('healthRecordType').value,
                    date:document.getElementById('healthDate').value,
                    vaccine_name:document.getElementById('healthName').value||null,
                    disease_name:document.getElementById('healthName').value||null,
                    treatment:document.getElementById('healthTreatment').value||null,
                    veterinarian_name:document.getElementById('healthVet').value||null,
                    veterinarian_phone:document.getElementById('healthVetPhone').value||null,
                    cost:document.getElementById('healthCost').value||null,
                    next_date:document.getElementById('healthNextDate').value||null,
                    notes:document.getElementById('healthNotes').value||null
                };
                const editId=document.getElementById('healthForm').getAttribute('data-edit-id');
                let error;
                if(editId){
                    const result=await supabase.from('health_records').update(recordData).eq('id',editId);
                    error=result.error;
                    document.getElementById('healthForm').removeAttribute('data-edit-id');
                }else{
                    const result=await supabase.from('health_records').insert([recordData]);
                    error=result.error;
                }
                if(error)throw error;
                showSuccess('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØµØ­ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
                closeModal('healthModal');
                loadHealthRecords();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: '+error.message);
            }
        }
        
        async function saveBirth(){
            try{
                const motherId=document.getElementById('birthMother').value;
                const fatherId=document.getElementById('birthFather').value||null;
                const birthDate=document.getElementById('birthActualDate').value;
                const aliveCount=parseInt(document.getElementById('birthAlive').value)||0;
                const avgWeight=document.getElementById('birthAvgWeight').value||null;
                
                const birthData={
                    user_id:currentUser.id,
                    project_id:currentProjectId,
                    mother_id:motherId,
                    father_id:fatherId,
                    mating_date:document.getElementById('birthMatingDate').value||null,
                    expected_birth_date:document.getElementById('birthExpectedDate').value||null,
                    actual_birth_date:birthDate,
                    total_born:parseInt(document.getElementById('birthTotal').value)||0,
                    alive_count:aliveCount,
                    dead_count:parseInt(document.getElementById('birthDead').value)||0,
                    average_birth_weight:avgWeight,
                    complications:document.getElementById('birthComplications').value||null,
                    notes:document.getElementById('birthNotes').value||null
                };
                
                const editId=document.getElementById('birthForm').getAttribute('data-edit-id');
                let error;
                
                if(editId){
                    const result=await supabase.from('births').update(birthData).eq('id',editId);
                    error=result.error;
                    document.getElementById('birthForm').removeAttribute('data-edit-id');
                    showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­');
                }else{
                    const result=await supabase.from('births').insert([birthData]);
                    error=result.error;
                    
                    if(!error){
                        const{data:mother}=await supabase.from('animals').select('species,tag_number').eq('id',motherId).single();
                        const lambsToInsert=[];
                        for(let i=1;i<=aliveCount;i++){
                            lambsToInsert.push({
                                user_id:currentUser.id,
                                project_id:currentProjectId,
                                tag_number:`${mother?.tag_number||'M'}-${birthDate}-${i}`,
                                species:mother?.species||'sheep',
                                sex:i%2===0?'female':'male',
                                birth_date:birthDate,
                                weight_kg:avgWeight,
                                mother_id:motherId,
                                father_id:fatherId,
                                status:'alive',
                                health_status:'healthy',
                                notes:`Ù…ÙˆÙ„ÙˆØ¯ Ù…Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© Ø¨ØªØ§Ø±ÙŠØ® ${birthDate}`
                            });
                        }
                        if(lambsToInsert.length>0){
                            const{error:lambsError}=await supabase.from('animals').insert(lambsToInsert);
                            if(lambsError)throw lambsError;
                        }
                    }
                    showSuccess(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø© ÙˆØ¥Ø¶Ø§ÙØ© ${aliveCount} Ø­Ù…Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­`);
                }
                
                if(error)throw error;
                closeModal('birthModal');
                await loadBirths();
                await loadAnimals();
                await loadStats();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: '+error.message);
            }
        }
        
        async function saveFeeding(){
            try{
                const feedItems=[];
                const materialSelects=document.querySelectorAll('.feed-material-select');
                
                for(const select of materialSelects){
                    if(select.value){
                        const id=select.dataset.id;
                        const quantityInput=document.querySelector(`.feed-quantity[data-id="${id}"]`);
                        const quantity=parseFloat(quantityInput.value);
                        
                        if(!quantity||quantity<=0){
                            showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯');
                            return;
                        }
                        
                        const selectedOption=select.options[select.selectedIndex];
                        const available=parseFloat(selectedOption.dataset.available);
                        
                        const editId=document.getElementById('feedingForm').getAttribute('data-edit-id');
                        if(!editId&&quantity>available){
                            showError(`Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù…Ù† ${selectedOption.text.split(' (')[0]} ØºÙŠØ± ÙƒØ§ÙÙŠØ©`);
                            return;
                        }
                        
                        feedItems.push({
                            inventory_id:select.value,
                            item_name:selectedOption.text.split(' (')[0],
                            quantity:quantity,
                            unit:selectedOption.dataset.unit,
                            unit_price:parseFloat(selectedOption.dataset.price)||0
                        });
                    }
                }
                
                if(feedItems.length===0){
                    showError('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                    return;
                }
                
                const feedData={
                    user_id:currentUser.id,
                    project_id:currentProjectId,
                    feed_date:document.getElementById('feedDate').value,
                    animals_count:document.getElementById('feedAnimalsCount').value||null,
                    feed_items:feedItems,
                    total_cost:parseFloat(document.getElementById('feedTotalCost').value)||0,
                    fed_by:document.getElementById('feedFedBy').value||null,
                    notes:document.getElementById('feedNotes').value||null
                };
                
                const editId=document.getElementById('feedingForm').getAttribute('data-edit-id');
                let error;
                
                if(editId){
                    const result=await supabase.from('feed_log').update(feedData).eq('id',editId);
                    error=result.error;
                    document.getElementById('feedingForm').removeAttribute('data-edit-id');
                    showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØªØºØ°ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                }else{
                    const result=await supabase.from('feed_log').insert([feedData]);
                    error=result.error;
                    
                    if(!error){
                        for(const item of feedItems){
                            await supabase.from('inventory_movements').insert([{
                                user_id:currentUser.id,
                                inventory_id:item.inventory_id,
                                movement_type:'project_usage',
                                quantity:item.quantity,
                                unit:item.unit,
                                project_id:currentProjectId,
                                reason:'ØªØºØ°ÙŠØ© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª',
                                unit_price:item.unit_price,
                                total_cost:item.quantity*item.unit_price,
                                performed_at:new Date().toISOString()
                            }]);
                        }
                    }
                    showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØºØ°ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                }
                
                if(error)throw error;
                closeModal('feedingModal');
                loadFeedings();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: '+error.message);
            }
        }
        
        async function saveSale(){
            try{
                const animalId=document.getElementById('saleAnimal').value||null;
                const quantity=parseFloat(document.getElementById('saleQuantity').value);
                const totalAmount=parseFloat(document.getElementById('saleTotalAmount').value);
                let unitPrice=parseFloat(document.getElementById('saleUnitPrice').value);
                
                if(!unitPrice||unitPrice<=0){
                    if(quantity>0&&totalAmount>0){
                        unitPrice=totalAmount/quantity;
                    }else{
                        showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ');
                        return;
                    }
                }
                
                const paymentStatus=document.getElementById('salePaymentStatus').value;
                const amountPaid=parseFloat(document.getElementById('saleAmountPaid').value)||0;
                const amountRemaining=parseFloat(document.getElementById('saleAmountRemaining').value)||0;
                
                const saleData={
                    user_id:currentUser.id,
                    project_id:currentProjectId,
                    sale_date:document.getElementById('saleDate').value,
                    item_type:document.getElementById('saleItemType').value,
                    item_description:document.getElementById('saleDescription').value||null,
                    animal_id:animalId,
                    quantity:quantity,
                    unit:document.getElementById('saleUnit').value,
                    unit_price:unitPrice,
                    total_amount:totalAmount,
                    buyer_name:document.getElementById('saleBuyerName').value||null,
                    buyer_phone:document.getElementById('saleBuyerPhone').value||null,
                    buyer_address:document.getElementById('saleBuyerAddress').value||null,
                    payment_method:document.getElementById('salePaymentMethod').value,
                    payment_status:paymentStatus,
                    amount_paid:amountPaid||null,
                    amount_remaining:amountRemaining||null,
                    notes:document.getElementById('saleNotes').value||null
                };
                
                const editId=document.getElementById('saleForm').getAttribute('data-edit-id');
                let error;
                
                if(editId){
                    const result=await supabase.from('sales').update(saleData).eq('id',editId);
                    error=result.error;
                    document.getElementById('saleForm').removeAttribute('data-edit-id');
                    showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨ÙŠØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
                }else{
                    const result=await supabase.from('sales').insert([saleData]);
                    error=result.error;
                    
                    if(!error){
                        if(animalId){
                            await supabase.from('animals').update({status:'sold'}).eq('id',animalId);
                        }
                        
                        if(amountRemaining>0&&(paymentStatus==='partial'||paymentStatus==='pending')){
                            const buyerName=document.getElementById('saleBuyerName').value;
                            const buyerPhone=document.getElementById('saleBuyerPhone').value;
                            const buyerAddress=document.getElementById('saleBuyerAddress').value;
                            
                            if(buyerName&&buyerPhone){
                                const loanData={
                                    user_id:currentUser.id,
                                    project_id:currentProjectId,
                                    loan_date:document.getElementById('saleDate').value,
                                    animal_id:animalId,
                                    borrower_name:buyerName,
                                    borrower_phone:buyerPhone,
                                    borrower_address:buyerAddress||null,
                                    loan_amount:amountRemaining,
                                    amount_paid:0,
                                    notes:`Ù‚Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø¨ÙŠØ¹ - ${saleData.item_description||translateItemType(saleData.item_type)}`
                                };
                                
                                await supabase.from('sheep_loans').insert([loanData]);
                                showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø±Ø¶ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­');
                            }else{
                                showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­ (Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‚Ø±Ø¶ Ù„Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙŠ ÙƒØ§Ù…Ù„Ø©)');
                            }
                        }else{
                            showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­');
                        }
                    }
                }
                
                if(error)throw error;
                closeModal('saleModal');
                loadSales();
                if(animalId){
                    loadAnimals();
                    loadStats();
                }
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: '+error.message);
            }
        }
        
        async function saveLoan(){
            try{
                const loanData={
                    user_id:currentUser.id,
                    project_id:currentProjectId,
                    loan_date:document.getElementById('loanDate').value,
                    animal_id:document.getElementById('loanAnimal').value||null,
                    borrower_name:document.getElementById('loanBorrowerName').value,
                    borrower_phone:document.getElementById('loanBorrowerPhone').value,
                    borrower_address:document.getElementById('loanBorrowerAddress').value||null,
                    loan_amount:parseFloat(document.getElementById('loanAmount').value),
                    amount_paid:parseFloat(document.getElementById('loanAmountPaid').value)||0,
                    notes:document.getElementById('loanNotes').value||null
                };
                const{error}=await supabase.from('sheep_loans').insert([loanData]);
                if(error)throw error;
                showSuccess('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø±Ø¶ Ø¨Ù†Ø¬Ø§Ø­');
                closeModal('loanModal');
                loadLoans();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: '+error.message);
            }
        }
        
        async function saveExpense(){
            try{
                const expenseDate=document.getElementById('expenseDate').value;
                const category=document.getElementById('expenseCategory').value;
                const description=document.getElementById('expenseDescription').value;
                const amount=parseFloat(document.getElementById('expenseAmount').value);
                
                if(!expenseDate||!category||!description||!amount||amount<=0){
                    showError('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                    return;
                }
                
                const expenseData={
                    user_id:currentUser.id,
                    project_id:currentProjectId,
                    expense_date:expenseDate,
                    category:category,
                    description:description,
                    amount:amount,
                    paid_to:document.getElementById('expensePaidTo').value||null,
                    payment_method:document.getElementById('expensePaymentMethod').value||'cash',
                    receipt_number:document.getElementById('expenseReceiptNumber').value||null,
                    notes:document.getElementById('expenseNotes').value||null
                };
                
                const editId=document.getElementById('expenseForm').getAttribute('data-edit-id');
                let error;
                
                if(editId){
                    const result=await supabase.from('expenses').update(expenseData).eq('id',editId);
                    error=result.error;
                    document.getElementById('expenseForm').removeAttribute('data-edit-id');
                    showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­');
                }else{
                    const result=await supabase.from('expenses').insert([expenseData]);
                    error=result.error;
                    showSuccess('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­');
                }
                
                if(error)throw error;
                closeModal('expenseModal');
                loadExpenses();
            }catch(error){
                console.error('Error saving expense:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: '+error.message);
            }
        }
        
        async function editProject(){
            const newName=prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:',currentProject.name);
            if(newName&&newName.trim()){
                try{
                    const{error}=await supabase.from('projects').update({name:newName.trim()}).eq('id',currentProjectId);
                    if(error)throw error;
                    showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­');
                    loadProject();
                }catch(error){
                    console.error('Error:',error);
                    showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
                }
            }
        }
        
        async function toggleProjectStatus(){
            try{
                const newStatus=currentProject.status==='active'?'inactive':'active';
                const{error}=await supabase.from('projects').update({status:newStatus}).eq('id',currentProjectId);
                if(error)throw error;
                showSuccess('ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­');
                loadProject();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©');
            }
        }
        
        async function deleteProject(){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡!'))return;
            try{
                const{error}=await supabase.from('projects').delete().eq('id',currentProjectId);
                if(error)throw error;
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­');
                window.location.href='../../index.html';
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
            }
        }
        
        async function recordLoanPayment(loanId,remaining){
            const amount=prompt(`Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø¯ÙØ¹Ø© (Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remaining.toFixed(2)} Ø¯Ø¬):`);
            if(!amount||isNaN(amount)||parseFloat(amount)<=0)return;
            try{
                const{data:loan,error:fetchError}=await supabase.from('sheep_loans').select('*').eq('id',loanId).single();
                if(fetchError)throw fetchError;
                const newAmountPaid=(loan.amount_paid||0)+parseFloat(amount);
                const{error}=await supabase.from('sheep_loans').update({amount_paid:newAmountPaid,updated_at:new Date().toISOString()}).eq('id',loanId);
                if(error)throw error;
                showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­');
                loadLoans();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©');
            }
        }
        
        async function deleteHealthRecord(id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØµØ­ÙŠØŸ'))return;
            try{
                const{error}=await supabase.from('health_records').delete().eq('id',id);
                if(error)throw error;
                showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                loadHealthRecords();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
            }
        }
        
        async function deleteBirth(id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©ØŸ (Ù„Ù† ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯)'))return;
            try{
                const{error}=await supabase.from('births').delete().eq('id',id);
                if(error)throw error;
                showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                loadBirths();
                loadStats();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
            }
        }
        
        async function deleteFeeding(id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„ØªØºØ°ÙŠØ©ØŸ'))return;
            try{
                const{error}=await supabase.from('feed_log').delete().eq('id',id);
                if(error)throw error;
                showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                loadFeedings();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
            }
        }
        
        async function deleteSale(id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ¹ØŸ'))return;
            try{
                const{error}=await supabase.from('sales').delete().eq('id',id);
                if(error)throw error;
                showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                loadSales();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
            }
        }
        
        async function deleteLoan(id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø±Ø¶ØŸ'))return;
            try{
                const{error}=await supabase.from('sheep_loans').delete().eq('id',id);
                if(error)throw error;
                showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
                loadLoans();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
            }
        }
        
        async function deleteExpense(id){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ'))return;
            try{
                const{error}=await supabase.from('expenses').delete().eq('id',id);
                if(error)throw error;
                showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­');
                loadExpenses();
            }catch(error){
                console.error('Error:',error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù');
            }
        }
        
        function setDefaultDate(){
            const today=new Date().toISOString().split('T')[0];
            setTimeout(()=>{
                const dateInputs=['feedDate','saleDate','loanDate','expenseDate','healthDate','birthActualDate'];
                dateInputs.forEach(id=>{
                    const input=document.getElementById(id);
                    if(input&&!input.value)input.value=today;
                });
            },100);
        }
        
        function formatDate(dateString){
            if(!dateString)return'-';
            const date=new Date(dateString);
            return date.toLocaleDateString('ar-DZ');
        }
        
        function calculateAge(birthDate){
            if(!birthDate)return'-';
            const birth=new Date(birthDate);
            const today=new Date();
            const diffTime=Math.abs(today-birth);
            const diffDays=Math.ceil(diffTime/(1000*60*60*24));
            if(diffDays<30)return diffDays+' ÙŠÙˆÙ…';
            else if(diffDays<365){
                const months=Math.floor(diffDays/30);
                return months+' Ø´Ù‡Ø±';
            }else{
                const years=Math.floor(diffDays/365);
                const remainingMonths=Math.floor((diffDays%365)/30);
                return years+' Ø³Ù†Ø©'+(remainingMonths>0?' Ùˆ '+remainingMonths+' Ø´Ù‡Ø±':'');
            }
        }
        
        function formatFeedItems(items){
            if(!items||items.length===0)return'-';
            try{
                const feedItems=typeof items==='string'?JSON.parse(items):items;
                return feedItems.map(item=>item.item_name).join(', ');
            }catch{
                return'-';
            }
        }
        
        function translateSpecies(species){const t={'sheep':'ØºÙ†Ù…','goat':'Ù…Ø§Ø¹Ø²'};return t[species]||species;}
        function translateSex(sex){const t={'male':'Ø°ÙƒØ±','female':'Ø£Ù†Ø«Ù‰'};return t[sex]||sex;}
        function translateStatus(status){const t={'alive':'Ø­ÙŠ','sold':'Ù…Ø¨Ø§Ø¹','died':'Ù†Ø§ÙÙ‚','slaughtered':'Ù…Ø°Ø¨ÙˆØ­'};return t[status]||status;}
        function translateHealthStatus(status){const t={'healthy':'Ø³Ù„ÙŠÙ…','sick':'Ù…Ø±ÙŠØ¶','quarantine':'Ø­Ø¬Ø± ØµØ­ÙŠ','treatment':'ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬'};return t[status]||status;}
        function translateRecordType(type){const t={'vaccination':'ØªØ·Ø¹ÙŠÙ…','treatment':'Ø¹Ù„Ø§Ø¬','checkup':'ÙØ­Øµ','disease':'Ù…Ø±Ø¶'};return t[type]||type;}
        function translateItemType(type){const t={'live_animal':'Ø­ÙŠÙˆØ§Ù† Ø­ÙŠ','meat':'Ù„Ø­ÙˆÙ…','wool':'ØµÙˆÙ','milk':'Ø­Ù„ÙŠØ¨','other':'Ø£Ø®Ø±Ù‰'};return t[type]||type;}
        function translateUnit(unit){const t={'head':'Ø±Ø£Ø³','kg':'ÙƒØ¬Ù…','liter':'Ù„ØªØ±','piece':'Ù‚Ø·Ø¹Ø©'};return t[unit]||unit;}
        function translatePaymentStatus(status){const t={'paid':'Ù…Ø¯ÙÙˆØ¹','partial':'Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ','pending':'Ù…Ø¹Ù„Ù‚'};return t[status]||status;}
        function translatePaymentMethod(method){const t={'cash':'Ù†Ù‚Ø¯ÙŠ','bank_transfer':'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ','check':'Ø´ÙŠÙƒ','installment':'ØªÙ‚Ø³ÙŠØ·'};return t[method]||method;}
        function translateExpenseCategory(category){const t={'feeding':'ØªØºØ°ÙŠØ©','health':'ØµØ­Ø©','labor':'Ø£Ø¬ÙˆØ± Ø¹Ù…Ø§Ù„','cleaning':'ØªÙ†Ø¸ÙŠÙ','sterilization':'ØªØ¹Ù‚ÙŠÙ…','maintenance':'ØµÙŠØ§Ù†Ø©','other':'Ø£Ø®Ø±Ù‰'};return t[category]||category;}
        function getStatusColor(status){const c={'alive':'success','sold':'info','died':'danger','slaughtered':'secondary'};return c[status]||'secondary';}
        function getHealthColor(status){const c={'healthy':'success','sick':'danger','quarantine':'warning','treatment':'info'};return c[status]||'secondary';}
        function getPaymentStatusColor(status){const c={'paid':'success','partial':'warning','pending':'danger'};return c[status]||'secondary';}
        
        function showSuccess(message){
            const alert=document.getElementById('successAlert');
            alert.textContent=message;
            alert.classList.add('show');
            setTimeout(()=>{alert.classList.remove('show');},5000);
        }
        
        function showError(message){
            const alert=document.getElementById('errorAlert');
            alert.textContent=message;
            alert.classList.add('show');
            setTimeout(()=>{alert.classList.remove('show');},5000);
        }
    </script>
</body>
</html>
