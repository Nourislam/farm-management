<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø§Ø± - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø²Ø±Ø¹Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh; direction: rtl; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 50px; height: 50px; border: 4px solid #e0e0e0; border-top-color: #2d5016; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .header { background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%); color: white; padding: 20px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(45, 80, 22, 0.3); }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 28px; font-weight: 700; }
        .header p { margin-top: 8px; opacity: 0.9; font-size: 14px; }
        .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: 600; font-size: 14px; transition: all 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #4a7c2a; color: white; }
        .btn-primary:hover { background: #2d5016; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(74, 124, 42, 0.4); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-info:hover { background: #138496; }
        .btn-sm { padding: 5px 12px; font-size: 12px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: transform 0.3s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
        .stat-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stat-card-icon { font-size: 32px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        .stat-card-title { font-size: 14px; color: #6c757d; font-weight: 600; }
        .stat-card-value { font-size: 32px; font-weight: 700; color: #2d5016; }
        .stat-card-subtitle { font-size: 12px; color: #6c757d; margin-top: 5px; }
        .equipment-info-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .equipment-info-card h2 { color: #2d5016; font-size: 20px; margin-bottom: 20px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .info-item { padding: 15px; background: #f8f9fa; border-radius: 8px; border-right: 4px solid #4a7c2a; }
        .info-label { color: #6c757d; font-size: 12px; margin-bottom: 5px; font-weight: 600; }
        .info-value { font-size: 18px; font-weight: 700; color: #2d5016; }
        .tabs-container { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden; }
        .tabs-header { display: flex; border-bottom: 2px solid #f0f0f0; overflow-x: auto; background: #f8f9fa; }
        .tab-btn { padding: 15px 25px; background: transparent; border: none; cursor: pointer; font-family: 'Cairo', sans-serif; font-size: 14px; color: #6c757d; transition: all 0.3s; white-space: nowrap; font-weight: 600; border-bottom: 3px solid transparent; }
        .tab-btn.active { color: #2d5016; background: white; border-bottom-color: #4a7c2a; }
        .tab-btn:hover { background: rgba(74, 124, 42, 0.05); }
        .tab-content { padding: 25px; display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .tab-content h3 { color: #2d5016; font-size: 18px; margin-bottom: 20px; }
        .table-container { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); overflow: hidden; margin-top: 20px; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: linear-gradient(135deg, #2d5016 0%, #4a7c2a 100%); color: white; }
        thead th { padding: 15px; text-align: right; font-weight: 600; font-size: 14px; white-space: nowrap; }
        tbody tr { border-bottom: 1px solid #f0f0f0; transition: background 0.3s; }
        tbody tr:hover { background: #f8f9fa; }
        tbody td { padding: 15px; font-size: 14px; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal.active { display: flex; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; animation: slideDown 0.3s; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .modal-header h3 { color: #2d5016; font-size: 20px; }
        .close { font-size: 28px; font-weight: 700; color: #999; cursor: pointer; border: none; background: none; line-height: 1; }
        .close:hover { color: #333; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-weight: 600; color: #2d5016; font-size: 14px; }
        .form-control { padding: 10px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: 'Cairo', sans-serif; font-size: 14px; transition: border-color 0.3s; }
        .form-control:focus { outline: none; border-color: #4a7c2a; }
        textarea.form-control { resize: vertical; min-height: 80px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid #f0f0f0; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6c757d; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; opacity: 0.3; }
        .empty-state h4 { margin-bottom: 10px; color: #495057; }
        .alert { padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: none; animation: slideDown 0.3s; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h1 { font-size: 20px; }
            .stats-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            table { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div id="authLoading" class="loading">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #2d5016; font-weight: 600;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>

    <div id="alertContainer" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10000; width: 90%; max-width: 500px;"></div>

    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1 id="projectName">ğŸšœ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø¬Ø±Ø§Ø±</h1>
                    <p>Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø¬Ø±Ø§Ø±Ø§Øª ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„ØªØ´ØºÙŠÙ„</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='index.html'">â†©ï¸ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <button class="btn btn-danger" onclick="deleteProject()">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
                </div>
            </div>
        </div>

        <div class="equipment-info-card">
            <h2>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¹Ø¯Ø©</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø©</div>
                    <div class="info-value" id="equipmentType">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</div>
                    <div class="info-value" id="model">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹</div>
                    <div class="info-value" id="manufactureYear">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ</div>
                    <div class="info-value" id="serialNumber">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø§Ù„Ø­Ø§Ù„Ø©</div>
                    <div class="info-value" id="condition">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div>
                    <div class="info-value" id="workingHours">0</div>
                </div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-title">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´ØºÙ„ÙŠÙ†</div>
                        <div class="stat-card-value" id="operatorsCount">0</div>
                        <div class="stat-card-subtitle">Ù…Ø´ØºÙ„ÙŠÙ† ÙˆØ³Ø§Ø¦Ù‚ÙŠÙ†</div>
                    </div>
                    <div class="stat-card-icon" style="background: #e3f2fd; color: #1976d2;">ğŸ‘¨â€ğŸ”§</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„</div>
                        <div class="stat-card-value" id="totalHours">0</div>
                        <div class="stat-card-subtitle">Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„</div>
                    </div>
                    <div class="stat-card-icon" style="background: #fff3e0; color: #f57c00;">â±ï¸</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                        <div class="stat-card-value" id="totalRevenue" style="color: #28a745;">0 Ø¯Ø¬</div>
                        <div class="stat-card-subtitle">Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª</div>
                    </div>
                    <div class="stat-card-icon" style="background: #e8f5e9; color: #4caf50;">ğŸ’°</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div>
                        <div class="stat-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
                        <div class="stat-card-value" id="totalExpenses" style="color: #dc3545;">0 Ø¯Ø¬</div>
                        <div class="stat-card-subtitle">ØµÙŠØ§Ù†Ø© ÙˆØªØ´ØºÙŠÙ„</div>
                    </div>
                    <div class="stat-card-icon" style="background: #ffebee; color: #e53935;">ğŸ’¸</div>
                </div>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('operators')">ğŸ‘¨â€ğŸ”§ Ø§Ù„Ù…Ø´ØºÙ„ÙŠÙ†</button>
                <button class="tab-btn" onclick="switchTab('maintenance')">ğŸ”§ Ø§Ù„ØµÙŠØ§Ù†Ø©</button>
                <button class="tab-btn" onclick="switchTab('operations')">âš™ï¸ Ø§Ù„ØªØ´ØºÙŠÙ„</button>
                <button class="tab-btn" onclick="switchTab('services')">ğŸ’¼ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</button>
                <button class="tab-btn" onclick="switchTab('finance')">ğŸ’° Ø§Ù„Ù…Ø§Ù„ÙŠØ©</button>
            </div>

            <div class="tab-content active" id="operators">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ğŸ‘¨â€ğŸ”§ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØºÙ„ÙŠÙ† ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</h3>
                    <button class="btn btn-success btn-sm" onclick="openAddOperatorModal()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØºÙ„</button>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                                    <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</th>
                                    <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¬ÙˆØ±</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="operatorsTableBody">
                                <tr><td colspan="6" class="empty-state"><div class="empty-state-icon">ğŸ‘¨â€ğŸ”§</div><h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØºÙ„ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</h4><p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØºÙ„ÙŠÙ† ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="maintenance">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ğŸ”§ Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©</h3>
                    <button class="btn btn-success btn-sm" onclick="openAddMaintenanceModal()">â• Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©</button>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>Ø§Ù„ÙˆØµÙ</th>
                                    <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                    <th>Ø§Ù„ÙÙ†ÙŠ</th>
                                    <th>Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody">
                                <tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ğŸ”§</div><h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØµÙŠØ§Ù†Ø©</h4><p>Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="operations">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>âš™ï¸ Ø³Ø¬Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
                    <button class="btn btn-success btn-sm" onclick="openAddOperationModal()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©</button>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</th>
                                    <th>Ø§Ù„Ù…Ø´ØºÙ„</th>
                                    <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                                    <th>Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Ù„ØªØ±)</th>
                                    <th>Ø§Ù„ØªÙƒÙ„ÙØ©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="operationsTableBody">
                                <tr><td colspan="7" class="empty-state"><div class="empty-state-icon">âš™ï¸</div><h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ´ØºÙŠÙ„</h4><p>Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="services">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ğŸ’¼ Ø³Ø¬Ù„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <button class="btn btn-success btn-sm" onclick="openAddServiceModal()">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©</button>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                                    <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                    <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody">
                                <tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ğŸ’¼</div><h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ù…Ø³Ø¬Ù„Ø©</h4><p>Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø®Ø¯Ù…Ø§ØªÙƒ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</p></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="finance">
                <h3>ğŸ’° Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                        <div class="stat-card-value" id="financeRevenue" style="color: #28a745;">0 Ø¯Ø¬</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
                        <div class="stat-card-value" id="financeExpenses" style="color: #dc3545;">0 Ø¯Ø¬</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-title">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</div>
                        <div class="stat-card-value" id="financeProfit">0 Ø¯Ø¬</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="operatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØºÙ„</h3>
                <button class="close" onclick="closeModal('operatorModal')">&times;</button>
            </div>
            <form id="operatorForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ø§Ø³Ù… *</label>
                        <input type="text" class="form-control" id="operatorName" required>
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
                        <input type="tel" class="form-control" id="operatorPhone" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù†ÙˆØ¹ *</label>
                        <select class="form-control" id="operatorType" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                            <option value="operator">Ù…Ø´ØºÙ„</option>
                            <option value="driver">Ø³Ø§Ø¦Ù‚</option>
                            <option value="both">Ù…Ø´ØºÙ„ ÙˆØ³Ø§Ø¦Ù‚</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea class="form-control" id="operatorNotes"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('operatorModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-success">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <div id="maintenanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• Ø¥Ø¶Ø§ÙØ© ØµÙŠØ§Ù†Ø©</h3>
                <button class="close" onclick="closeModal('maintenanceModal')">&times;</button>
            </div>
            <form id="maintenanceForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙŠØ§Ù†Ø© *</label>
                        <input type="date" class="form-control" id="maintenanceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„ØµÙŠØ§Ù†Ø© *</label>
                        <select class="form-control" id="maintenanceType" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                            <option value="preventive">ÙˆÙ‚Ø§Ø¦ÙŠØ©</option>
                            <option value="corrective">Ø¥ØµÙ„Ø§Ø­ÙŠØ©</option>
                            <option value="emergency">Ø·Ø§Ø±Ø¦Ø©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</label>
                        <input type="date" class="form-control" id="nextMaintenanceDate">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ÙˆØµÙ *</label>
                    <textarea class="form-control" id="maintenanceDescription" required></textarea>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ù…Ø³ØªØ¨Ø¯Ù„Ø©</label>
                    <textarea class="form-control" id="partsReplaced"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ØªÙƒÙ„ÙØ© Ø§Ù„Ø¹Ù…Ø§Ù„Ø© (Ø¯Ø¬)</label>
                        <input type="number" step="0.01" class="form-control" id="laborCost" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªÙƒÙ„ÙØ© Ø§Ù„Ù‚Ø·Ø¹ (Ø¯Ø¬)</label>
                        <input type="number" step="0.01" class="form-control" id="partsCost" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ</label>
                        <input type="text" class="form-control" id="technicianName">
                    </div>
                    <div class="form-group">
                        <label>Ù‡Ø§ØªÙ Ø§Ù„ÙÙ†ÙŠ</label>
                        <input type="tel" class="form-control" id="technicianPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea class="form-control" id="maintenanceNotes"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('maintenanceModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-success">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <div id="operationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© ØªØ´ØºÙŠÙ„</h3>
                <button class="close" onclick="closeModal('operationModal')">&times;</button>
            </div>
            <form id="operationForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                        <input type="date" class="form-control" id="operationDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø´ØºÙ„ *</label>
                        <select class="form-control" id="operatorSelect" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´ØºÙ„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ *</label>
                        <input type="text" class="form-control" id="operationType" placeholder="Ø­Ø±Ø«ØŒ Ø¨Ø°Ø±ØŒ Ø­ØµØ§Ø¯ØŒ Ù†Ù‚Ù„..." required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</label>
                        <input type="number" step="0.1" class="form-control" id="durationHours" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Ù„ØªØ±)</label>
                        <input type="number" step="0.1" class="form-control" id="fuelConsumption" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</label>
                        <input type="number" step="0.1" class="form-control" id="distanceKm" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØºØ·Ø§Ø© (Ù‡ÙƒØªØ§Ø±)</label>
                        <input type="number" step="0.1" class="form-control" id="areaCovered" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                    <input type="text" class="form-control" id="operationLocation">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Ø¯Ø¬)</label>
                        <input type="number" step="0.01" class="form-control" id="fuelCost" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø£Ø¬Ø± Ø§Ù„Ù…Ø´ØºÙ„ (Ø¯Ø¬)</label>
                        <input type="number" step="0.01" class="form-control" id="operatorPayment" value="0">
                    </div>
                    <div class="form-group">
                        <label>ØªÙƒØ§Ù„ÙŠÙ Ø£Ø®Ø±Ù‰ (Ø¯Ø¬)</label>
                        <input type="number" step="0.01" class="form-control" id="otherCosts" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea class="form-control" id="operationNotes"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('operationModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-success">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <div id="serviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â• Ø¥Ø¶Ø§ÙØ© Ø®Ø¯Ù…Ø©</h3>
                <button class="close" onclick="closeModal('serviceModal')">&times;</button>
            </div>
            <form id="serviceForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                        <input type="date" class="form-control" id="serviceDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label>Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                        <input type="tel" class="form-control" id="customerPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
                    <textarea class="form-control" id="customerAddress" rows="2"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© *</label>
                        <input type="text" class="form-control" id="serviceType" placeholder="Ø­Ø±Ø«ØŒ Ø­ØµØ§Ø¯ØŒ Ù†Ù‚Ù„..." required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø´ØºÙ„</label>
                        <select class="form-control" id="serviceOperatorSelect">
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´ØºÙ„</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¯Ø© (Ø³Ø§Ø¹Ø§Øª)</label>
                        <input type="number" step="0.1" class="form-control" id="serviceDuration" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù‡ÙƒØªØ§Ø±)</label>
                        <input type="number" step="0.1" class="form-control" id="serviceArea" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</label>
                        <input type="number" step="0.1" class="form-control" id="serviceDistance" value="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ *</label>
                        <input type="number" step="0.01" class="form-control" id="serviceAmount" required>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                        <input type="number" step="0.01" class="form-control" id="servicePaidAmount" value="0">
                    </div>
                    <div class="form-group">
                        <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
                        <select class="form-control" id="servicePaymentStatus">
                            <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
                            <option value="partial">Ø¯ÙØ¹ Ø¬Ø²Ø¦ÙŠ</option>
                            <option value="paid">Ù…Ø¯ÙÙˆØ¹</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea class="form-control" id="serviceNotes"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('serviceModal')">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn-success">Ø­ÙØ¸</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://sstvsknmmhbwubzajeix.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdHZza25tbWhid3ViemFqZWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDM0NjIsImV4cCI6MjA3NDkxOTQ2Mn0.EeVUU9DxRYUi38nUHgWEsnG8li7KZjqAGPNW9IDokhg';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let currentProjectId = null;
        let currentProject = null;
        let operators = [];

        async function initPage() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                if (error || !user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                currentProjectId = urlParams.get('id');
                
                if (!currentProjectId) {
                    showAlert('Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }
                
                await loadProject();
                await loadOperators();
                await loadAllData();
                document.getElementById('authLoading').style.display = 'none';
            } catch (error) {
                console.error('Error initializing:', error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„', 'error');
            }
        }

        async function loadProject() {
            try {
                const { data, error } = await supabase
                    .from('projects')
                    .select('*')
                    .eq('id', currentProjectId)
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error) throw error;
                
                currentProject = data;
                const projectData = data.project_data || {};
                
                document.getElementById('projectName').textContent = `ğŸšœ ${data.name}`;
                document.getElementById('equipmentType').textContent = projectData.equipment_type || '-';
                document.getElementById('model').textContent = projectData.model || '-';
                document.getElementById('manufactureYear').textContent = projectData.manufacture_year || '-';
                document.getElementById('serialNumber').textContent = projectData.serial_number || '-';
                document.getElementById('condition').textContent = translateCondition(projectData.condition) || '-';
                document.getElementById('workingHours').textContent = projectData.working_hours || 0;
            } catch (error) {
                console.error('Error loading project:', error);
                showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'error');
            }
        }

        async function loadAllData() {
            await Promise.all([
                loadStats(),
                loadMaintenanceRecords(),
                loadOperations(),
                loadServices(),
                loadFinanceSummary()
            ]);
        }

        async function loadStats() {
            try {
                const [operatorsResult, operationsResult, servicesResult, maintenanceResult] = await Promise.all([
                    supabase.from('project_employees').select('*').eq('project_id', currentProjectId),
                    supabase.from('equipment_operations').select('*').eq('project_id', currentProjectId),
                    supabase.from('equipment_services').select('*').eq('project_id', currentProjectId),
                    supabase.from('equipment_maintenance').select('*').eq('project_id', currentProjectId)
                ]);

                const totalHours = (operationsResult.data || []).reduce((sum, op) => sum + (parseFloat(op.working_hours) || 0), 0);
                const totalRevenue = (servicesResult.data || []).reduce((sum, s) => sum + (parseFloat(s.paid_amount) || 0), 0);
                
                let totalExpenses = 0;
                (operationsResult.data || []).forEach(op => {
                    totalExpenses += parseFloat(op.fuel_cost || 0);
                    totalExpenses += parseFloat(op.operator_payment || 0);
                    totalExpenses += parseFloat(op.other_costs || 0);
                });
                (maintenanceResult.data || []).forEach(m => {
                    totalExpenses += parseFloat(m.labor_cost || 0);
                    totalExpenses += parseFloat(m.parts_cost || 0);
                });

                document.getElementById('operatorsCount').textContent = (operatorsResult.data || []).length;
                document.getElementById('totalHours').textContent = totalHours.toFixed(1);
                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadOperators() {
            try {
                const { data, error } = await supabase
                    .from('project_employees')
                    .select('*')
                    .eq('project_id', currentProjectId)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                operators = data || [];
                const tbody = document.getElementById('operatorsTableBody');
                
                if (operators.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">ğŸ‘¨â€ğŸ”§</div><h4>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØºÙ„ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</h4><p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØºÙ„ÙŠÙ† ÙˆØ§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</p></td></tr>`;
                    updateOperatorSelects();
                    return;
                }
                
                const operationsData = await supabase
                    .from('equipment_operations')
                    .select('*')
                    .eq('project_id', currentProjectId);
                
                tbody.innerHTML = operators.map(op => {
                    const opHours = (operationsData.data || [])
                        .filter(o => o.operator_id === op.id)
                        .reduce((sum, o) => sum + (parseFloat(o.working_hours) || 0), 0);
                    
                    const opPayments = (operationsData.data || [])
                        .filter(o => o.operator_id === op.id)
                        .reduce((sum, o) => sum + (parseFloat(o.operator_payment) || 0), 0);
                    
                    return `
                        <tr>
                            <td><strong>${op.name}</strong></td>
                            <td>${op.phone || '-'}</td>
                            <td><span class="badge badge-info">${translateRole(op.role)}</span></td>
                            <td>${opHours.toFixed(1)} Ø³Ø§Ø¹Ø©</td>
                            <td><strong>${formatCurrency(opPayments)}</strong></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-danger btn-sm" onclick="deleteOperator('${op.id}')">ğŸ—‘ï¸</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                updateOperatorSelects();
            } catch (error) {
                console.error('Error loading operators:', error);
                showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´ØºÙ„ÙŠÙ†', 'error');
            }
        }

        function updateOperatorSelects() {
            const operatorSelect = document.getElementById('operatorSelect');
            const serviceOperatorSelect = document.getElementById('serviceOperatorSelect');
            const options = operators.map(op => `<option value="${op.id}">${op.name}</option>`).join('');
            operatorSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´ØºÙ„</option>' + options;
            serviceOperatorSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´ØºÙ„</option>' + options;
        }

        function openAddOperatorModal() {
            document.getElementById('operatorForm').reset();
            document.getElementById('operatorModal').classList.add('active');
        }

        document.getElementById('operatorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const { error } = await supabase
                    .from('project_employees')
                    .insert({
                        user_id: currentUser.id,
                        project_id: currentProjectId,
                        name: document.getElementById('operatorName').value,
                        phone: document.getElementById('operatorPhone').value,
                        role: document.getElementById('operatorType').value,
                        notes: document.getElementById('operatorNotes').value
                    });
                
                if (error) throw error;
                closeModal('operatorModal');
                await loadOperators();
                await loadStats();
                showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØºÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error adding operator:', error);
                showAlert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØºÙ„', 'error');
            }
        });

        async function deleteOperator(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´ØºÙ„ØŸ')) return;
            try {
                const { error } = await supabase.from('project_employees').delete().eq('id', id).eq('user_id', currentUser.id);
                if (error) throw error;
                await loadOperators();
                await loadStats();
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´ØºÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error deleting operator:', error);
                showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø´ØºÙ„', 'error');
            }
        }

        async function loadMaintenanceRecords() {
            try {
                const { data, error } = await supabase
                    .from('equipment_maintenance')
                    .select('*')
                    .eq('project_id', currentProjectId)
                    .order('maintenance_date', { ascending: false });
                
                if (error) throw error;
                const tbody = document.getElementById('maintenanceTableBody');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ğŸ”§</div><h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª ØµÙŠØ§Ù†Ø©</h4><p>Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©</p></td></tr>`;
                    return;
                }
                
                tbody.innerHTML = data.map(m => {
                    const totalCost = (parseFloat(m.labor_cost) || 0) + (parseFloat(m.parts_cost) || 0);
                    return `
                        <tr>
                            <td>${formatDate(m.maintenance_date)}</td>
                            <td><span class="badge ${getMaintenanceTypeBadge(m.maintenance_type)}">${translateMaintenanceType(m.maintenance_type)}</span></td>
                            <td>${m.description || '-'}</td>
                            <td><strong>${formatCurrency(totalCost)}</strong></td>
                            <td>${m.technician_name || '-'}</td>
                            <td>${m.next_maintenance_date ? formatDate(m.next_maintenance_date) : '-'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-danger btn-sm" onclick="deleteMaintenance('${m.id}')">ğŸ—‘ï¸</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading maintenance:', error);
            }
        }

        function openAddMaintenanceModal() {
            document.getElementById('maintenanceForm').reset();
            document.getElementById('maintenanceDate').valueAsDate = new Date();
            document.getElementById('maintenanceModal').classList.add('active');
        }

        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const { error } = await supabase
                    .from('equipment_maintenance')
                    .insert({
                        user_id: currentUser.id,
                        project_id: currentProjectId,
                        maintenance_date: document.getElementById('maintenanceDate').value,
                        maintenance_type: document.getElementById('maintenanceType').value,
                        next_maintenance_date: document.getElementById('nextMaintenanceDate').value || null,
                        description: document.getElementById('maintenanceDescription').value,
                        parts_replaced: document.getElementById('partsReplaced').value,
                        labor_cost: parseFloat(document.getElementById('laborCost').value) || 0,
                        parts_cost: parseFloat(document.getElementById('partsCost').value) || 0,
                        technician_name: document.getElementById('technicianName').value,
                        technician_phone: document.getElementById('technicianPhone').value,
                        notes: document.getElementById('maintenanceNotes').value
                    });
                
                if (error) throw error;
                closeModal('maintenanceModal');
                await loadMaintenanceRecords();
                await loadStats();
                await loadFinanceSummary();
                showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error adding maintenance:', error);
                showAlert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„ØµÙŠØ§Ù†Ø©', 'error');
            }
        });

        async function deleteMaintenance(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
            try {
                const { error } = await supabase.from('equipment_maintenance').delete().eq('id', id).eq('user_id', currentUser.id);
                if (error) throw error;
                await loadMaintenanceRecords();
                await loadStats();
                await loadFinanceSummary();
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error deleting maintenance:', error);
                showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„', 'error');
            }
        }

        async function loadOperations() {
            try {
                const { data, error } = await supabase
                    .from('equipment_operations')
                    .select(`*, operator:project_employees(name)`)
                    .eq('project_id', currentProjectId)
                    .order('operation_date', { ascending: false });
                
                if (error) throw error;
                const tbody = document.getElementById('operationsTableBody');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">âš™ï¸</div><h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ´ØºÙŠÙ„</h4><p>Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p></td></tr>`;
                    return;
                }
                
                tbody.innerHTML = data.map(op => {
                    const totalCost = (parseFloat(op.fuel_cost) || 0) + (parseFloat(op.operator_payment) || 0) + (parseFloat(op.other_costs) || 0);
                    return `
                        <tr>
                            <td>${formatDate(op.operation_date)}</td>
                            <td><span class="badge badge-info">${op.work_type}</span></td>
                            <td>${op.operator?.name || '-'}</td>
                            <td>${op.working_hours || 0} Ø³Ø§Ø¹Ø©</td>
                            <td>${op.fuel_consumption || 0} Ù„ØªØ±</td>
                            <td><strong>${formatCurrency(totalCost)}</strong></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-danger btn-sm" onclick="deleteOperation('${op.id}')">ğŸ—‘ï¸</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading operations:', error);
            }
        }

        function openAddOperationModal() {
            document.getElementById('operationForm').reset();
            document.getElementById('operationDate').valueAsDate = new Date();
            document.getElementById('operationModal').classList.add('active');
        }

        document.getElementById('operationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const operatorId = document.getElementById('operatorSelect').value || null;
                const workingHours = parseFloat(document.getElementById('durationHours').value) || 0;
                
                const { error } = await supabase
                    .from('equipment_operations')
                    .insert({
                        user_id: currentUser.id,
                        project_id: currentProjectId,
                        operation_date: document.getElementById('operationDate').value,
                        operator_id: operatorId,
                        work_type: document.getElementById('operationType').value,
                        working_hours: workingHours,
                        fuel_consumption: parseFloat(document.getElementById('fuelConsumption').value) || 0,
                        distance_km: parseFloat(document.getElementById('distanceKm').value) || 0,
                        area_hectares: parseFloat(document.getElementById('areaCovered').value) || 0,
                        location: document.getElementById('operationLocation').value,
                        fuel_cost: parseFloat(document.getElementById('fuelCost').value) || 0,
                        operator_payment: parseFloat(document.getElementById('operatorPayment').value) || 0,
                        other_costs: parseFloat(document.getElementById('otherCosts').value) || 0,
                        notes: document.getElementById('operationNotes').value
                    });
                
                if (error) {
                    console.error('Insert error:', error);
                    throw error;
                }
                
                const newWorkingHours = (parseFloat(currentProject.project_data?.working_hours) || 0) + workingHours;
                await supabase.from('projects').update({
                    project_data: { ...currentProject.project_data, working_hours: newWorkingHours }
                }).eq('id', currentProjectId);
                
                closeModal('operationModal');
                await loadProject();
                await loadOperations();
                await loadOperators();
                await loadStats();
                await loadFinanceSummary();
                showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error adding operation:', error);
                showAlert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ´ØºÙŠÙ„', 'error');
            }
        });

        async function deleteOperation(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')) return;
            try {
                const { error } = await supabase.from('equipment_operations').delete().eq('id', id).eq('user_id', currentUser.id);
                if (error) throw error;
                await loadOperations();
                await loadOperators();
                await loadStats();
                await loadFinanceSummary();
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error deleting operation:', error);
                showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
            }
        }

        async function loadServices() {
            try {
                const { data, error } = await supabase
                    .from('equipment_services')
                    .select('*')
                    .eq('project_id', currentProjectId)
                    .order('service_date', { ascending: false });
                
                if (error) throw error;
                const tbody = document.getElementById('servicesTableBody');
                
                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ğŸ’¼</div><h4>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ù…Ø³Ø¬Ù„Ø©</h4><p>Ø§Ø¨Ø¯Ø£ Ø¨ØªØ³Ø¬ÙŠÙ„ Ø®Ø¯Ù…Ø§ØªÙƒ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡</p></td></tr>`;
                    return;
                }
                
                tbody.innerHTML = data.map(s => {
                    return `
                        <tr>
                            <td>${formatDate(s.service_date)}</td>
                            <td>${s.customer_name}</td>
                            <td>${s.service_type}</td>
                            <td><strong>${formatCurrency(s.amount)}</strong></td>
                            <td>${formatCurrency(s.paid_amount)}</td>
                            <td><span class="badge ${getPaymentStatusBadge(s.payment_status)}">${translatePaymentStatus(s.payment_status)}</span></td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-danger btn-sm" onclick="deleteService('${s.id}')">ğŸ—‘ï¸</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        function openAddServiceModal() {
            document.getElementById('serviceForm').reset();
            document.getElementById('serviceDate').valueAsDate = new Date();
            document.getElementById('serviceModal').classList.add('active');
        }

        document.getElementById('serviceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const amount = parseFloat(document.getElementById('serviceAmount').value);
                const paidAmount = parseFloat(document.getElementById('servicePaidAmount').value) || 0;
                
                const { error } = await supabase
                    .from('equipment_services')
                    .insert({
                        user_id: currentUser.id,
                        project_id: currentProjectId,
                        service_date: document.getElementById('serviceDate').value,
                        customer_name: document.getElementById('customerName').value,
                        customer_phone: document.getElementById('customerPhone').value,
                        customer_address: document.getElementById('customerAddress').value,
                        service_type: document.getElementById('serviceType').value,
                        operator_id: document.getElementById('serviceOperatorSelect').value || null,
                        duration_hours: parseFloat(document.getElementById('serviceDuration').value) || 0,
                        area_hectares: parseFloat(document.getElementById('serviceArea').value) || 0,
                        distance_km: parseFloat(document.getElementById('serviceDistance').value) || 0,
                        amount: amount,
                        paid_amount: paidAmount,
                        remaining_amount: amount - paidAmount,
                        payment_status: document.getElementById('servicePaymentStatus').value,
                        notes: document.getElementById('serviceNotes').value
                    });
                
                if (error) throw error;
                closeModal('serviceModal');
                await loadServices();
                await loadStats();
                await loadFinanceSummary();
                showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error adding service:', error);
                showAlert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¯Ù…Ø©', 'error');
            }
        });

        async function deleteService(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ')) return;
            try {
                const { error } = await supabase.from('equipment_services').delete().eq('id', id).eq('user_id', currentUser.id);
                if (error) throw error;
                await loadServices();
                await loadStats();
                await loadFinanceSummary();
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } catch (error) {
                console.error('Error deleting service:', error);
                showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø®Ø¯Ù…Ø©', 'error');
            }
        }

        async function loadFinanceSummary() {
            try {
                const [servicesResult, operationsResult, maintenanceResult] = await Promise.all([
                    supabase.from('equipment_services').select('*').eq('project_id', currentProjectId),
                    supabase.from('equipment_operations').select('*').eq('project_id', currentProjectId),
                    supabase.from('equipment_maintenance').select('*').eq('project_id', currentProjectId)
                ]);

                const totalRevenue = (servicesResult.data || []).reduce((sum, s) => sum + (parseFloat(s.paid_amount) || 0), 0);
                
                let totalExpenses = 0;
                (operationsResult.data || []).forEach(op => {
                    totalExpenses += parseFloat(op.fuel_cost || 0);
                    totalExpenses += parseFloat(op.operator_payment || 0);
                    totalExpenses += parseFloat(op.other_costs || 0);
                });
                (maintenanceResult.data || []).forEach(m => {
                    totalExpenses += parseFloat(m.labor_cost || 0);
                    totalExpenses += parseFloat(m.parts_cost || 0);
                });

                const netProfit = totalRevenue - totalExpenses;

                document.getElementById('financeRevenue').textContent = formatCurrency(totalRevenue);
                document.getElementById('financeExpenses').textContent = formatCurrency(totalExpenses);
                document.getElementById('financeProfit').textContent = formatCurrency(netProfit);
                document.getElementById('financeProfit').style.color = netProfit >= 0 ? '#28a745' : '#dc3545';
            } catch (error) {
                console.error('Error loading finance summary:', error);
            }
        }

        async function deleteProject() {
            if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡!')) return;
            try {
                const { error } = await supabase.from('projects').delete().eq('id', currentProjectId).eq('user_id', currentUser.id);
                if (error) throw error;
                showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                setTimeout(() => window.location.href = 'index.html', 1500);
            } catch (error) {
                console.error('Error deleting project:', error);
                showAlert('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', 'error');
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-DZ', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount || 0) + ' Ø¯Ø¬';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('ar-DZ');
        }

        function translateCondition(condition) {
            const translations = { 'excellent': 'Ù…Ù…ØªØ§Ø²Ø©', 'good': 'Ø¬ÙŠØ¯Ø©', 'fair': 'Ù…ØªÙˆØ³Ø·Ø©', 'poor': 'Ø³ÙŠØ¦Ø©' };
            return translations[condition] || condition;
        }

        function translateRole(role) {
            const translations = { 'operator': 'Ù…Ø´ØºÙ„', 'driver': 'Ø³Ø§Ø¦Ù‚', 'both': 'Ù…Ø´ØºÙ„ ÙˆØ³Ø§Ø¦Ù‚' };
            return translations[role] || role || '-';
        }

        function translateMaintenanceType(type) {
            const translations = { 'preventive': 'ÙˆÙ‚Ø§Ø¦ÙŠØ©', 'corrective': 'Ø¥ØµÙ„Ø§Ø­ÙŠØ©', 'emergency': 'Ø·Ø§Ø±Ø¦Ø©' };
            return translations[type] || type;
        }

        function getMaintenanceTypeBadge(type) {
            const badges = { 'preventive': 'badge-info', 'corrective': 'badge-warning', 'emergency': 'badge-danger' };
            return badges[type] || 'badge-info';
        }

        function translatePaymentStatus(status) {
            const translations = { 'paid': 'Ù…Ø¯ÙÙˆØ¹', 'partial': 'Ø¬Ø²Ø¦ÙŠ', 'unpaid': 'ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹' };
            return translations[status] || status;
        }

        function getPaymentStatusBadge(status) {
            const badges = { 'paid': 'badge-success', 'partial': 'badge-warning', 'unpaid': 'badge-danger' };
            return badges[status] || 'badge-info';
        }

        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
            alertDiv.textContent = (type === 'success' ? 'âœ… ' : 'âŒ ') + message;
            alertDiv.style.display = 'block';
            
            container.innerHTML = '';
            container.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }

        window.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
