<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة مشروع القمح 🌾</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4a7c2a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header {
            background: linear-gradient(135deg, #4a7c2a 0%, #2d5016 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-top: 8px;
        }

        .status-badge.active { background: #27ae60; }
        .status-badge.paused { background: #f39c12; }
        .status-badge.completed { background: #3498db; }
        .status-badge.planning { background: #95a5a6; }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary { background: #4a7c2a; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-info { background: #3498db; color: white; }
        .btn-sm { padding: 5px 12px; font-size: 12px; }

        .project-info {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-right: 4px solid #4a7c2a;
        }

        .info-label {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #2d5016;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-card-icon {
            font-size: 28px;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .stat-card-title {
            font-size: 13px;
            color: #6c757d;
            font-weight: 600;
        }

        .stat-card-value {
            font-size: 26px;
            font-weight: 700;
            color: #2d5016;
        }

        .stat-card-subtitle {
            font-size: 11px;
            color: #6c757d;
            margin-top: 3px;
        }

        .tabs-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            border: none;
            background: none;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab:hover { background: #e9ecef; }

        .tab.active {
            color: #4a7c2a;
            border-bottom: 3px solid #4a7c2a;
            background: white;
        }

        .tab-content {
            padding: 25px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .tab-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #4a7c2a;
            color: white;
        }

        th {
            padding: 15px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }

        tr:hover { background: #f8f9fa; }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .table-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            background: #4a7c2a;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2d5016;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #4a7c2a;
        }

        select.form-control {
            cursor: pointer;
        }

        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .required {
            color: #e74c3c;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"],
        .checkbox-group input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .form-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-section h4 {
            color: #4a7c2a;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            min-width: 300px;
            text-align: center;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .header h1 { font-size: 20px; }
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            .header-actions {
                width: 100%;
                justify-content: stretch;
            }
            .header-actions .btn { flex: 1; }
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            .stats-grid,
            .info-grid {
                grid-template-columns: 1fr;
            }
            .modal-content { margin: 10px; }
            table { font-size: 12px; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <p style="margin-top: 20px; color: #2d5016; font-weight: 600;">جاري تحميل البيانات...</p>
    </div>

    <div id="alertSuccess" class="alert alert-success"></div>
    <div id="alertError" class="alert alert-error"></div>

    <div class="header">
        <div class="header-content">
            <div>
                <h1 id="projectName">🌾 مشروع القمح</h1>
                <span id="projectStatus" class="status-badge active">نشط</span>
            </div>
            <div class="header-actions">
                <button class="btn btn-warning" onclick="window.location.reload()">🔄 تحديث</button>
                <button class="btn btn-secondary" onclick="goBack()">↩️ رجوع</button>
            </div>
        </div>
    </div>

    <div class="project-info">
        <h3 style="margin-bottom: 20px; color: #2d5016;">📋 معلومات المشروع</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">المساحة</div>
                <div class="info-value" id="landArea">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">نوع البذور</div>
                <div class="info-value" id="seedType">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">تاريخ الزراعة</div>
                <div class="info-value" id="plantingDate">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">الحصاد المتوقع</div>
                <div class="info-value" id="expectedHarvest">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">الإنتاج المتوقع</div>
                <div class="info-value" id="expectedYield">-</div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-header">
                <div>
                    <div class="stat-card-title">إجمالي المصروفات</div>
                    <div class="stat-card-value" id="totalExpenses">0 د.ج</div>
                    <div class="stat-card-subtitle">جميع التكاليف</div>
                </div>
                <div class="stat-card-icon" style="background: #ffebee; color: #c62828;">💸</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div>
                    <div class="stat-card-title">إجمالي الإيرادات</div>
                    <div class="stat-card-value" id="totalRevenue">0 د.ج</div>
                    <div class="stat-card-subtitle">من المبيعات</div>
                </div>
                <div class="stat-card-icon" style="background: #e8f5e9; color: #2e7d32;">💰</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div>
                    <div class="stat-card-title">صافي الربح</div>
                    <div class="stat-card-value" id="netProfit">0 د.ج</div>
                    <div class="stat-card-subtitle">الإيرادات - المصروفات</div>
                </div>
                <div class="stat-card-icon" style="background: #e3f2fd; color: #1976d2;">📊</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-card-header">
                <div>
                    <div class="stat-card-title">المراحل المكتملة</div>
                    <div class="stat-card-value" id="completedStages">0/0</div>
                    <div class="stat-card-subtitle">نسبة الإنجاز</div>
                </div>
                <div class="stat-card-icon" style="background: #f3e5f5; color: #7b1fa2;">✅</div>
            </div>
        </div>
    </div>

    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" data-tab="stages">📋 المراحل</button>
            <button class="tab" data-tab="irrigation">💧 الري</button>
            <button class="tab" data-tab="fertilizers">🧪 الأسمدة والمبيدات</button>
            <button class="tab" data-tab="harvest">🌾 الحصاد والمبيعات</button>
            <button class="tab" data-tab="operations">🚜 عمليات الجرار</button>
            <button class="tab" data-tab="labor">👷 مصاريف العمال</button>
        </div>

        <div class="tab-content active" id="stages">
            <div class="tab-actions">
                <button class="btn btn-success" onclick="openAddStageModal()">+ إضافة مرحلة</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>المرحلة</th>
                            <th>التاريخ المخطط</th>
                            <th>التاريخ الفعلي</th>
                            <th>نسبة الإنجاز</th>
                            <th>الحالة</th>
                            <th>الملاحظات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="stagesTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">📋</div>
                                <p>لا توجد مراحل مسجلة</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="irrigation">
            <div class="tab-actions">
                <button class="btn btn-success" onclick="openAddIrrigationModal()">+ تسجيل ري</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الطريقة</th>
                            <th>المدة (ساعات)</th>
                            <th>الكمية (م³)</th>
                            <th>التكلفة</th>
                            <th>الملاحظات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="irrigationTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">💧</div>
                                <p>لا توجد سجلات ري</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="fertilizers">
            <div class="tab-actions">
                <button class="btn btn-success" onclick="openAddFertilizerModal()">+ تسجيل استخدام</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>النوع</th>
                            <th>المادة</th>
                            <th>الكمية</th>
                            <th>التكلفة</th>
                            <th>الهدف</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="fertilizersTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">🧪</div>
                                <p>لا توجد سجلات استخدام</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="harvest">
            <div class="tab-actions">
                <button class="btn btn-success" onclick="openAddHarvestModal()">+ تسجيل حصاد</button>
                <button class="btn btn-info" onclick="openHarvestExpensesModal()">💰 مصاريف الحصاد</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>الكمية (قنطار)</th>
                            <th>الجودة</th>
                            <th>الوجهة</th>
                            <th>السعر/قنطار</th>
                            <th>الإجمالي</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="harvestTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">🌾</div>
                                <p>لا توجد سجلات حصاد</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="operations">
            <div class="tab-actions">
                <button class="btn btn-success" onclick="openAddOperationModal()">+ تسجيل عملية</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>نوع العملية</th>
                            <th>المدة/الكمية</th>
                            <th>السعر</th>
                            <th>التكلفة الإجمالية</th>
                            <th>الملاحظات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="operationsTableBody">
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="empty-state-icon">🚜</div>
                                <p>لا توجد عمليات مسجلة</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-content" id="labor">
            <div class="tab-actions">
                <button class="btn btn-success" onclick="openAddLaborModal()">+ إضافة عامل/مصروف</button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>اسم العامل</th>
                            <th>نوع الأجر</th>
                            <th>المدة/الكمية</th>
                            <th>السعر</th>
                            <th>الإجمالي</th>
                            <th>الملاحظات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="laborTableBody">
                        <tr>
                            <td colspan="8" class="empty-state">
                                <div class="empty-state-icon">👷</div>
                                <p>لا توجد مصاريف عمال مسجلة</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals will be added via JavaScript to keep HTML clean -->

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://sstvsknmmhbwubzajeix.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzdHZza25tbWhid3ViemFqZWl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDM0NjIsImV4cCI6MjA3NDkxOTQ2Mn0.EeVUU9DxRYUi38nUHgWEsnG8li7KZjqAGPNW9IDokhg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let currentProject = null;
        let projectId = null;
        let inventory = [];
        let projectData = {};

        const stageNames = {
            'land_preparation': 'الحرث والتجهيز',
            'planting': 'البذر',
            'first_fertilization': 'التسميد الأول',
            'irrigation': 'الري',
            'second_fertilization': 'التسميد الثاني',
            'pest_control': 'المكافحة',
            'harvest': 'الحصاد',
            'other': 'أخرى'
        };

        // Initialize on load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Page loaded, initializing...');
            
            const urlParams = new URLSearchParams(window.location.search);
            projectId = urlParams.get('id');

            if (!projectId) {
                showError('لم يتم تحديد المشروع');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            createModals();
            setupTabs();
            
            await checkAuth();
            await loadProjectData();
            await loadInventory();
            await loadStages();
            await loadIrrigationRecords();
            await loadFertilizerApplications();
            await loadHarvestRecords();
            await loadOperations();
            await loadLabor();
            await loadFinancialData();
            
            hideLoading();
            console.log('Initialization complete');
        });

        // Setup tabs
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                });
            });
        }

        // Create all modals dynamically
        function createModals() {
            const modalsHTML = `
                <!-- Stage Modal -->
                <div class="modal" id="addStageModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 id="stageModalTitle">إضافة مرحلة جديدة</h3>
                            <button class="close-btn" onclick="closeModal('addStageModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="stageId">
                            <div class="form-group">
                                <label>اسم المرحلة <span class="required">*</span></label>
                                <select id="stageName" class="form-control" required>
                                    <option value="">اختر...</option>
                                    <option value="land_preparation">الحرث والتجهيز</option>
                                    <option value="planting">البذر</option>
                                    <option value="first_fertilization">التسميد الأول</option>
                                    <option value="irrigation">الري</option>
                                    <option value="second_fertilization">التسميد الثاني</option>
                                    <option value="pest_control">المكافحة</option>
                                    <option value="harvest">الحصاد</option>
                                    <option value="other">أخرى</option>
                                </select>
                            </div>
                            <div class="form-group" id="customStageGroup" style="display: none;">
                                <label>اسم المرحلة المخصص</label>
                                <input type="text" id="customStageName" class="form-control">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>التاريخ المخطط</label>
                                    <input type="date" id="plannedDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>التاريخ الفعلي</label>
                                    <input type="date" id="actualDate" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>نسبة الإنجاز (%)</label>
                                <input type="number" min="0" max="100" id="completionPercentage" class="form-control" value="0">
                            </div>
                            <div class="form-group checkbox-group">
                                <input type="checkbox" id="isCompleted">
                                <label>مكتملة؟</label>
                            </div>
                            <div class="form-group">
                                <label>الوصف</label>
                                <textarea id="stageDescription" class="form-control"></textarea>
                            </div>
                            <div class="form-group">
                                <label>ملاحظات</label>
                                <textarea id="stageNotes" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('addStageModal')">إلغاء</button>
                            <button class="btn btn-success" onclick="saveStage()">💾 حفظ</button>
                        </div>
                    </div>
                </div>

                <!-- Irrigation Modal -->
                <div class="modal" id="addIrrigationModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>تسجيل ري</h3>
                            <button class="close-btn" onclick="closeModal('addIrrigationModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>التاريخ <span class="required">*</span></label>
                                    <input type="date" id="irrigationDate" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>الطريقة <span class="required">*</span></label>
                                    <select id="irrigationMethod" class="form-control" required>
                                        <option value="">اختر...</option>
                                        <option value="sprinkler">رش</option>
                                        <option value="flood">غمر</option>
                                        <option value="drip">تنقيط</option>
                                        <option value="pivot">محوري</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>المدة (ساعات)</label>
                                    <input type="number" step="0.1" id="irrigationDuration" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>الكمية (م³)</label>
                                    <input type="number" step="0.1" id="waterQuantity" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>التكلفة (د.ج)</label>
                                <input type="number" step="0.01" id="irrigationCost" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>ملاحظات</label>
                                <textarea id="irrigationNotes" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('addIrrigationModal')">إلغاء</button>
                            <button class="btn btn-success" onclick="saveIrrigation()">💾 حفظ</button>
                        </div>
                    </div>
                </div>

                <!-- Fertilizer Modal -->
                <div class="modal" id="addFertilizerModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>تسجيل استخدام أسمدة/مبيدات</h3>
                            <button class="close-btn" onclick="closeModal('addFertilizerModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>النوع <span class="required">*</span></label>
                                    <select id="applicationType" class="form-control" required>
                                        <option value="">اختر...</option>
                                        <option value="fertilizer">سماد</option>
                                        <option value="pesticide">مبيد</option>
                                        <option value="herbicide">مبيد أعشاب</option>
                                        <option value="fungicide">مبيد فطري</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>التاريخ <span class="required">*</span></label>
                                    <input type="date" id="applicationDate" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>المادة <span class="required">*</span></label>
                                <select id="materialId" class="form-control" required>
                                    <option value="">اختر من المخزون...</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>الكمية <span class="required">*</span></label>
                                    <input type="number" step="0.1" id="applicationQuantity" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>الوحدة</label>
                                    <input type="text" id="applicationUnit" class="form-control" readonly>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>الهدف</label>
                                <input type="text" id="applicationPurpose" class="form-control" placeholder="مثال: تسريع النمو، مكافحة الآفات...">
                            </div>
                            <div class="form-group">
                                <label>ملاحظات</label>
                                <textarea id="applicationNotes" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('addFertilizerModal')">إلغاء</button>
                            <button class="btn btn-success" onclick="saveFertilizerApplication()">💾 حفظ</button>
                        </div>
                    </div>
                </div>

                <!-- Harvest Modal -->
                <div class="modal" id="addHarvestModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>تسجيل حصاد</h3>
                            <button class="close-btn" onclick="closeModal('addHarvestModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>التاريخ <span class="required">*</span></label>
                                    <input type="date" id="harvestDate" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>الكمية (قنطار) <span class="required">*</span></label>
                                    <input type="number" step="0.1" id="harvestQuantity" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>الجودة</label>
                                <select id="harvestQuality" class="form-control">
                                    <option value="excellent">ممتازة</option>
                                    <option value="good">جيدة</option>
                                    <option value="medium">متوسطة</option>
                                    <option value="poor">ضعيفة</option>
                                </select>
                            </div>
                            <div class="form-section">
                                <h4>الوجهة</h4>
                                <div class="radio-group">
                                    <div class="checkbox-group">
                                        <input type="radio" id="destGov" name="destination" value="government" checked>
                                        <label for="destGov">بيع للدولة</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="radio" id="destStorage" name="destination" value="storage">
                                        <label for="destStorage">تخزين</label>
                                    </div>
                                </div>
                            </div>
                            <div id="governmentSection">
                                <div class="form-group">
                                    <label>سعر الدولة/قنطار (د.ج) <span class="required">*</span></label>
                                    <input type="number" step="0.01" id="govPrice" class="form-control">
                                </div>
                            </div>
                            <div id="storageSection" style="display: none;">
                                <div class="form-group">
                                    <label>مكان التخزين</label>
                                    <input type="text" id="storageLocation" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>السعر المتوقع/قنطار (د.ج)</label>
                                    <input type="number" step="0.01" id="expectedPrice" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label><strong>الإجمالي (د.ج)</strong></label>
                                <input type="number" step="0.01" id="harvestTotal" class="form-control" readonly style="font-weight: bold;">
                            </div>
                            <div class="form-group">
                                <label>ملاحظات</label>
                                <textarea id="harvestNotes" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('addHarvestModal')">إلغاء</button>
                            <button class="btn btn-success" onclick="saveHarvest()">💾 حفظ</button>
                        </div>
                    </div>
                </div>

                <!-- Harvest Expenses Modal -->
                <div class="modal" id="harvestExpensesModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>مصاريف الحصاد</h3>
                            <button class="close-btn" onclick="closeModal('harvestExpensesModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>التاريخ <span class="required">*</span></label>
                                <input type="date" id="harvestExpDate" class="form-control" required>
                            </div>
                            <div class="form-section">
                                <h4>تكاليف الحصادة</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>عدد الساعات</label>
                                        <input type="number" step="0.1" id="harvesterHours" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>السعر/ساعة (د.ج)</label>
                                        <input type="number" step="0.01" id="harvesterRate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-section">
                                <h4>تكاليف البريس (الكبس)</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>عدد الساعات</label>
                                        <input type="number" step="0.1" id="balerHours" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>السعر/ساعة (د.ج)</label>
                                        <input type="number" step="0.01" id="balerRate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-section">
                                <h4>تكاليف النقل</h4>
                                <div class="form-group">
                                    <label>تكلفة النقل (د.ج)</label>
                                    <input type="number" step="0.01" id="transportCost" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label><strong>الإجمالي (د.ج)</strong></label>
                                <input type="number" step="0.01" id="harvestExpTotal" class="form-control" readonly style="font-weight: bold; font-size: 16px;">
                            </div>
                            <div class="form-group">
                                <label>ملاحظات</label>
                                <textarea id="harvestExpNotes" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('harvestExpensesModal')">إلغاء</button>
                            <button class="btn btn-success" onclick="saveHarvestExpenses()">💾 حفظ</button>
                        </div>
                    </div>
                </div>

                <!-- Operation Modal -->
                <div class="modal" id="addOperationModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>تسجيل عملية جرار</h3>
                            <button class="close-btn" onclick="closeModal('addOperationModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>التاريخ <span class="required">*</span></label>
                                    <input type="date" id="operationDate" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>نوع العملية <span class="required">*</span></label>
                                    <select id="operationType" class="form-control" required>
                                        <option value="">اختر...</option>
                                        <option value="plowing">حرث</option>
                                        <option value="tilling">تقليب</option>
                                        <option value="seeding">زراعة/بذر</option>
                                        <option value="spraying">رش</option>
                                        <option value="transport">نقل</option>
                                        <option value="other">أخرى</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-section">
                                <h4>طريقة الحساب</h4>
                                <div class="radio-group">
                                    <div class="checkbox-group">
                                        <input type="radio" id="byHour" name="calcMethod" value="hour" checked>
                                        <label for="byHour">بالساعة</label>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="radio" id="byQuintal" name="calcMethod" value="quintal">
                                        <label for="byQuintal">بالقنطار</label>
                                    </div>
                                </div>
                            </div>
                            <div id="hourSection">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>عدد الساعات <span class="required">*</span></label>
                                        <input type="number" step="0.1" id="operationHours" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>السعر/ساعة (د.ج) <span class="required">*</span></label>
                                        <input type="number" step="0.01" id="hourlyRate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div id="quintalSection" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>الكمية (قنطار) <span class="required">*</span></label>
                                        <input type="number" step="0.1" id="operationQuantity" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label>السعر/قنطار (د.ج) <span class="required">*</span></label>
                                        <input type="number" step="0.01" id="quintalRate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label><strong>التكلفة الإجمالية (د.ج)</strong></label>
                                <input type="number" step="0.01" id="operationTotal" class="form-control" readonly style="font-weight: bold; font-size: 16px;">
                            </div>
                            <div class="form-group">
                                <label>ملاحظات</label>
                                <textarea id="operationNotes" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('addOperationModal')">إلغاء</button>
                            <button class="btn btn-success" onclick="saveOperation()">💾 حفظ</button>
                        </div>
                    </div>
                </div>

                <!-- Labor Modal -->
                <div class="modal" id="addLaborModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>إضافة مصروف عمال</h3>
                            <button class="close-btn" onclick="closeModal('addLaborModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>التاريخ <span class="required">*</span></label>
                                    <input type="date" id="laborDate" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>اسم العامل</label>
                                    <input type="text" id="laborName" class="form-control" placeholder="اختياري">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>نوع الأجر <span class="required">*</span></label>
                                <select id="laborType" class="form-control" required>
                                    <option value="">اختر...</option>
                                    <option value="hourly">بالساعة</option>
                                    <option value="daily">باليوم</option>
                                    <option value="monthly">بالشهر</option>
                                </select>
                            </div>
                            <div id="laborDetailsSection" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label id="laborDurationLabel">المدة <span class="required">*</span></label>
                                        <input type="number" step="0.1" id="laborDuration" class="form-control">
                                    </div>
                                    <div class="form-group">
                                        <label id="laborRateLabel">السعر <span class="required">*</span></label>
                                        <input type="number" step="0.01" id="laborRate" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label><strong>الإجمالي (د.ج)</strong></label>
                                <input type="number" step="0.01" id="laborTotal" class="form-control" readonly style="font-weight: bold; font-size: 16px;">
                            </div>
                            <div class="form-group">
                                <label>ملاحظات</label>
                                <textarea id="laborNotes" class="form-control"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeModal('addLaborModal')">إلغاء</button>
                            <button class="btn btn-success" onclick="saveLabor()">💾 حفظ</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalsHTML);
            
            // Setup event listeners after modals are created
            setupModalListeners();
        }

        function setupModalListeners() {
            // Stage name change
            const stageName = document.getElementById('stageName');
            if (stageName) {
                stageName.addEventListener('change', function() {
                    const customGroup = document.getElementById('customStageGroup');
                    if (customGroup) {
                        customGroup.style.display = this.value === 'other' ? 'block' : 'none';
                    }
                });
            }

            // Material selection
            const materialId = document.getElementById('materialId');
            if (materialId) {
                materialId.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption && selectedOption.dataset) {
                        const unitEl = document.getElementById('applicationUnit');
                        if (unitEl) unitEl.value = selectedOption.dataset.unit || '';
                    }
                });
            }

            // Harvest destination
            const destRadios = document.querySelectorAll('input[name="destination"]');
            destRadios.forEach(radio => {
                radio.addEventListener('change', toggleDestination);
            });

            // Harvest quantity/price
            const harvestQuantity = document.getElementById('harvestQuantity');
            const govPrice = document.getElementById('govPrice');
            const expectedPrice = document.getElementById('expectedPrice');
            
            if (harvestQuantity) harvestQuantity.addEventListener('input', calculateHarvestTotal);
            if (govPrice) govPrice.addEventListener('input', calculateHarvestTotal);
            if (expectedPrice) expectedPrice.addEventListener('input', calculateHarvestTotal);

            // Harvest expenses
            ['harvesterHours', 'harvesterRate', 'balerHours', 'balerRate', 'transportCost'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', calculateHarvestExpenses);
            });

            // Operation calc method
            const calcMethodRadios = document.querySelectorAll('input[name="calcMethod"]');
            calcMethodRadios.forEach(radio => {
                radio.addEventListener('change', toggleCalcMethod);
            });

            // Operation inputs
            ['operationHours', 'hourlyRate', 'operationQuantity', 'quintalRate'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', calculateOperationCost);
            });

            // Labor type
            const laborType = document.getElementById('laborType');
            if (laborType) {
                laborType.addEventListener('change', toggleLaborType);
            }

            // Labor inputs
            const laborDuration = document.getElementById('laborDuration');
            const laborRate = document.getElementById('laborRate');
            if (laborDuration) laborDuration.addEventListener('input', calculateLaborCost);
            if (laborRate) laborRate.addEventListener('input', calculateLaborCost);

            // Close modals on outside click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
        }

        // Auth
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error || !user) {
                    window.location.href = 'login.html';
                    return false;
                }

                currentUser = user;
                console.log('User authenticated:', user.id);
                return true;
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Load Project Data
        async function loadProjectData() {
            try {
                const { data, error } = await supabase
                    .from('projects')
                    .select('*, lands(name, area_hectares)')
                    .eq('id', projectId)
                    .single();

                if (error) throw error;

                currentProject = data;
                projectData = data.project_data || {};
                
                document.getElementById('projectName').textContent = `🌾 ${data.name}`;
                
                const statusBadge = document.getElementById('projectStatus');
                const statusText = {
                    'active': 'نشط',
                    'paused': 'متوقف',
                    'completed': 'مكتمل',
                    'planning': 'قيد التخطيط'
                };
                statusBadge.textContent = statusText[data.status] || data.status;
                statusBadge.className = `status-badge ${data.status}`;

                document.getElementById('landArea').textContent = 
                    data.lands ? `${data.lands.area_hectares} هكتار` : '-';
                document.getElementById('seedType').textContent = projectData.seed_type || '-';
                document.getElementById('plantingDate').textContent = 
                    data.start_date ? formatDate(data.start_date) : '-';
                document.getElementById('expectedHarvest').textContent = 
                    projectData.expected_harvest_date ? formatDate(projectData.expected_harvest_date) : '-';
                document.getElementById('expectedYield').textContent = 
                    projectData.expected_yield ? `${projectData.expected_yield} قنطار/هكتار` : '-';

                console.log('Project loaded:', data.name);
            } catch (error) {
                console.error('Error loading project:', error);
                showError('خطأ في تحميل بيانات المشروع');
            }
        }

        // Load Inventory
        async function loadInventory() {
            try {
                const { data, error } = await supabase
                    .from('inventory')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (error) throw error;
                inventory = data || [];
                updateMaterialSelects();
                console.log('Inventory loaded:', inventory.length, 'items');

            } catch (error) {
                console.error('Error loading inventory:', error);
            }
        }

        function updateMaterialSelects() {
            const select = document.getElementById('materialId');
            if (!select) return;
            
            select.innerHTML = '<option value="">اختر من المخزون...</option>';
            
            inventory.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item.name} (متوفر: ${item.quantity} ${item.unit})`;
                option.dataset.unit = item.unit;
                option.dataset.price = item.unit_price || 0;
                select.appendChild(option);
            });
        }

        // Load stages, irrigation, fertilizers, harvest, operations, labor
        // [Continue with the remaining functions in next message due to length...]

        async function loadStages() {
            try {
                const { data, error } = await supabase
                    .from('project_stages')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('planned_date', { ascending: true });

                if (error) throw error;

                renderStagesTable(data || []);
                updateStagesStats(data || []);
                console.log('Stages loaded:', data?.length || 0);

            } catch (error) {
                console.error('Error loading stages:', error);
            }
        }

        function renderStagesTable(stages) {
            const tbody = document.getElementById('stagesTableBody');
            
            if (stages.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <p>لا توجد مراحل مسجلة</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = stages.map(stage => {
                const stageName = stageNames[stage.stage_name] || stage.stage_name;
                const statusClass = stage.is_completed ? 'success' : 'warning';
                const statusText = stage.is_completed ? 'مكتملة ✓' : 'قيد التنفيذ';
                
                return `
                    <tr>
                        <td><strong>${stageName}</strong></td>
                        <td>${stage.planned_date ? formatDate(stage.planned_date) : '-'}</td>
                        <td>${stage.actual_date ? formatDate(stage.actual_date) : '-'}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="flex: 1; background: #e0e0e0; height: 8px; border-radius: 4px;">
                                    <div style="width: ${stage.completion_percentage || 0}%; background: #4a7c2a; height: 100%; border-radius: 4px;"></div>
                                </div>
                                <span style="font-weight: 600;">${stage.completion_percentage || 0}%</span>
                            </div>
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${stage.notes || '-'}</td>
                        <td class="table-actions">
                            <button class="btn btn-info btn-sm" onclick="editStage('${stage.id}')">✏️</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord('project_stages', '${stage.id}', 'stage')">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStagesStats(stages) {
            const totalStages = stages.length;
            const completedStages = stages.filter(s => s.is_completed).length;
            document.getElementById('completedStages').textContent = `${completedStages}/${totalStages}`;
        }

        async function editStage(stageId) {
            try {
                const { data, error } = await supabase
                    .from('project_stages')
                    .select('*')
                    .eq('id', stageId)
                    .single();

                if (error) throw error;

                document.getElementById('stageId').value = data.id;
                document.getElementById('stageName').value = data.stage_name;
                document.getElementById('plannedDate').value = data.planned_date || '';
                document.getElementById('actualDate').value = data.actual_date || '';
                document.getElementById('completionPercentage').value = data.completion_percentage || 0;
                document.getElementById('isCompleted').checked = data.is_completed || false;
                document.getElementById('stageDescription').value = data.description || '';
                document.getElementById('stageNotes').value = data.notes || '';

                if (data.stage_name === 'other') {
                    document.getElementById('customStageGroup').style.display = 'block';
                }

                document.getElementById('stageModalTitle').textContent = 'تعديل المرحلة';
                openAddStageModal();

            } catch (error) {
                console.error('Error loading stage:', error);
                showError('خطأ في تحميل بيانات المرحلة');
            }
        }

        async function saveStage() {
            console.log('saveStage called');
            try {
                const stageName = document.getElementById('stageName').value;
                const finalStageName = stageName === 'other' ? 
                    document.getElementById('customStageName').value : stageName;

                if (!finalStageName) {
                    showError('يجب اختيار أو إدخال اسم المرحلة');
                    return;
                }

                const stageData = {
                    user_id: currentUser.id,
                    project_id: projectId,
                    stage_name: finalStageName,
                    planned_date: document.getElementById('plannedDate').value || null,
                    actual_date: document.getElementById('actualDate').value || null,
                    completion_percentage: parseInt(document.getElementById('completionPercentage').value) || 0,
                    is_completed: document.getElementById('isCompleted').checked,
                    description: document.getElementById('stageDescription').value || null,
                    notes: document.getElementById('stageNotes').value || null
                };

                const stageId = document.getElementById('stageId').value;

                let error;
                if (stageId) {
                    ({ error } = await supabase
                        .from('project_stages')
                        .update(stageData)
                        .eq('id', stageId));
                } else {
                    ({ error } = await supabase
                        .from('project_stages')
                        .insert([stageData]));
                }

                if (error) throw error;

                showSuccess(stageId ? 'تم تحديث المرحلة بنجاح' : 'تم إضافة المرحلة بنجاح');
                closeModal('addStageModal');
                resetForm('stageName', 'stageId', 'plannedDate', 'actualDate', 'completionPercentage', 'isCompleted', 'stageDescription', 'stageNotes');
                document.getElementById('stageModalTitle').textContent = 'إضافة مرحلة جديدة';
                await loadStages();

            } catch (error) {
                console.error('Error saving stage:', error);
                showError('خطأ في حفظ المرحلة: ' + error.message);
            }
        }

        async function loadIrrigationRecords() {
            try {
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('project_id', projectId)
                    .eq('category', 'irrigation')
                    .order('expense_date', { ascending: false });

                if (error) throw error;

                renderIrrigationTable(data || []);
                console.log('Irrigation records loaded:', data?.length || 0);

            } catch (error) {
                console.error('Error loading irrigation:', error);
            }
        }

        function renderIrrigationTable(records) {
            const tbody = document.getElementById('irrigationTableBody');
            
            if (records.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">💧</div>
                            <p>لا توجد سجلات ري</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = records.map(record => {
                // استخراج البيانات من notes
                const notes = record.notes || '';
                const methodMatch = notes.match(/الطريقة: (.*)/);
                const durationMatch = notes.match(/المدة: (.*) ساعة/);
                const quantityMatch = notes.match(/الكمية: (.*) م³/);
                
                const methodText = methodMatch ? methodMatch[1] : '-';
                const duration = durationMatch ? durationMatch[1] : '-';
                const quantity = quantityMatch ? quantityMatch[1] : '-';

                return `
                    <tr>
                        <td>${formatDate(record.expense_date)}</td>
                        <td>${methodText}</td>
                        <td>${duration}</td>
                        <td>${quantity}</td>
                        <td>${formatCurrency(record.amount)}</td>
                        <td>${notes.split('\n').slice(3).join(' ')}</td>
                        <td class="table-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord('expenses', '${record.id}', 'irrigation')">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function saveIrrigation() {
            console.log('saveIrrigation called');
            try {
                const irrigationDate = document.getElementById('irrigationDate').value;
                const irrigationMethod = document.getElementById('irrigationMethod').value;

                if (!irrigationDate || !irrigationMethod) {
                    showError('يجب ملء التاريخ والطريقة');
                    return;
                }

                const duration = parseFloat(document.getElementById('irrigationDuration').value) || null;
                const quantity = parseFloat(document.getElementById('waterQuantity').value) || null;
                const notes = document.getElementById('irrigationNotes').value || null;
                
                // تخزين التفاصيل في notes
                let fullNotes = `الطريقة: ${irrigationMethod}`;
                if (duration) fullNotes += `\nالمدة: ${duration} ساعة`;
                if (quantity) fullNotes += `\nالكمية: ${quantity} م³`;
                if (notes) fullNotes += `\n${notes}`;

                const expenseData = {
                    user_id: currentUser.id,
                    project_id: projectId,
                    category: 'irrigation',
                    description: `ري - ${irrigationMethod}`,
                    amount: parseFloat(document.getElementById('irrigationCost').value) || 0,
                    expense_date: irrigationDate,
                    notes: fullNotes
                };

                console.log('Inserting irrigation:', expenseData);

                const { data, error } = await supabase
                    .from('expenses')
                    .insert([expenseData])
                    .select();

                if (error) throw error;

                console.log('Irrigation saved:', data);
                showSuccess('تم تسجيل الري بنجاح');
                closeModal('addIrrigationModal');
                resetForm('irrigationDate', 'irrigationMethod', 'irrigationDuration', 'waterQuantity', 'irrigationCost', 'irrigationNotes');
                await loadIrrigationRecords();
                await loadFinancialData();

            } catch (error) {
                console.error('Error saving irrigation:', error);
                showError('خطأ في تسجيل الري: ' + error.message);
            }
        }

        async function loadFertilizerApplications() {
            try {
                const { data, error } = await supabase
                    .from('inventory_movements')
                    .select('*, inventory(name, unit)')
                    .eq('project_id', projectId)
                    .eq('movement_type', 'out')
                    .order('movement_date', { ascending: false });

                if (error) throw error;

                renderFertilizersTable(data || []);
                console.log('Fertilizer applications loaded:', data?.length || 0);

            } catch (error) {
                console.error('Error loading fertilizers:', error);
            }
        }

        function renderFertilizersTable(applications) {
            const tbody = document.getElementById('fertilizersTableBody');
            
            if (applications.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">🧪</div>
                            <p>لا توجد سجلات استخدام</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = applications.map(app => {
                // استخراج البيانات من notes
                const notes = app.notes || '';
                const typeMatch = notes.match(/النوع: (.*)/);
                const purposeMatch = notes.match(/الهدف: (.*)/);
                
                const typeText = typeMatch ? typeMatch[1] : '-';
                const purpose = purposeMatch ? purposeMatch[1] : '-';

                // حساب التكلفة من الكمية وسعر المادة
                const inventoryItem = inventory.find(item => item.id === app.inventory_id);
                const cost = inventoryItem && inventoryItem.unit_price ? 
                    app.quantity * inventoryItem.unit_price : 0;

                return `
                    <tr>
                        <td>${formatDate(app.movement_date)}</td>
                        <td>${typeText}</td>
                        <td>${app.inventory ? app.inventory.name : '-'}</td>
                        <td>${app.quantity} ${app.inventory ? app.inventory.unit : ''}</td>
                        <td>${formatCurrency(cost)}</td>
                        <td>${purpose}</td>
                        <td class="table-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord('inventory_movements', '${app.id}', 'fertilizer')">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function saveFertilizerApplication() {
            console.log('saveFertilizerApplication called');
            try {
                const materialId = document.getElementById('materialId').value;
                const quantity = parseFloat(document.getElementById('applicationQuantity').value);
                const applicationType = document.getElementById('applicationType').value;
                const applicationDate = document.getElementById('applicationDate').value;

                if (!materialId || !quantity || !applicationType || !applicationDate) {
                    showError('يجب ملء جميع الحقول المطلوبة');
                    return;
                }

                const inventoryItem = inventory.find(item => item.id === materialId);
                if (!inventoryItem) {
                    showError('المادة غير موجودة');
                    return;
                }

                if (inventoryItem.quantity < quantity) {
                    showError('الكمية المتوفرة غير كافية');
                    return;
                }

                const purpose = document.getElementById('applicationPurpose').value || null;
                const notes = document.getElementById('applicationNotes').value || null;
                
                // تخزين التفاصيل في notes
                let fullNotes = `النوع: ${applicationType}`;
                if (purpose) fullNotes += `\nالهدف: ${purpose}`;
                if (notes) fullNotes += `\n${notes}`;

                const cost = inventoryItem.unit_price ? quantity * inventoryItem.unit_price : 0;

                const movementData = {
                    user_id: currentUser.id,
                    inventory_id: materialId,
                    project_id: projectId,
                    movement_type: 'out',
                    quantity: quantity,
                    movement_date: applicationDate,
                    notes: fullNotes
                };

                console.log('Inserting movement:', movementData);

                const { data, error } = await supabase
                    .from('inventory_movements')
                    .insert([movementData])
                    .select();

                if (error) throw error;

                console.log('Movement saved:', data);

                if (cost > 0) {
                    await supabase.from('expenses').insert([{
                        user_id: currentUser.id,
                        project_id: projectId,
                        category: applicationType === 'fertilizer' ? 'fertilizers' : 'pesticides',
                        description: `${inventoryItem.name}`,
                        amount: cost,
                        expense_date: applicationDate
                    }]);
                }

                showSuccess('تم تسجيل الاستخدام بنجاح وخصم من المخزون');
                closeModal('addFertilizerModal');
                resetForm('materialId', 'applicationQuantity', 'applicationUnit', 'applicationType', 'applicationDate', 'applicationPurpose', 'applicationNotes');
                await loadFertilizerApplications();
                await loadFinancialData();
                await loadInventory();

            } catch (error) {
                console.error('Error saving fertilizer application:', error);
                showError('خطأ في تسجيل الاستخدام: ' + error.message);
            }
        }

        async function loadHarvestRecords() {
            try {
                const { data, error } = await supabase
                    .from('sales')
                    .select('*')
                    .eq('project_id', projectId)
                    .order('sale_date', { ascending: false });

                if (error) throw error;

                renderHarvestTable(data || []);
                console.log('Harvest records loaded:', data?.length || 0);

            } catch (error) {
                console.error('Error loading harvest:', error);
            }
        }

        function renderHarvestTable(harvests) {
            const tbody = document.getElementById('harvestTableBody');
            
            if (harvests.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">🌾</div>
                            <p>لا توجد سجلات حصاد</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = harvests.map(harvest => {
                // استخراج البيانات من notes
                const notes = harvest.notes || '';
                const quantityMatch = notes.match(/الكمية: (.*) قنطار/);
                const qualityMatch = notes.match(/الجودة: (.*)/);
                const destinationMatch = notes.match(/الوجهة: (.*)/);
                const storageMatch = notes.match(/مكان التخزين: (.*)/);
                
                const quantity = quantityMatch ? quantityMatch[1] : '-';
                const quality = qualityMatch ? qualityMatch[1] : '-';
                let destination = destinationMatch ? destinationMatch[1] : '-';
                
                if (storageMatch) {
                    destination = `تخزين - ${storageMatch[1]}`;
                }

                return `
                    <tr>
                        <td>${formatDate(harvest.sale_date)}</td>
                        <td>${quantity}</td>
                        <td>${quality}</td>
                        <td>${destination}</td>
                        <td>${harvest.price_per_kg ? formatCurrency(harvest.price_per_kg) : '-'}</td>
                        <td>${formatCurrency(harvest.total_amount)}</td>
                        <td class="table-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord('sales', '${harvest.id}', 'harvest')">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleDestination() {
            const destination = document.querySelector('input[name="destination"]:checked').value;
            const govSection = document.getElementById('governmentSection');
            const storageSection = document.getElementById('storageSection');
            
            if (destination === 'government') {
                govSection.style.display = 'block';
                storageSection.style.display = 'none';
            } else {
                govSection.style.display = 'none';
                storageSection.style.display = 'block';
            }
            calculateHarvestTotal();
        }

        function calculateHarvestTotal() {
            const quantity = parseFloat(document.getElementById('harvestQuantity').value) || 0;
            const destination = document.querySelector('input[name="destination"]:checked').value;
            
            let price = 0;
            if (destination === 'government') {
                price = parseFloat(document.getElementById('govPrice').value) || 0;
            } else {
                price = parseFloat(document.getElementById('expectedPrice').value) || 0;
            }
            
            document.getElementById('harvestTotal').value = (quantity * price).toFixed(2);
        }

        async function saveHarvest() {
            console.log('saveHarvest called');
            try {
                const quantity = parseFloat(document.getElementById('harvestQuantity').value);
                const harvestDate = document.getElementById('harvestDate').value;
                const destination = document.querySelector('input[name="destination"]:checked').value;

                if (!quantity || !harvestDate) {
                    showError('يجب إدخال الكمية والتاريخ');
                    return;
                }

                let price = 0;
                const quality = document.getElementById('harvestQuality').value;
                
                // تخزين التفاصيل في notes
                let fullNotes = `الكمية: ${quantity} قنطار\nالجودة: ${quality}`;
                
                if (destination === 'government') {
                    price = parseFloat(document.getElementById('govPrice').value) || 0;
                    if (!price) {
                        showError('يجب إدخال سعر الدولة');
                        return;
                    }
                    fullNotes += `\nالوجهة: بيع للدولة`;
                } else {
                    const storageLocation = document.getElementById('storageLocation').value || null;
                    price = parseFloat(document.getElementById('expectedPrice').value) || 0;
                    fullNotes += `\nالوجهة: تخزين`;
                    if (storageLocation) fullNotes += `\nمكان التخزين: ${storageLocation}`;
                }

                const customNotes = document.getElementById('harvestNotes').value;
                if (customNotes) fullNotes += `\n${customNotes}`;

                const saleData = {
                    user_id: currentUser.id,
                    project_id: projectId,
                    sale_date: harvestDate,
                    price_per_kg: price,
                    total_amount: quantity * price,
                    notes: fullNotes
                };

                console.log('Inserting harvest:', saleData);

                const { data, error } = await supabase
                    .from('sales')
                    .insert([saleData])
                    .select();

                if (error) throw error;

                console.log('Harvest saved:', data);

                if (destination === 'storage') {
                    const inventoryData = {
                        user_id: currentUser.id,
                        name: `قمح - ${formatDate(harvestDate)}`,
                        category: 'محاصيل',
                        quantity: quantity,
                        unit: 'قنطار',
                        notes: `حصاد ${currentProject.name}`
                    };

                    await supabase.from('inventory').insert([inventoryData]);
                    console.log('Added to inventory');
                }

                showSuccess('تم تسجيل الحصاد بنجاح');
                closeModal('addHarvestModal');
                resetForm('harvestDate', 'harvestQuantity', 'harvestQuality', 'govPrice', 'storageLocation', 'expectedPrice', 'harvestTotal', 'harvestNotes');
                await loadHarvestRecords();
                await loadFinancialData();
                if (destination === 'storage') {
                    await loadInventory();
                }

            } catch (error) {
                console.error('Error saving harvest:', error);
                showError('خطأ في تسجيل الحصاد: ' + error.message);
            }
        }

        function calculateHarvestExpenses() {
            const harvesterHours = parseFloat(document.getElementById('harvesterHours').value) || 0;
            const harvesterRate = parseFloat(document.getElementById('harvesterRate').value) || 0;
            const balerHours = parseFloat(document.getElementById('balerHours').value) || 0;
            const balerRate = parseFloat(document.getElementById('balerRate').value) || 0;
            const transportCost = parseFloat(document.getElementById('transportCost').value) || 0;

            const total = (harvesterHours * harvesterRate) + (balerHours * balerRate) + transportCost;
            document.getElementById('harvestExpTotal').value = total.toFixed(2);
        }

        async function saveHarvestExpenses() {
            console.log('saveHarvestExpenses called');
            try {
                const expDate = document.getElementById('harvestExpDate').value;
                const harvesterHours = parseFloat(document.getElementById('harvesterHours').value) || 0;
                const harvesterRate = parseFloat(document.getElementById('harvesterRate').value) || 0;
                const balerHours = parseFloat(document.getElementById('balerHours').value) || 0;
                const balerRate = parseFloat(document.getElementById('balerRate').value) || 0;
                const transportCost = parseFloat(document.getElementById('transportCost').value) || 0;
                const total = (harvesterHours * harvesterRate) + (balerHours * balerRate) + transportCost;

                if (!expDate || total === 0) {
                    showError('يجب إدخال التاريخ وتفاصيل التكاليف');
                    return;
                }

                // تخزين التفاصيل في notes
                let fullNotes = 'مصاريف الحصاد:';
                if (harvesterHours > 0) fullNotes += `\nالحصادة: ${harvesterHours} ساعة × ${harvesterRate} د.ج = ${(harvesterHours * harvesterRate).toFixed(2)} د.ج`;
                if (balerHours > 0) fullNotes += `\nالبريس: ${balerHours} ساعة × ${balerRate} د.ج = ${(balerHours * balerRate).toFixed(2)} د.ج`;
                if (transportCost > 0) fullNotes += `\nالنقل: ${transportCost} د.ج`;
                
                const customNotes = document.getElementById('harvestExpNotes').value;
                if (customNotes) fullNotes += `\n${customNotes}`;

                const expenseData = {
                    user_id: currentUser.id,
                    project_id: projectId,
                    category: 'harvest',
                    description: 'مصاريف الحصاد',
                    amount: total,
                    expense_date: expDate,
                    notes: fullNotes
                };

                console.log('Inserting harvest expenses:', expenseData);

                const { data, error } = await supabase
                    .from('expenses')
                    .insert([expenseData])
                    .select();

                if (error) throw error;

                console.log('Harvest expenses saved:', data);
                showSuccess('تم تسجيل مصاريف الحصاد بنجاح');
                closeModal('harvestExpensesModal');
                resetForm('harvestExpDate', 'harvesterHours', 'harvesterRate', 'balerHours', 'balerRate', 'transportCost', 'harvestExpTotal', 'harvestExpNotes');
                await loadFinancialData();

            } catch (error) {
                console.error('Error saving harvest expenses:', error);
                showError('خطأ في تسجيل المصاريف: ' + error.message);
            }
        }

        async function loadOperations() {
            try {
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('project_id', projectId)
                    .eq('category', 'operations')
                    .order('expense_date', { ascending: false });

                if (error) throw error;

                renderOperationsTable(data || []);
                console.log('Operations loaded:', data?.length || 0);

            } catch (error) {
                console.error('Error loading operations:', error);
            }
        }

        function renderOperationsTable(operations) {
            const tbody = document.getElementById('operationsTableBody');
            
            if (operations.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <div class="empty-state-icon">🚜</div>
                            <p>لا توجد عمليات مسجلة</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = operations.map(op => {
                // استخراج البيانات من notes
                const notes = op.notes || '';
                const typeMatch = notes.match(/نوع العملية: (.*)/);
                const methodMatch = notes.match(/طريقة الحساب: (.*)/);
                const hoursMatch = notes.match(/عدد الساعات: (.*)/);
                const hourRateMatch = notes.match(/السعر\/ساعة: (.*) د.ج/);
                const quantityMatch = notes.match(/الكمية: (.*) قنطار/);
                const quintalRateMatch = notes.match(/السعر\/قنطار: (.*) د.ج/);
                
                const typeText = typeMatch ? typeMatch[1] : '-';
                let duration = '-';
                let rate = '-';
                
                if (hoursMatch && hourRateMatch) {
                    duration = `${hoursMatch[1]} ساعة`;
                    rate = formatCurrency(parseFloat(hourRateMatch[1]));
                } else if (quantityMatch && quintalRateMatch) {
                    duration = `${quantityMatch[1]} قنطار`;
                    rate = formatCurrency(parseFloat(quintalRateMatch[1]));
                }

                return `
                    <tr>
                        <td>${formatDate(op.expense_date)}</td>
                        <td>${typeText}</td>
                        <td>${duration}</td>
                        <td>${rate}</td>
                        <td>${formatCurrency(op.amount)}</td>
                        <td>${notes.split('\n').slice(3).join(' ')}</td>
                        <td class="table-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord('expenses', '${op.id}', 'operation')">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleCalcMethod() {
            const calcMethod = document.querySelector('input[name="calcMethod"]:checked').value;
            const hourSection = document.getElementById('hourSection');
            const quintalSection = document.getElementById('quintalSection');
            
            if (calcMethod === 'hour') {
                hourSection.style.display = 'block';
                quintalSection.style.display = 'none';
            } else {
                hourSection.style.display = 'none';
                quintalSection.style.display = 'block';
            }
            calculateOperationCost();
        }

        function calculateOperationCost() {
            const calcMethod = document.querySelector('input[name="calcMethod"]:checked').value;
            let total = 0;
            
            if (calcMethod === 'hour') {
                const hours = parseFloat(document.getElementById('operationHours').value) || 0;
                const rate = parseFloat(document.getElementById('hourlyRate').value) || 0;
                total = hours * rate;
            } else {
                const quantity = parseFloat(document.getElementById('operationQuantity').value) || 0;
                const rate = parseFloat(document.getElementById('quintalRate').value) || 0;
                total = quantity * rate;
            }
            
            document.getElementById('operationTotal').value = total.toFixed(2);
        }

        async function saveOperation() {
            console.log('saveOperation called');
            try {
                const opDate = document.getElementById('operationDate').value;
                const opType = document.getElementById('operationType').value;
                const calcMethod = document.querySelector('input[name="calcMethod"]:checked').value;

                if (!opDate || !opType) {
                    showError('يجب ملء التاريخ ونوع العملية');
                    return;
                }

                // تخزين التفاصيل في notes
                let fullNotes = `نوع العملية: ${opType}\nطريقة الحساب: ${calcMethod === 'hour' ? 'بالساعة' : 'بالقنطار'}`;
                
                let total = 0;
                if (calcMethod === 'hour') {
                    const hours = parseFloat(document.getElementById('operationHours').value);
                    const rate = parseFloat(document.getElementById('hourlyRate').value);
                    if (!hours || !rate) {
                        showError('يجب إدخال عدد الساعات والسعر');
                        return;
                    }
                    fullNotes += `\nعدد الساعات: ${hours}\nالسعر/ساعة: ${rate} د.ج`;
                    total = hours * rate;
                } else {
                    const quantity = parseFloat(document.getElementById('operationQuantity').value);
                    const rate = parseFloat(document.getElementById('quintalRate').value);
                    if (!quantity || !rate) {
                        showError('يجب إدخال الكمية والسعر');
                        return;
                    }
                    fullNotes += `\nالكمية: ${quantity} قنطار\nالسعر/قنطار: ${rate} د.ج`;
                    total = quantity * rate;
                }

                const customNotes = document.getElementById('operationNotes').value;
                if (customNotes) fullNotes += `\n${customNotes}`;

                const expenseData = {
                    user_id: currentUser.id,
                    project_id: projectId,
                    category: 'operations',
                    description: `عملية جرار - ${opType}`,
                    amount: total,
                    expense_date: opDate,
                    notes: fullNotes
                };

                console.log('Inserting operation:', expenseData);

                const { data, error } = await supabase
                    .from('expenses')
                    .insert([expenseData])
                    .select();

                if (error) throw error;

                console.log('Operation saved:', data);
                showSuccess('تم تسجيل العملية بنجاح');
                closeModal('addOperationModal');
                resetForm('operationDate', 'operationType', 'operationHours', 'hourlyRate', 'operationQuantity', 'quintalRate', 'operationTotal', 'operationNotes');
                await loadOperations();
                await loadFinancialData();

            } catch (error) {
                console.error('Error saving operation:', error);
                showError('خطأ في تسجيل العملية: ' + error.message);
            }
        }

        async function loadLabor() {
            try {
                const { data, error } = await supabase
                    .from('expenses')
                    .select('*')
                    .eq('project_id', projectId)
                    .eq('category', 'labor')
                    .order('expense_date', { ascending: false });

                if (error) throw error;

                renderLaborTable(data || []);
                console.log('Labor records loaded:', data?.length || 0);

            } catch (error) {
                console.error('Error loading labor:', error);
            }
        }

        function renderLaborTable(labor) {
            const tbody = document.getElementById('laborTableBody');
            
            if (labor.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-state-icon">👷</div>
                            <p>لا توجد مصاريف عمال مسجلة</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = labor.map(lab => {
                // استخراج البيانات من notes
                const notes = lab.notes || '';
                const nameMatch = notes.match(/اسم العامل: (.*)/);
                const typeMatch = notes.match(/نوع الأجر: (.*)/);
                const durationMatch = notes.match(/المدة: (.*)/);
                const rateMatch = notes.match(/السعر: (.*) د.ج/);
                
                const workerName = nameMatch ? nameMatch[1] : 'غير محدد';
                const typeText = typeMatch ? typeMatch[1] : '-';
                const duration = durationMatch ? durationMatch[1] : '-';
                const rate = rateMatch ? parseFloat(rateMatch[1]) : 0;

                return `
                    <tr>
                        <td>${formatDate(lab.expense_date)}</td>
                        <td>${workerName}</td>
                        <td>${typeText}</td>
                        <td>${duration}</td>
                        <td>${formatCurrency(rate)}</td>
                        <td>${formatCurrency(lab.amount)}</td>
                        <td>${notes.split('\n').slice(4).join(' ')}</td>
                        <td class="table-actions">
                            <button class="btn btn-danger btn-sm" onclick="deleteRecord('expenses', '${lab.id}', 'labor')">🗑️</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleLaborType() {
            const laborType = document.getElementById('laborType').value;
            const detailsSection = document.getElementById('laborDetailsSection');
            const durationLabel = document.getElementById('laborDurationLabel');
            const rateLabel = document.getElementById('laborRateLabel');
            
            if (laborType) {
                detailsSection.style.display = 'block';
                
                if (laborType === 'hourly') {
                    durationLabel.innerHTML = 'عدد الساعات <span class="required">*</span>';
                    rateLabel.innerHTML = 'السعر/ساعة (د.ج) <span class="required">*</span>';
                } else if (laborType === 'daily') {
                    durationLabel.innerHTML = 'عدد الأيام <span class="required">*</span>';
                    rateLabel.innerHTML = 'السعر/يوم (د.ج) <span class="required">*</span>';
                } else if (laborType === 'monthly') {
                    durationLabel.innerHTML = 'عدد الأشهر <span class="required">*</span>';
                    rateLabel.innerHTML = 'السعر/شهر (د.ج) <span class="required">*</span>';
                }
            } else {
                detailsSection.style.display = 'none';
            }
            calculateLaborCost();
        }

        function calculateLaborCost() {
            const duration = parseFloat(document.getElementById('laborDuration').value) || 0;
            const rate = parseFloat(document.getElementById('laborRate').value) || 0;
            const total = duration * rate;
            document.getElementById('laborTotal').value = total.toFixed(2);
        }

        async function saveLabor() {
            console.log('saveLabor called');
            try {
                const laborDate = document.getElementById('laborDate').value;
                const laborType = document.getElementById('laborType').value;
                const duration = parseFloat(document.getElementById('laborDuration').value);
                const rate = parseFloat(document.getElementById('laborRate').value);

                if (!laborDate || !laborType || !duration || !rate) {
                    showError('يجب ملء جميع الحقول المطلوبة');
                    return;
                }

                const workerName = document.getElementById('laborName').value || 'غير محدد';
                const total = duration * rate;

                // تخزين التفاصيل في notes
                const typeText = {
                    'hourly': 'بالساعة',
                    'daily': 'باليوم',
                    'monthly': 'بالشهر'
                }[laborType];
                
                const unitText = {
                    'hourly': 'ساعة',
                    'daily': 'يوم',
                    'monthly': 'شهر'
                }[laborType];

                let fullNotes = `اسم العامل: ${workerName}\nنوع الأجر: ${typeText}\nالمدة: ${duration} ${unitText}\nالسعر: ${rate} د.ج`;
                
                const customNotes = document.getElementById('laborNotes').value;
                if (customNotes) fullNotes += `\n${customNotes}`;

                const expenseData = {
                    user_id: currentUser.id,
                    project_id: projectId,
                    category: 'labor',
                    description: `أجور عمال - ${typeText}`,
                    amount: total,
                    expense_date: laborDate,
                    notes: fullNotes
                };

                console.log('Inserting labor:', expenseData);

                const { data, error } = await supabase
                    .from('expenses')
                    .insert([expenseData])
                    .select();

                if (error) throw error;

                console.log('Labor saved:', data);
                showSuccess('تم تسجيل مصروف العمال بنجاح');
                closeModal('addLaborModal');
                resetForm('laborDate', 'laborName', 'laborType', 'laborDuration', 'laborRate', 'laborTotal', 'laborNotes');
                document.getElementById('laborDetailsSection').style.display = 'none';
                await loadLabor();
                await loadFinancialData();

            } catch (error) {
                console.error('Error saving labor:', error);
                showError('خطأ في تسجيل المصروف: ' + error.message);
            }
        }

        async function loadFinancialData() {
            try {
                const { data: expenses, error: expError } = await supabase
                    .from('expenses')
                    .select('amount')
                    .eq('project_id', projectId);

                if (expError) throw expError;

                const totalExpenses = expenses?.reduce((sum, exp) => sum + (exp.amount || 0), 0) || 0;
                document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);

                const { data: sales, error: saleError } = await supabase
                    .from('sales')
                    .select('total_amount')
                    .eq('project_id', projectId);

                if (saleError) throw saleError;

                const totalRevenue = sales?.reduce((sum, sale) => sum + (sale.total_amount || 0), 0) || 0;
                document.getElementById('totalRevenue').textContent = formatCurrency(totalRevenue);

                const netProfit = totalRevenue - totalExpenses;
                const netProfitEl = document.getElementById('netProfit');
                netProfitEl.textContent = formatCurrency(netProfit);
                netProfitEl.style.color = netProfit >= 0 ? '#27ae60' : '#e74c3c';

                console.log('Financial data loaded - Expenses:', totalExpenses, 'Revenue:', totalRevenue);

            } catch (error) {
                console.error('Error loading financial data:', error);
            }
        }

        async function deleteRecord(table, id, type) {
            if (!confirm('هل أنت متأكد من الحذف؟')) return;

            try {
                const { error } = await supabase
                    .from(table)
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                showSuccess('تم الحذف بنجاح');

                if (type === 'stage') await loadStages();
                else if (type === 'irrigation') {
                    await loadIrrigationRecords();
                    await loadFinancialData();
                }
                else if (type === 'fertilizer') {
                    await loadFertilizerApplications();
                    await loadFinancialData();
                    await loadInventory();
                }
                else if (type === 'harvest') {
                    await loadHarvestRecords();
                    await loadFinancialData();
                }
                else if (type === 'operation') {
                    await loadOperations();
                    await loadFinancialData();
                }
                else if (type === 'labor') {
                    await loadLabor();
                    await loadFinancialData();
                }

            } catch (error) {
                console.error('Error deleting record:', error);
                showError('خطأ في الحذف: ' + error.message);
            }
        }

        function openAddStageModal() {
            document.getElementById('addStageModal').classList.add('active');
        }

        function openAddIrrigationModal() {
            document.getElementById('addIrrigationModal').classList.add('active');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('irrigationDate').value = today;
        }

        function openAddFertilizerModal() {
            document.getElementById('addFertilizerModal').classList.add('active');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('applicationDate').value = today;
        }

        function openAddHarvestModal() {
            document.getElementById('addHarvestModal').classList.add('active');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('harvestDate').value = today;
        }

        function openHarvestExpensesModal() {
            document.getElementById('harvestExpensesModal').classList.add('active');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('harvestExpDate').value = today;
        }

        function openAddOperationModal() {
            document.getElementById('addOperationModal').classList.add('active');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('operationDate').value = today;
        }

        function openAddLaborModal() {
            document.getElementById('addLaborModal').classList.add('active');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('laborDate').value = today;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function resetForm(...fieldIds) {
            fieldIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = false;
                    } else if (element.tagName === 'SELECT') {
                        element.selectedIndex = 0;
                    } else {
                        element.value = '';
                    }
                }
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-DZ');
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-DZ', {
                style: 'currency',
                currency: 'DZD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount || 0);
        }

        function showSuccess(message) {
            const alert = document.getElementById('alertSuccess');
            alert.textContent = message;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        function showError(message) {
            const alert = document.getElementById('alertError');
            alert.textContent = message;
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        function hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        function goBack() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
